id,idgrupo,nombre,consultaDatos,consultaDetalle,llaves,texto,tabla,campoVisualizacion,usarEtiquetasIni,consultaCache,consultaParteFrom,idPrincipal,campos,tipo
1,1,Expedientes,"select 1 as origen,e.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			null as fuenteopor, null as tipoopor, null as desviaciontiempo, CAST(act.id as varchar) + '-1' as idSubusus,
			(CAST(act.inumexp as varchar) + '-' + CAST(act.iyear as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
			c.codigo,cext.numero,act.inumexp as inumexp,e.codcliente as icodcli,act.dfechaact,act.iyear as iyear,
            c.snombrecli, act.id, act.tipo, 0 as privada,
            e.codsubusu as expusu, itipoexp,itipoasunto, e.codcontrario, e.anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
            e.codpropro as codabopropio, 
			convert(varchar(50), act.inumexp) + '&' +  convert(varchar(50), act.iyear) as idexp,
			e.idcentros, e.codproce,
			e.codabocon as codabocontrario, 
			e.codsubusu as codusuficha,  
			act.subusucre, excliprincipal.numreferencia AS numReferenciaCliente, ISNULL(terc.icodcli,0) as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cext.codmutua as codmutua,
			null as estadocobrado, null as inumcobro, 

			act.numfactura, act.yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(select top 1 snombrecli from [[instancia]advabousu[empresa]].dbo.clientes clp join [[instancia]advabousu[empresa]].dbo.exppacientes expp on clp.icodcli = expp.icodcli where expp.inumexp = act.inumexp and expp.iyear = act.iyear order by expp.linea) as nombrepaciente,
			juz.juzgado as juzgadoact, juz.codjuzga as codjuzgaactu, null as idTarifa, E.codclitrabajador, act.tipohistotr, act.dfecharesolucion, null AS icodcliPagador, null AS Pagador, act.idEstadoCita, ISNULL(e.enpapelera, 0) AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana
			--[camposperfil]
			--[camposperso]

			
			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segexp act

            left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
			left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
			left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on e.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
            left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
            left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
			left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
			left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
			left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.exclipro  on exclipro.icodcli=worker.icodcli and exclipro.inumexp=act.inumexp and exclipro.iyear=act.iyear
			left join [[instancia]advabousu[empresa]].dbo.exclipro exCliPrincipal on exCliPrincipal.icodcli=c.icodcli  and exCliPrincipal.inumexp=e.inumexp and exCliPrincipal.iyear=e.iyear
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.inumexp = ap.inumexpSegexp and act.iyear = ap.iyearSegexp and act.dfechaact = ap.dfechaactSegexp and act.linea = ap.lineaSegexp
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id			
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.fasesegexp fsexp on act.inumexp = fsexp.inumexp and act.iyear = fsexp.iyear and act.dfechaact = fsexp.dfechaact and act.linea = fsexp.ilinea
			left join [[instancia]advabousu[empresa]].dbo.segfase on fsexp.id_segfase = segfase.id
			left join [[instancia]advabousu[empresa]].dbo.subusu sf on segfase.icodsubusu=sf.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.clientes terc on e.codcliotro = terc.icodcli 
			left join [[instancia]advabousu[empresa]].dbo.procurad p on e.codabopro= p.icodpro
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.inumexp and eventos.iyear = act.iyear and lineaact = act.linea and eventos.origen = 1
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 1
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join (select null as icodcli, null as snombrecli) clirel on 1 = 1
			left join (select null as icodcli, null as snombrecli) cliterc on 1 = 1
			left join [[instancia]advabousu[empresa]].dbo.juzgado juz on juz.codjuzga = act.codjuzga
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipo, '') NOT IN ('--[desctipoactupredef]')) AND (ISNULL(tipohistotr, 0) <> 3) AND (ISNULL(tipo, '') NOT IN ('Control Horario')) AND (expenpapelera <> 1)
","select notas, notas2, notas3, notas4, notas5, notas6
from segexp",inumexp:INT|dfechaact:DATETIME|iyear:INT|linea:INT,EtiqExpedientesProp,,,1,,"from [[instancia]advabousu[empresa]].dbo.segexp act

            left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
			left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
            left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
            left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
			left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
			left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
			left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
			where (tipoactu <> 'plan individual' or tipoactu is null)",,tipoactu,
2,1,Clientes,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (0)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,EtiqClientesProp,0,,1,," from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in ([tabla])
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			where (tipoactu <> 'plan individual' or tipoactu is null)",,tipoactu,
3,4,Clientes,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1,C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor, oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año, isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero, C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro,
oporcli.codusuapoyo, convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas 

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (0)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id  
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble

 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Clientes,0,,0,," from [[instancia]advabousu[empresa]].dbo.oporcli  left join subusu on subusu.icodsubusu = oporcli.icodusu   
 
 inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli   and tipobd in ([tabla])
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id",,,
4,1,Clientes Potenciales,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (2)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Clientes Potenciales,2,,0,,,2,,
5,1,Trabajadores,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (1)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Trabajadores,1,,0,,,2,,
6,1,Terceros,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (3)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,EtiqTercerosProp,3,,1,,,2,,
7,1,Proveedores,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (9)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Proveedores,9,bverproveedor,0,,,2,,
8,1,Pacientes,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (4)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Pacientes,4,bverpaciente,0,,,2,,
9,1,Mutuas,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (8)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Aseguradoras,8,bvermutua,0,,,2,,
10,1,Mascotas,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (7)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,EtiqMascotasProp,7,bvermascota,1,,,2,,
11,1,Compañias,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (6)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Compañias,6,bvercompania,0,,,2,,
12,1,Alumnos,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (5)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Alumnos,5,bveralumno,0,,,2,,
13,1,Voluntarios,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (10)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Voluntarios,10,bvervoluntarios,0,,,2,,
14,4,Clientes Potenciales,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (2)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
				left join 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Clientes Potenciales,2,,0,,,3,,
17,6,Clientes,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	WHERE cuenta.stipo <> 'DESCUENTO'
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
		
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (0)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id 
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli
",,icodcli:INT|linea:INT|dfecha:DATETIME,EtiqClientesProp,0,,1,,,,,
18,6,Clientes Potenciales,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	WHERE cuenta.stipo <> 'DESCUENTO'
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (2)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli
",,icodcli:INT|linea:INT|dfecha:DATETIME,func:EtiqPotenciales|true,2,,1,,,,,
19,6,Trabajadores,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (1)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,Trabajadores,1,,0,,,,,
20,6,Terceros,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	WHERE cuenta.stipo <> 'DESCUENTO'
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (3)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,EtiqTercerosProp,3,,1,,,,,
21,6,Proveedores,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
		
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (9)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,Proveedores,9,bverproveedor,0,,,,,
22,6,Pacientes,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	WHERE cuenta.stipo <> 'DESCUENTO'
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (4)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,Pacientes,4,bverpaciente,0,,,,,
23,6,Mutuas,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (8)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,Aseguradoras,8,bvermutua,0,,,,,
24,6,Mascotas,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	WHERE cuenta.stipo <> 'DESCUENTO'
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (7)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,EtiqMascotasProp,7,bvermascota,1,,,,,
25,6,Compañias,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (6)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,Compañias,6,bvercompania,0,,,,,
26,6,Alumnos,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	WHERE cuenta.stipo <> 'DESCUENTO'
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (5)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,Alumnos,5,bveralumno,0,,,,,
27,6,Voluntarios,"SELECT DISTINCT tipoficherocli.tipofichero
	,2 AS origen
	,cuentas.icodcli
	,expe.srefabogado
	,expe.inumexp
	,c.codigo
	,expe.iyear
	,facturado
	,cuentas.dfecha
	,cuentas.linea
	,cuentas.sdescripcion
	,cuentas.fentradaseuro
	,cuentas.fsalidaseuro
	,cuentas.subusu
	,cuentas.fechaseg
	,cuentas.lineaseg
	,c.snombrecli
	,s.nombre AS nomsubusu
	,c.email
	,expe.expediente AS expediente
	,convert(varchar(50), facturas.inumfactura) + '&' +  convert(varchar(50), facturas.yearfact) + '&' +  convert(varchar(50), facturas.codsubusu) + '&' +  convert(varchar(50), isnull(facturas.serie, '')) AS idfact
	,convert(varchar(50), expe.inumexp) + '&' +  convert(varchar(50), expe.iyear) as idexp
	,clase = CASE 
		WHEN clasecuenta IS NULL AND esprevia = 1
			THEN stipo
		WHEN clasecuenta = 0
			OR clasecuenta IS NULL
			THEN '@{Oficial}'
		WHEN clasecuenta = 1
			THEN '@{Proforma}'
		WHEN clasecuenta = 2
			THEN '@{Presupuesto}'
		WHEN clasecuenta = 3
			THEN '@{Albarán}'
		WHEN clasecuenta = 4
			THEN '@{Pedido}'
		WHEN clasecuenta = 5
			THEN '@{Órden de Trabajo}'
		END
	,c.nacionalidad
	,expe.descripcion AS descexp
	,expe.codsubusu AS expusu
	,expe.itipoexp
	,cuentas.inumfactura
	,cuentas.yearfact
	,cuentas.serie
	,cuentas.referencia
	,CASE 
		WHEN cuentas.tipoprof = 0
			OR cuentas.tipoprof IS NULL
			THEN facturas.fecha
		ELSE proforma.fecha
		END AS fechafact
	,expe.estado
	,articulos.tipo AS tipoarticulo
	,articulos.id AS idarticulo
	,articulos.descripcion AS nombrearticulo
	,articulos.codigo AS codigoarticulo
	,articulos.familia
	,articulos.talla
	,articulos.preciovensi AS importeunidad
	,CASE 
		WHEN (
				facturado IS NOT NULL
				AND facturado LIKE 's'
				)
			OR (
				stipo LIKE 'cobro'
				OR stipo LIKE 'descuento'
				)
			THEN 1
		ELSE 0
		END AS cuentafacturada
	,cuentas.tipounidad
	,cuentas.unidades
	,cuentas.bhonokit
	,cuentas.facturar
	,cuentas.codsubusu AS codsubusufact
	,c.naturjuridica
	,ecp.numreferencia AS refcliente
	,C.campo1 AS campo1cli
	,C.campo2 AS campo2cli
	,expe.fcuantia
	,ISNULL(terc.icodcli, 0) AS icodclitercero
	,ISNULL(expe.codcontrario,0) AS codcontrario
	,cuentas.iyearrelacionado
	,cuentas.inumexprelacionado
	, cuentas.TodosModelos
	, cuentas.tipoOperacionIVA, cuentas.detalleOperacionIVA, cuentas.tipoExencionIVA, cuentas.motivoExencionIVA, cuentas.tipoOperacionIRPF 
	,cuentas.importe
	,descuento = ((importe*isnull(cuentas.dctolinea,0)/100) + ((importe*(1 - isnull(cuentas.dctolinea,0)/100)) * isnull(cuentas.dcto, 0)/100))
	,importeIva = baseImponible * isnull(cuentas.iva, 0)/100
	,importeIrpf = baseImponible * isnull(cuentas.irpf, 0)/100
	, cuentas.TareaAccionDescripcion
	, cuentas.EtapaTrabajo
	, cuentas.TrabajoFacturable
	,nombretabla
	,f.nombre AS familiaarticulo
	,sf.nombre AS subfamiliaarticulo
	,cuentas.icodclirelacionado
	,case when expe.inumexp is not null
	then expe.inumexp * CAST(10000 as bigint) + expe.iyear 
	else (-1)*c.icodcli end as idclave
	, MARCAFROM
FROM (
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,cuenta.inumfactura
		,cuenta.yearfact
		,cuenta.serie
		,cuenta.referencia
		,cuenta.tipoprof
		,cuenta.tipounidad
		,cuenta.unidades
		,cuenta.bhonokit
		,cuenta.facturar
		,cuenta.codsubusu AS codsubusufact
		,cuenta.stipo
		,0 as [esPrevia]
		,cuenta.facturado
		,cuenta.idartstock
		,cuenta.codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, cuenta.modelosIVA | cuenta.modelosIRPF AS TodosModelos
		, ci.descripcion AS tipoOperacionIVA, cuenta.detalleOperacionIVA, cuenta.tipoExencionIVA, cuenta.tipoOperacionIRPF 
		, CASE WHEN cuenta.tipoOperacionIVA = 11 OR cuenta.tipoExencionIVA = 1 THEN me.descripcion WHEN cuenta.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA
		,cuenta.bhonoarticulo
		,cuenta.bhonodcto
		,cuenta.bhonoproducto
		,cuenta.honogasto
		,cuenta.clasecuenta
		,cuenta.cuenrealizada
		,cuenta.isubtipo
		,cuenta.dcto
		,cuenta.dctolinea
		,cuenta.iva
		,cuenta.irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN (fentradaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN (fsalidaseuro * (1 - (ISNULL(cuenta.dctolinea, 0) / 100))) * (1 - (ISNULL(cuenta.dcto, 0) / 100))
			ELSE 0 END
		,cuenta.linexpjuzga
		, cuenta.idTareaAccion
		, T.Descripcion AS TareaAccionDescripcion
		, T.etapaTarea AS EtapaTrabajo
		, T.facturable AS TrabajoFacturable
		, cuenta.area
		,'cuencli' as nombretabla
		, null as idTipoPrevia
		,cuenta.icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.cuencli cuenta
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = cuenta.tipoOperacionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = cuenta.motivoExencionIVA
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones T on cuenta.idTareaAccion = T.id
	WHERE cuenta.stipo <> 'DESCUENTO'
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi1') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli1' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli1 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi2') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli2' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli2 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi3') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli3' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli3 cuenta
	
	UNION
	
	SELECT cuenta.icodcli
		,cuenta.dfecha
		,cuenta.linea
		,cuenta.sdescripcion
		,cuenta.fentradaseuro
		,cuenta.fsalidaseuro
		,cuenta.subusu
		,cuenta.fechaseg
		,cuenta.lineaseg
		,NULL AS inumfactura
		,NULL AS yearfact
		,NULL AS serie
		,NULL AS referencia
		,NULL AS tipoprof
		,NULL AS tipounidad
		,NULL AS unidades
		,NULL AS bhonokit
		,NULL AS facturar
		,NULL AS codsubusufact
		,(select (valor COLLATE Modern_Spanish_CI_AI) from [[instancia]advabocom].dbo.etiquetasini where seccion = 'FormExpCue' and etiqueta = 'CuePrevi4') AS stipo
		,1 as [esPrevia]
		,NULL AS facturado
		,NULL AS idartstock
		,NULL AS codsubusu
		,cuenta.inumexprelacionado
		,cuenta.iyearrelacionado
		, NULL AS TodosModelos
		, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 
		,NULL AS bhonoarticulo
		,NULL AS bhonodcto
		,NULL AS bhonoproducto
		,NULL AS honogasto
		,NULL AS clasecuenta
		,cuenta.previrealizada AS cuenrealizada
		,NULL AS isubtipo		,NULL AS dcto
		,NULL AS dctolinea
		,NULL AS iva
		,NULL AS irpf
		,importe = CASE
			WHEN (fsalidaseuro IS NULL or fsalidaseuro = 0) AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN (fentradaseuro IS NULL or fentradaseuro = 0) AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,baseImponible = CASE
			WHEN fsalidaseuro IS NULL or fsalidaseuro = 0 AND fentradaseuro <> 0
				THEN fentradaseuro
			WHEN fentradaseuro IS NULL or fentradaseuro = 0 AND fsalidaseuro <> 0
				THEN fsalidaseuro
			ELSE 0 END
		,null as linexpjuzga
		,null as idTareaAccion
		,null AS TareaAccionDescripcion
		,null AS EtapaTrabajo
		,null AS TrabajoFacturable
		,null AS area
		,'previcli4' as nombretabla
		, idTipoPrevia
		,null as icodclirelacionado
	FROM [[instancia]advabousu[empresa]].dbo.previcli4 cuenta
	) cuentas
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON cuentas.icodcli = c.icodcli
	AND tipobd IN (10)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli ON tipoficherocli.tipobd = c.tipobd
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON cuentas.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.articulos ON articulos.id = cuentas.idartstock
LEFT JOIN [[instancia]advabousu[empresa]].dbo.facturas ON facturas.yearfact = cuentas.yearfact
	AND facturas.inumfactura = cuentas.inumfactura
	AND (
		(
			cuentas.stipo <> 'COBRO'
			AND cuentas.codsubusu = facturas.codsubusu
			)
		OR (
			cuentas.stipo = 'COBRO'
			AND cuentas.subusu = facturas.codsubusu
			)
		)
	AND facturas.serie = cuentas.serie
LEFT JOIN [[instancia]advabousu[empresa]].dbo.proforma ON proforma.yearfact = cuentas.yearfact
	AND proforma.inumfactura = cuentas.inumfactura
	AND proforma.codsubusu = cuentas.codsubusu
	AND proforma.tipoprof = cuentas.tipoprof
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien expe ON cuentas.inumexprelacionado = expe.inumexp
	AND cuentas.iyearrelacionado = expe.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes terc ON terc.icodcli = expe.codcliotro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont cont ON cont.icodclicon= expe.codcontrario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.familias f ON articulos.idfamilia = f.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subfamilias sf ON articulos.idsubfamilia = sf.id
LEFT JOIN [[instancia]advabocom].dbo.tipoprevias tpp on tpp.id = cuentas.idtipoprevia
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoMovRecobros tmr on tmr.id = cuentas.idtipoprevia
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrocli on c.idcentros = centrocli.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centroexp on expe.idcentros = centroexp.id
left join (
select row_number() over (partition by inumexp, iyear, icodcli order by linea) as rn, inumexp, iyear, icodcli, numreferencia
from [[instancia]advabousu[empresa]].dbo.exclipro
) ecp on ecp.rn = 1 and ecp.inumexp = expe.inumexp and ecp.iyear = expe.iyear and ecp.icodcli = cuentas.icodcli",,icodcli:INT|linea:INT|dfecha:DATETIME,Voluntarios,10,bvervoluntarios,0,,,,,
36,11,Clientes,"select distinct tipoficherocli.tipofichero,
c.icodcli, o.id,fechavencimiento, snombrecli, c.snifcli, tipo, grupo, descripcion, realizado, fechacontrato, importe, estado, fechacontacto, 
prima, company, agente,o.formapago,duracion,o.campo1,o.campo2,o.campo3,o.campo4,o.campofecha1,o.campofecha2,c.stelefonocli as telefono1, 
c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, o.codsubusu, S.nombre as nomsubusu,
numpoliza, fechaefecto, tipopoliza, situacionpoliza, fechaanulacion, motivoanulacion, numanulacion, poliza,
c.idcentros, centrospredef.sdescripcion as nombrecentro, propietario, conductor
from [[instancia]advabousu[empresa]].dbo.clivencimientos o 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on o.icodcli=c.icodcli and tipobd in (0)
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.subusu S on o.codsubusu=S.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.clivencimientosbancos cv on cv.id_clivencimiento = o.id
left join [[instancia]advabousu[empresa]].dbo.clibancos cb on  cb.icodcli = cv.icodcli_clibancos and cb.linea = cv.linea_clibancos ","select icodcli, notas from clivencimientos ",icodcli:INT|id:INT,EtiqClientesProp,0,,1,,,,,
37,11,Clientes Potenciales,"select distinct tipoficherocli.tipofichero,
c.icodcli, o.id,fechavencimiento, snombrecli, c.snifcli, tipo, grupo, descripcion, realizado, fechacontrato, importe, estado, fechacontacto, 
prima, company, agente,o.formapago,duracion,o.campo1,o.campo2,o.campo3,o.campo4,o.campofecha1,o.campofecha2,c.stelefonocli as telefono1, 
c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, o.codsubusu, S.nombre as nomsubusu,
numpoliza, fechaefecto, tipopoliza, situacionpoliza, fechaanulacion, motivoanulacion, numanulacion, poliza,
c.idcentros, centrospredef.sdescripcion as nombrecentro,  propietario, conductor
from [[instancia]advabousu[empresa]].dbo.clivencimientos o 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on o.icodcli=c.icodcli and tipobd in (2)
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.subusu S on o.codsubusu=S.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.clivencimientosbancos cv on cv.id_clivencimiento = o.id
left join [[instancia]advabousu[empresa]].dbo.clibancos cb on  cb.icodcli = cv.icodcli_clibancos and cb.linea = cv.linea_clibancos","select icodcli, notas from clivencimientos ",icodcli:INT|id:INT,Clientes Potenciales,2,,0,,,,,
38,12,Clientes,"SELECT   distinct   c.tipofichero,
                       c.icodcli, o.id, o.fecha, o.modelo, o.obligacion, c.snombrecli, o.dni, o.realizada, case when o.realizada = 1 then 'Si' else 'No' end as strRealizado, o.presentado, o.pago, o.fechafinal, o.codigo, ISNULL(o.resultado, 0) 
                      AS resultado, o.fecharecepcion, o.fechapreparacion, o.cobrada, o.fechaautorizacion, o.campo1, o.campo2, o.fecharealizada, o.codobligacion, 
                      o.campo3, o.campo4, o.campo5, o.campo6, o.codsubusu, c.stelefonocli AS telefono1, c.telefono2, c.telefono3, c.smovilcli AS movil, c.email, s.nombre as usuario, c.CodSubUsu as CodSubUsuCli, s2.nombre as usuariocli, o.tipo,
					  o.modOblig, o.etapa, o.fechagestion
FROM         [[instancia]advabousu[empresa]].dbo.clientesobligdetalles AS o 
LEFT OUTER JOIN   [[instancia]advabousu[empresa]].dbo.clientes AS c ON o.icodcli = c.icodcli
LEFT OUTER JOIN   [[instancia]advabousu[empresa]].dbo.clientesext AS cext ON c.icodcli = cext.icodcli
left outer join [[instancia]advabousu[empresa]].dbo.subusu as s on s.icodsubusu = o.codsubusu
left outer join [[instancia]advabousu[empresa]].dbo.subusu as s2 on s2.icodsubusu = c.codsubusu",,icodcli:INT|id:INT,Clientes,,,0,,,,,
39,13,clientes,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada, f.codsubusu as fcodsubusu, vistac.expedientedes as nombreexp, vistac.expedientealum as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,vistac.expedientenum as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes as c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (0) 
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.vListadoCobrosCurso vistac on vistac.id=p.id 
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",select notas from prevcobros,id:INT,EtiqClientesProp,0,,1,,,,,
40,19,Expedientes,"Select distinct tipoficherocli.tipofichero,agenda, 1 as origen,E.expediente as Numero,segexp.inumexp as codigo,segexp.inumexp as inumexp,E.codcliente as icodcli,segexp.dfechaact as dfechaact,segexp.iyear as iYear,

            tipoexp.tipoexp,segexp.subusu,segexp.dfechaact as Fecha_Act,segexp.linea,

            segexp.sactuacion,segexp.sdescripcion2,segexp.tiempo,segexp.acturealizada,segexp.tipo,

            segexp.precio,segexp.facturado,segexp.dfechaven,segexp.dfechaavi,segexp.dfecharec,segexp.dfechase,segexp.fecharealizacion,segexp.numfactura,segexp.yearfact,C.snombrecli,C.email,segexp.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segexp.tipoactu,segexp.horainiact,segexp.horafinact,segexp.preciocoste,segexp.alertas,E.descripcion,segexp.tipohisto,e.srefabogado as refpropia,segexp.campo1,segexp.campo2,segexp.campo3,
            segexp.fase,segexp.campo4,segexp.campo5,segexp.campo6,segexp.campo7,segexp.campo8,segexp.campo9,segexp.campo10,segexp.campo11,segexp.campo12,segexp.campo13,segexp.campo14,segexp.campo15,segexp.campo16, segexp.campo17, segexp.campo18,segexp.campofecha1,segexp.campofecha2,segexp.campofecha3,
            segexp.campofecha4,segexp.campofecha5,segexp.campofecha6,segexp.campofecha7,segexp.campofecha8,segexp.campofecha9,segexp.campofecha10,segexp.campofecha11,segexp.campofecha12,segexp.dfechanotificacion, segexp.tiempoprevisto, 

            cast(null as varchar) as nacionalidad, cast(null as varchar) as sprovinciacli, E.codsubusu as expusu, itipoexp,

segexp.estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,E.expediente as NumExp,
E.idcentros, centrospredef.sdescripcion as nombrecentro , null as sobjetivo, null as ponderacion, null as porestadofin,segexp.tipoplantrabajo,null as porevolucionPIA


from [[instancia]advabousu[empresa]].dbo.segexp

            left join [[instancia]advabousu[empresa]].dbo.expedien E on segexp.inumexp=E.inumexp and segexp.iyear=E.iyear 
            left join [[instancia]advabousu[empresa]].dbo.clientes C on E.codcliente=C.icodcli 
            left join [[instancia]advabousu[empresa]].dbo.subusu S on segexp.subusu=S.icodsubusu

            left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=E.itipoexp

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on E.idcentros = centrospredef.id


where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6
from segexp",inumexp:INT|iyear:INT|linea:INT|dfechaact:DATETIME,EtiqExpedientesProp,,,0,,,,,
41,19,Clientes,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin,segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (0)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,EtiqClientesProp,0,,1,,,,,
42,19,Clientes Potenciales,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (2)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Clientes Potenciales,2,,0,,,,,
43,19,Trabajadores,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (1)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Trabajadores,1,,0,,,,,
44,19,Terceros,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin,segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (3)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,EtiqTercerosProp,3,,1,,,,,
45,19,Proveedores,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (9)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Proveedores,9,bverproveedor,0,,,,,
46,19,Pacientes,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (4)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Pacientes,4,bverpaciente,0,,,,,
47,19,Mutuas,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (8)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Aseguradora,8,bvermutua,0,,,,,
48,19,Mascotas,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (7)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,EtiqMascotasProp,7,bvermascota,1,,,,,
49,19,Compañias,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro , sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (6)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Compañias,6,bvercompania,0,,,,,
50,19,Alumnos,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro, sobjetivo, ponderacion, porestadofin, segcli.tipoplantrabajo,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (5)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Alumnos,5,bveralumno,0,,,,,
51,19,Voluntarios,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro, segcli.tipoplantrabajo,segcli.porevolucionPIA 

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (10)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Voluntarios,10,bvervoluntarios,0,,,,,
52,20,Datos,"SELECT id, dfecha, controlmutua.icodcli, 
controlmutua.snombrecli,
Case when controlmutua.inumfactura is null then ' else c.snombrecli end as nombrepaciente, 
icodmutua, snombremutua, numvolante, fimporte, facturar, facturado, inumfactura, yearfact, controlmutua.codsubusu, subusu.nombre as usuario, serie, dfechafact, cobrado, dfechacobro, dfechaact, lineaact, sactuacion, linefact, cobrar,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email 
from controlmutua
left outer join subusu on  controlmutua.codsubusu = subusu.icodsubusu
left outer join clientes c on controlmutua.icodcli=c.icodcli",,icodcli:INT|icodmutua:INT,Datos,,,0,,,,,
53,19,Tercera Edad,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro,segcli.tipoplantrabajo,segcli.porevolucionPIA 

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (12)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Tercera Edad,12,CRMONG,0,,,,,
54,19,Financiadores,"Select distinct tipoficherocli.tipofichero,

            agenda, 2 as origen,segcli.icodcli as Numero,Null as codigo,null as inumexp,segcli.icodcli as icodcli,segcli.dfechaact as dfechaact,null as iYear,Cast(null as varchar) as tipoexp,segcli.subusu,segcli.dfechaact as Fecha_Act,segcli.linea,

            segcli.sactuacion,segcli.sdescripcion2,segcli.tiempo,segcli.acturealizada,segcli.tipo,

            segcli.precio,segcli.facturado,segcli.dfechaven,segcli.dfechaavi,segcli.dfecharec,segcli.dfechase,segcli.fecharealizacion,segcli.numfactura,segcli.yearfact,C.snombrecli,C.email,segcli.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            S.nombre as nomsubusu,segcli.tipoactu,segcli.horainiact,segcli.horafinact,segcli.preciocoste,segcli.alertas,cast(null as varchar) as descripcion,segcli.tipohisto,cast(null as varchar) as refpropia,segcli.campo1,segcli.campo2,segcli.campo3, segcli.fase,segcli.campo4,segcli.campo5,segcli.campo6,segcli.campo7,segcli.campo8,segcli.campo9,segcli.campo10,segcli.campo11,segcli.campo12,segcli.campo13,segcli.campo14,segcli.campo15,segcli.campo16,segcli.campo17,segcli.campo18,segcli.campofecha1,segcli.campofecha2,segcli.campofecha3, segcli.campofecha4,segcli.campofecha5,segcli.campofecha6,segcli.campofecha7,segcli.campofecha8,segcli.campofecha9,segcli.campofecha10,segcli.campofecha11,segcli.campofecha12,segcli.dfechanotificacion, 

            segcli.tiempoprevisto as tiempoprevisto, C.nacionalidad, C.sprovinciacli , NULL as expusu, NULL as itipoexp,

estado, estado2, estado3, estado4, estado5, estado6, estado7, estado8, estado9, estado10, estado11, estado12,null as NumExp,
C.idcentros, centrospredef.sdescripcion as nombrecentro, segcli.tipoplantrabajo ,segcli.porevolucionPIA

from [[instancia]advabousu[empresa]].dbo.segcli 

            inner join [[instancia]advabousu[empresa]].dbo.clientes C on segcli.icodcli=C.icodcli  and tipobd in (11)

			left join [[instancia]advabousu[empresa]].dbo.subusu S on segcli.subusu=S.icodsubusu

left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id

where (tipoactu like 'Plan Individual')",,icodcli:INT|linea:INT|dfechaact:DATETIME,Financiadores,11,CRMONG,0,,,,,
106,13,pacientes,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada, f.codsubusu as fcodsubusu , e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes , p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes as c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (4)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Pacientes,4,bverpaciente,0,,,,,
107,13,mutuas,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada , f.codsubusu as fcodsubusu, e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as anyo,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes , p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro,
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes as c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (8)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Aseguradoras,8,bvermutua,0,,,,,
108,13,mascotas,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada , f.codsubusu as fcodsubusu, e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro,
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes as c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (7)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
109,13,Compañias,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada , f.codsubusu as fcodsubusu, e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes , p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro,
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes as c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (6)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Compañias,6,bvercompania,0,,,,,
110,13,alumnos,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88 , f.fracobrada, f.codsubusu as fcodsubusu, vistac.expedientedes as nombreexp, vistac.expedientealum as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,vistac.expedientenum as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (5)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.vListadoCobrosCurso vistac on vistac.id=p.id 
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Alumnos,5,bveralumno,0,,,,,
111,13,voluntarios,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada , f.codsubusu as fcodsubusu, e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (10)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Voluntarios,10,bvervoluntarios,0,,,,,
112,13,expedientes,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,

case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,

l.fecha as fecharemesa, p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,

subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email , 
p.idcentros, centrospredef.sdescripcion as nombrecentro
, c.starjetasocio , c.perso88 , f.fracobrada, f.codsubusu as fcodsubusu, e.descripcion as nombreexp, vistac.expedientealum as nombrealum , 'Expediente' as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
e.campo28 as expcampo28, e.campo29 as expcampo29, e.campo34 as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro,
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
left join [[instancia]advabousu[empresa]].dbo.expedien e on p.inumexprelacionado=e.inumexp and p.iyearrelacionado = e.iyear
left join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli
left join [[instancia]advabousu[empresa]].dbo.vlistadocobroscurso vistac on vistac.id=p.id 
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu

--[leftjoinperfil]
--[leftjoinperso]

where not inumexprelacionado is null and iyearrelacionado != -1 and (cobroodontograma is null or cobroodontograma = 0)",,id:INT,EtiqExpedientesProp,,,1,,,,,
113,13,clientes potenciales,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
caja.caja,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada , f.codsubusu as fcodsubusu, e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes , p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (2)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Clientes Potenciales,2,,0,,,,,
114,13,Financiadores,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88 , f.fracobrada, f.codsubusu as fcodsubusu, e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (11)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Financiadores,11,bVerFinancieras,0,,,,,
115,13,tercera edad,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88 , f.fracobrada, f.codsubusu as fcodsubusu, e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (12)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Tercera edad,12,bverterceraedad,0,,,,,
116,1,Financiadores,"select 2 as origen,c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
			o.fuente as fuenteopor, o.tipo as tipoopor, (cast(isnull(r.sumtiempotr, 0) as float)-(cast(o.tiempoprev as float)*(cast(o.porprogreso as float)/100))) as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
			act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
			act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
			act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo, act.acturealizada,
            c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
            c.snombrecli, act.id, act.tipo, act.privada,
            null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
			null as codabopropio, null as idexp ,
			c.idcentros, null as codproce,
			null as codabocontrario,   
			c.codsubusu as codusuficha,  
			act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
			,costetrabajador.sdescripcion as descriptarifa, cliext.codmutua as codmutua,
			pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
			
			ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
			(case when c.tipobd in (4) then c.snombrecli else null end) as nombrepaciente,
			null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

			--[camposperfil]
			--[camposperso]

			, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd in (11)
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
			left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			left join 
			(
				select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
				row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
				from [[instancia]advabousu[empresa]].dbo.clientes cli
				left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
				where tipobd = 1
			) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
			left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
			left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
			left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
			left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
			left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
			left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

			left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
			left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
			left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
			left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
			left join 
			(
				select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
				ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
				from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
				left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
			) clirel on clirel.icodpaciente = act.icodcli and rn = 1
			left join 
			(
				select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
				ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
				from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
				left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
			) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
			--[leftjoinperfil]
			--[leftjoinperso]
			

			where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3)  AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6
	from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Financiadores,11,bVerFinancieras,0,,,2,,
131,4,Terceros,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1,C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero, C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (3)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1) 
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
from oporcli",icodcli:INT|linea:INT|icodopor:INT|dfecha:DATETIME,EtiqTercerosProp,3,,1,,,3,,
148,24,Pacientes,"select CodCli as icodcli, clipers3.linea, clipers3.Perso1, clipers3.Perso2, clipers3.Perso3, clipers3.Perso4, clipers3.Perso5, 
clipers3.Perso6, clipers3.Perso7, clipers3.Perso8, clipers3.Perso9, clipers3.Perso10, 
clipers3.Perso11, clipers3.Perso12, clipers3.Perso13, clipers3.Perso14, clipers3.Perso15, 
clipers3.Perso16, clipers3.Perso17, clipers3.Perso18, clipers3.Perso19, clipers3.Perso20, clipers3.Perso21, clipers3.Perso22, clipers3.Perso23, clipers3.Perso24,  
clipers3.PersoFecha1, clipers3.PersoFecha2, clipers3.PersoFecha3, 
clipers3.PersoNum1, clipers3.PersoNum2, clipers3.PersoNum3, clipers3.PersoNum4, clipers3.PersoNum5,
clipers3.PersoLogic1, clipers3.PersoLogic2, clipers3.PersoLogic3, clipers3.PersoLogic4, clipers3.PersoLogic5, 
clipers3.PersoLogic6, clipers3.PersoLogic7,
clientes.snombrecli,  clientes.stelefonocli, clientes.telefono2, clientes.telefono3,  
clientes.smovilcli, clientes.email,clientes.nacionalidad, clientes.snifcli,
clientes.idcentros, centrospredef.sdescripcion as nombrecentro,
case when clipers3.perso5 is not null and clipers3.perso5 <> ''  and clipers3.perso5 <> '0' 
  then 'D' 
  else '' 
  end
  +
  case when clipers3.perso9 is not null and clipers3.perso9 <> ''  and clipers3.perso9 <> '0' 
  then 'C' 
  else '' 
  end
  +
  case when clipers3.perso6 is not null and clipers3.perso6 <> ''  and clipers3.perso6 <> '0' 
  then 'M' 
  else '' 
  end
  +
  case when clipers3.perso10 is not null and clipers3.perso10 <> ''  and clipers3.perso10 <> '0' 
  then 'E' 
  else '' 
  end
  +
  case when clipers3.perso7 is not null and clipers3.perso7 <> ''  and clipers3.perso7 <> '0' 
  then 'N' 
  else '' 
  end
  as horario 
from [[instancia]advabousu[empresa]].dbo.clipers3
inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = clipers3.CodCli 
left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id
and tipobd in (4)","select icodcli, notas
from
(select CodCli as icodcli, linea, notas from clipers3) T",icodcli:INT|linea:INT,Pacientes,4,bverpaciente,0,,,,,
151,24,Clientes,"select CodCli as icodcli, clipers3.linea, clipers3.Perso1, clipers3.Perso2, clipers3.Perso3, clipers3.Perso4, clipers3.Perso5, 
clipers3.Perso6, clipers3.Perso7, clipers3.Perso8, clipers3.Perso9, clipers3.Perso10, 
clipers3.Perso11, clipers3.Perso12, clipers3.Perso13, clipers3.Perso14, clipers3.Perso15, 
clipers3.Perso16, clipers3.Perso17, clipers3.Perso18, clipers3.Perso19, clipers3.Perso20, clipers3.Perso21, clipers3.Perso22, clipers3.Perso23, clipers3.Perso24, 
clipers3.PersoFecha1, clipers3.PersoFecha2, clipers3.PersoFecha3, 
clipers3.PersoNum1, clipers3.PersoNum2, clipers3.PersoNum3, clipers3.PersoNum4, clipers3.PersoNum5,
clipers3.PersoLogic1, clipers3.PersoLogic2, clipers3.PersoLogic3, clipers3.PersoLogic4, clipers3.PersoLogic5, 
clipers3.PersoLogic6, clipers3.PersoLogic7,
clientes.snombrecli,  clientes.stelefonocli, clientes.telefono2, clientes.telefono3,  
clientes.smovilcli, clientes.email,clientes.nacionalidad, clientes.snifcli,
clientes.idcentros, centrospredef.sdescripcion as nombrecentro,
case when clipers3.perso5 is not null and clipers3.perso5 <> ''  and clipers3.perso5 <> '0' 
  then 'D' 
  else '' 
  end
  +
  case when clipers3.perso9 is not null and clipers3.perso9 <> ''  and clipers3.perso9 <> '0' 
  then 'C' 
  else '' 
  end
  +
  case when clipers3.perso6 is not null and clipers3.perso6 <> ''  and clipers3.perso6 <> '0' 
  then 'M' 
  else '' 
  end
  +
  case when clipers3.perso10 is not null and clipers3.perso10 <> ''  and clipers3.perso10 <> '0' 
  then 'E' 
  else '' 
  end
  +
  case when clipers3.perso7 is not null and clipers3.perso7 <> ''  and clipers3.perso7 <> '0' 
  then 'N' 
  else '' 
  end
  as horario  
from [[instancia]advabousu[empresa]].dbo.clipers3
inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = clipers3.CodCli 
left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id
and tipobd in (0)","select icodcli, notas
from
(select CodCli as icodcli, linea, notas from clipers3) T",icodcli:INT|linea:INT,EtiqClientesProp,0,,1,,,,,
152,24,Alumnos,"select CodCli as icodcli, clipers3.linea, clipers3.Perso1, clipers3.Perso2, clipers3.Perso3, clipers3.Perso4, clipers3.Perso5, 
clipers3.Perso6, clipers3.Perso7, clipers3.Perso8, clipers3.Perso9, clipers3.Perso10, 
clipers3.Perso11, clipers3.Perso12, clipers3.Perso13, clipers3.Perso14, clipers3.Perso15, 
clipers3.Perso16, clipers3.Perso17, clipers3.Perso18, clipers3.Perso19, clipers3.Perso20, clipers3.Perso21, clipers3.Perso22, clipers3.Perso23, clipers3.Perso24,  
clipers3.PersoFecha1, clipers3.PersoFecha2, clipers3.PersoFecha3, 
clipers3.PersoNum1, clipers3.PersoNum2, clipers3.PersoNum3, clipers3.PersoNum4, clipers3.PersoNum5,
clipers3.PersoLogic1, clipers3.PersoLogic2, clipers3.PersoLogic3, clipers3.PersoLogic4, clipers3.PersoLogic5, 
clipers3.PersoLogic6, clipers3.PersoLogic7,
clientes.snombrecli,  clientes.stelefonocli, clientes.telefono2, clientes.telefono3,  
clientes.smovilcli, clientes.email,clientes.nacionalidad, clientes.snifcli,
clientes.idcentros, centrospredef.sdescripcion as nombrecentro,
case when clipers3.perso5 is not null and clipers3.perso5 <> ''  and clipers3.perso5 <> '0' 
  then 'D' 
  else '' 
  end
  +
  case when clipers3.perso9 is not null and clipers3.perso9 <> ''  and clipers3.perso9 <> '0' 
  then 'C' 
  else '' 
  end
  +
  case when clipers3.perso6 is not null and clipers3.perso6 <> ''  and clipers3.perso6 <> '0' 
  then 'M' 
  else '' 
  end
  +
  case when clipers3.perso10 is not null and clipers3.perso10 <> ''  and clipers3.perso10 <> '0' 
  then 'E' 
  else '' 
  end
  +
  case when clipers3.perso7 is not null and clipers3.perso7 <> ''  and clipers3.perso7 <> '0' 
  then 'N' 
  else '' 
  end
  as horario 
from [[instancia]advabousu[empresa]].dbo.clipers3
inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = clipers3.CodCli 
left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id
and tipobd in (5)","select icodcli, notas
from
(select CodCli as icodcli, linea, notas from clipers3) T",icodcli:INT|linea:INT,Alumnos,5,bveralumno,0,,,,,
226,13,anticipos odontograma,"select *, MARCAFROM from
(select odontentrada.fecha as fechagasing, odontentrada.fecha, c.snombrecli as cliente, c.icodcli,
odontentrada.formacobro as formapago1, null as srefabogado, odontentrada.formacobro as formapago,
odontentrada.importe as total, odontentrada.descripcion as concepto, 1 as cobrado, 1 as realizada, 1 as cobrar, odontentrada.fecha as fecharealizada, null as serie,
null as inumfact, null as yearfact,null as asientocobro, null as ctaacrcli,
null as ctacajban, null as ctagasing, 1 as tipo, null as baseimp, null as iva, null as irpf, odontentrada.codusu as codsubusu, null as factura,
null as notas, null as yearcontacobro, null as subusufact, null as id, null as impagado, null as fechaimpagado, null as lineacobro,
null as ctacobrado, null as lineaimpagado, null as ctaimpagado, null as asientoimpagado, null as yearcontaimpagado, null as tipoprof,
null as origen, null as iyear, null as inumexp, null as bproformarel, null as inumproformarel, null as yearproformarel,
null as codsubusuproformarel, null as tipoproformarel, null as facturar, null as ctaiva, null as ctairpf,
null  as diariocobro, null diarioimpagado,
null as tipofactura, null as fecharemesa, null as tipoimpago, null as tipoimpago1, null as importeimpagado,
0 as estaremesado, null as  banco, null as  fechafact,
null as tip1, null as tip2, null as tip3, c.fechaalta as fechaaltacliente, subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro , c.starjetasocio , c.perso88, 0 as fracobrada , 0 as fcodsubusu, null as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
null as cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, null as inumcobro, null as numeroexprelac, null as iyearrelac,
null as codclitrabajador, null as nombretrab,
null as alcobro, null as impdef, c.tipofichero as tipoficheroclientes, null as inumexprelacionado, null as iyearrelacionado, null as inumexpediente, null as iyearexpediente, null as idexp,
null as itipoexp, case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha


--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.odontentrada
inner join [[instancia]advabousu[empresa]].dbo.odontograma on odontograma.id = odontentrada.idodontograma
inner join [[instancia]advabousu[empresa]].dbo.clientes c on odontograma.idpaciente = c.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = odontentrada.codusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperfil]
--[leftjoinperso]

) p
where (1=1)",,id:INT,Anticipos Odontograma,,desactivado,0,,,,,
227,13,cobros parciales odontograma,"select *, MARCAFROM  from
(select segodontentrada.fecha as fechagasing, segodontentrada.fecha, c.snombrecli as cliente, c.icodcli,
segodontentrada.formacobro as formapago1, null as srefabogado, segodontentrada.formacobro as formapago,
segodontentrada.importe as total, segodont.descripcion as concepto, 1 as cobrado, 1 as realizada, 1 as cobrar, segodontentrada.fecha as fecharealizada, prev.serie as serie,
prev.inumfactura as inumfact, prev.yearfact as yearfact,null as asientocobro, null as ctaacrcli,
null as ctacajban, null as ctagasing, 1 as tipo, null as baseimp, null as iva, null as irpf, segodontentrada.codusu as codsubusu, null as factura,
null as notas, null as yearcontacobro, null as subusufact, null as id, null as impagado, null as fechaimpagado, null as lineacobro,
null as ctacobrado, null as lineaimpagado, null as ctaimpagado, null as asientoimpagado, null as yearcontaimpagado, null as tipoprof,
null as origen, null as iyear, null as inumexp, null as bproformarel, null as inumproformarel, null as yearproformarel,
null as codsubusuproformarel, null as tipoproformarel, null as facturar, null as ctaiva, null as ctairpf,
null  as diariocobro, null diarioimpagado,
case prev.factura 
when 1 then 'oficial' 
when 2 then (case prev.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura, null as fecharemesa, null as tipoimpago, null as tipoimpago1, null as importeimpagado,
0 as estaremesado, null as  banco, (case prev.factura when 1 then fact.fecha when 2 then prof.fecha end) as fechafact,
null as tip1, null as tip2, null as tip3, c.fechaalta as fechaaltacliente, subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro , c.starjetasocio , c.perso88, 0 as fracobrada , 0 as fcodsubusu, null as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
null as cobroodontograma, identrada,
null as expcampo28, null as expcampo29, null as expcampo34,null as inumcobro, null as numeroexprelac, null as iyearrelac,
null as codclitrabajador, null as nombretrab,
null as alcobro, null as impdef, c.tipofichero as tipoficheroclientes, null as inumexprelacionado, null as iyearrelacionado, null as inumexpediente, null as iyearexpediente, null as idexp,
null as itipoexp, case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segodontentrada 
inner join [[instancia]advabousu[empresa]].dbo.segodont on segodont.id = segodontentrada.idsegodont
inner join [[instancia]advabousu[empresa]].dbo.odontograma on odontograma.id = segodont.idodontograma
inner join [[instancia]advabousu[empresa]].dbo.clientes c on odontograma.idpaciente = c.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = segodontentrada.codusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.prevcobros prev on prev.id = segodontentrada.idprevcobro
left join [[instancia]advabousu[empresa]].dbo.facturas fact on prev.inumfactura=fact.inumfactura and prev.yearfact=fact.yearfact
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prev.inumfactura=prof.inumfactura and prev.yearfact=prof.yearfact
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id
[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu

--[leftjoinperfil]
--[leftjoinperso]

)
 p

where identrada is null",,id:INT,Cobros Parciales Odontograma,,desactivado,0,,,,,
228,34,Clientes,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum, 
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos 
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (0)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:int|icodcli:int,EtiqClientesProp,0,,1,,,,,
229,34,Expedientes,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
e.campo28 as expcampo28, e.campo29 as expcampo29, e.campo34 as expcampo34, p.inumcobro, vistac.expedientenum as numeroexprelac, e.anyo as iyearrelac, vistac.expedientedes as nombreexp, alum.snombrecli as nombrealum, 
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos 
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
left join [[instancia]advabousu[empresa]].dbo.expedien e on p.inumexp=e.inumexp and p.iyear = e.iyear
left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente = c.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.vListadoCobrosCurso vistac on vistac.id=p.id 
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where origen='exp' and (cobroodontograma is null or cobroodontograma = 0)",,,EtiqExpedientesProp,,,1,,,,,
230,36,Residentes,"SELECT C1.id,C1.numcama,C1.habilitada,C1.tipo as tipocama, C1.armario,
H.numhabitacion,H.numplanta,H.tipohabitacion,H.notas,
C2.icodcli, C2.snombrecli, C2.sexo
FROM [[instancia]advabousu[empresa]].dbo.camas C1
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes C2
ON C1.id = C2.idcama AND C2.tipobd = 0 AND C2.fechaBaja IS NULL
LEFT JOIN [[instancia]advabousu[empresa]].dbo.habitaciones H
ON C1.id_habitacion = H.id",,id:INT|icodcli:INT,func:EtiqClientes,0,,1,,,,,
231,37,Clientes,"select 

datediff(second, fechaestado1, getdate())  as edadAbierta,
datediff(second, CAST(CAST(fechaActuacion AS DATE) AS DATETIME) +
    CAST(horaActuacion AS TIME)
, getdate())  as edadModificada

,T.*, usu2.nombre AS nombreUsuAgenda

 from
(SELECT eliminado, p.[id], p.[icodcli] ,p.[dfecha] ,p.[icodusu] ,p.[icodpro] ,p.[icodcon] ,p.[estado],
       p.[etapa] ,p.[tipo] ,p.[codigo] ,p.[fuente] ,p.[unidades] ,p.[precioticket] ,p.[probabilidad] ,p.[prevision],
       p.[notas] ,p.[fechaestado] ,p.[importefinal] ,p.[oferta] ,p.[referencia] ,p.[descripcion] ,p.[notas1], 
       p.[notas2] ,p.[notas3] ,p.[notas4] ,p.[notas5] ,p.[notas6] ,p.[CampoNum1] ,p.[CampoNum2] ,p.[CampoNum3], 
       p.[CampoNum4] ,p.[CampoNum5] ,p.[Campo1] ,p.[Campo2] ,p.[Campo3] ,p.[Campo4] ,p.[Campo5] ,p.[Campo6], 
       p.[Campo7] ,p.[Campo8] ,p.[Campo9] ,p.[Campo10] ,p.[Campo11] ,p.[Campo12] ,p.[Campo13] ,p.[Campo14] ,p.[Campo15], 
       p.[Campo16] ,p.[Campo17] ,p.[Campo18] ,p.[Campo19] ,p.[Campo20] ,p.[Campo21] ,p.[Campo22] ,
       p.[CampoFecha1] ,p.[CampoFecha2], 
       p.[CampoFecha3] ,p.[CampoFecha4] ,p.[CampoFecha5] ,p.[CampoFecha6] ,p.[CampoFecha7] ,p.[CampoFecha8], 
       [traspasado], [hora], subusu.nombre AS usuario, c.snombrecli as nombrecli,  c.stelefonocli as clitfo1,c.telefono2 as clitfo2,
	   c.telefono3 as clitfo3,  c.smovilcli as climvl,c.email as climail, c.origen as cliorigen, c.perso88 as clicolectivo,
	   c.fechanacimiento as clifechaalta,  
	   contacto.codcontacto, contacto.nombre as nombrecontacto, 
	   (select top(1) est.fecha from proyectoestados est where p.id = est.idproyecto and est.estado like 'Abierto' order by est.fecha desc) as fechaestado1,
	   (select top(1) est.fecha from proyectoestados est where p.id = est.idproyecto and est.estado like 'Asignado' order by est.fecha desc) as fechaestado2,
	   (select top(1) est.fecha from proyectoestados est where p.id = est.idproyecto and est.estado like 'En Curso' order by est.fecha desc) as fechaestado3,
	   (select top(1) est.fecha from proyectoestados est where p.id = est.idproyecto and est.estado like 'Resuelto' order by est.fecha desc) as fechaestado4,
	   (select top(1) est.fecha from proyectoestados est where p.id = est.idproyecto and est.estado like 'Valorado' order by est.fecha desc) as fechaestado5,
       grupousuario, canal, prioridad, puntuacion, 
       case when prioridad like 'Urgente' then 1 else 0 end as prioritario,
       (select top(1) horainiact from segcli where segcli.icodcli = p.icodcli and p.id = segcli.idproyecto  order by dfechaact desc, horainiact desc) as fechaInicioAgenda,
       (select top(1) horafinact from segcli where segcli.icodcli = p.icodcli and p.id = segcli.idproyecto  order by dfechaact desc, horainiact desc) as fechaFinalAgenda,
       (select top(1) dfechaact from segcli where segcli.icodcli = p.icodcli and p.id = segcli.idproyecto order by dfechaact desc) as fechaAgenda,
       
       (select top(1) dfechanotificacion from segcli where segcli.icodcli = p.icodcli and p.id = segcli.idproyecto order by dfechanotificacion desc) as fechaActuacion,
       (select top(1) horafin from segcli where segcli.icodcli = p.icodcli and p.id = segcli.idproyecto order by dfechanotificacion desc) as horaActuacion,
       
       p.idcategoria, cat.descripcion as categoria,
       (select count(*) from segcli where segcli.icodcli = p.icodcli and p.id = segcli.idproyecto and (segcli.automatica is null or segcli.automatica = 0 )) as numactus,
	   (select top(1) subusu from segcli where segcli.icodcli = p.icodcli and p.id = segcli.idproyecto order by dfechaact desc) as usuarioAgenda
       FROM [proyecto] p 
       LEFT JOIN subusu ON p.icodusu = subusu.icodsubusu
       LEFT JOIN contacto ON p.icodcon = contacto.codcontacto
       LEFT JOIN proyectocategoria cat ON p.idcategoria = cat.id
	   inner join clientes c on c.icodcli = p.icodcli) T
	   
	   LEFT JOIN subusu usu2 ON usuarioAgenda = usu2.icodsubusu

WHERE (eliminado = 0 or eliminado is null) ",,icodcli:INT|id:INT,,,,0,,,231,,
232,38,Tratamientos,"SELECT segodont.id, segodont.tipoHistorial, 
clientes.icodcli, segcli.dfechaact, segcli.linea,
clientes.snombrecli , clientes.snifcli, clientes.sdomiciliocli, round(segodont.importebase * (1 - isnull(segodont.dctoGeneralPresupuesto/100,0)),2) as importeBase, segodont.tipoodontograma, segodont.color as backcolor,
segodont.descuento,
Facturas.formapago, Facturas.reffactu, segodont.codgrafico,
case when segcli.icodcli is null then segodont.fechaAlta else segcli.dfechaact end as fechaAlta, 
case when segcli.icodcli is null then segodont.horaInicio else segcli.horainiact end as horaInicio,
case when segcli.icodcli is null then segodont.horaFinal else segcli.horafinact end as horaFinal,
case when segcli.icodcli is null then segodont.importe else segcli.precio end as importe,
case when segcli.icodcli is null then segodont.descripcion else segcli.sactuacion end as descripcion,
case when segcli.icodcli is null then segodont.realizado else Convert(bit, isnull(segcli.acturealizada, 0)) end as realizado, 
case when segcli.icodcli is null then segodont.codusu else segcli.subusu end as icodsubusu,
case when segcli.icodcli is null then segodont.tiempo else segcli.tiempo end as tiempo,
case when segcli.icodcli is null then segodont.fechaRealizado else segcli.fecharealizacion end as fechaRealizacion,
CASE WHEN subusu.nombre is null THEN '' ELSE subusu.nombre END as usuario,
case when isnull(vct.totalcobrado,-1) >= 0 or isnull(vct.totalfacturado,-1) >= 0 or isnull(vct.totalcobradomutua,-1) >= 0 or isnull(vct.totalcobradocobrosfacturados,-1) >= 0 then 1
when coalesce(vct.totalcobrado,0)+coalesce(vct.totalfacturado,0)+coalesce(vct.totalcobradomutua,0)+coalesce(vct.totalcobradocobrosfacturados ,0) = 
nullif(case when segcli.icodcli is null then segodont.importe else segcli.precio  end,0)  then 1
else 0 end as tratamientocobrado,
CASE WHEN (presunum IS NOT null AND presuyear IS NOT null AND presucodusu IS NOT null) THEN '@{Tratamiento Presupuestado}' ELSE '@{Tratamiento}' END AS [origen_tratamiento], 
CASE WHEN (segodont.presunum IS NOT null AND segodont.idActuPresupuesto IS NOT null) THEN 1 ELSE 0 END AS [presupuesto_aceptado], 
case when segodont.info is null or segodont.info like '' then case when segodont.diente > 0 then convert(varchar, segodont.diente) else null end else 
                             case when segodont.diente is not null and segodont.diente > 0 then convert(varchar, segodont.diente) +',' else '' end  + replace(segodont.info, '|', ',') end as diente, 
segodont.cara, 
ISNULL(segcli.SaldoTratamiento, 0) AS SaldoTratamiento, 
segcli.acturealizada, clientes.idcentros, segodont.codusuauxiliar, segodont.estado as estadoSegodont, segodont.idtarifa, tarifasodontograma.sdescripcion as tarifa, 
segodont.consentimiento, segodont.colorManual, odontograma.idPaciente, isnull(especialidades.valor, (upper('o')+'dontología')) as tipoespecialidad, especialidades.id as idTipoEspecialidad,
 case when odontograma.yearpresu is null then 0 else 1 end as esPresupuesto, odontograma.esplantilla,
isnull(segcli.facturable,0) as ecobrofacturable,isnull(segodont.importe,0) * (1 - (ISNULL(segodont.dctoGeneralPresupuesto, 0) / 100)) as ecobroimporte,
isnull(vct.totalcobrado,0) as ecobrocobrado, isnull(vct.totalfacturado,0) as ecobrofacturado, isnull(vct.totalcobradomutua,0) as ecobrocobradomutua,
isnull(vct.totalcobrado,-1) as ecobroescobrado, isnull(vct.totalfacturado,-1) as ecobroesfacturado, isnull(vct.totalcobradomutua,-1) as ecobroescobradomutua,
isnull(vct.totalcobradocobrosfacturados,0) as ecobrocobradocobrosfacturados, isnull(vct.totalcobradocobrosfacturados,-1) as ecobroescobrofacturado
--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segodont
left join [[instancia]advabousu[empresa]].dbo.odontograma on segodont.idodontograma=odontograma.id 
left join [[instancia]advabousu[empresa]].dbo.clientes clientes on odontograma.idpaciente=clientes.icodcli
left join (select prevcobros.id as id,prevcobros.fecha as fecha, prevcobros.serie,prevcobros.yearfact as yearfact,prevcobros.codsubusu as codsubusu,prevcobros.inumfactura as inumfactura,tratamientoscobros.idsegodont,prevcobros.cobrado 
from [[instancia]advabousu[empresa]].dbo.tratamientoscobros left join [[instancia]advabousu[empresa]].dbo.lineprevcobros on tratamientoscobros.idlineprevcobro = lineprevcobros.id
left join [[instancia]advabousu[empresa]].dbo.prevcobros on lineprevcobros.idprevcobros=prevcobros.id where lineprevcobros.id in (select max(lineprevcobros.id) as id
from [[instancia]advabousu[empresa]].dbo.tratamientoscobros left join [[instancia]advabousu[empresa]].dbo.lineprevcobros on tratamientoscobros.idlineprevcobro = lineprevcobros.id
left join [[instancia]advabousu[empresa]].dbo.prevcobros on lineprevcobros.idprevcobros=prevcobros.id
group by tratamientoscobros.idsegodont)) as tratcobros on segodont.id = tratcobros.idsegodont  
left join [[instancia]advabousu[empresa]].dbo.subusu on segodont.codusu=subusu.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.segcli on segodont.icodcli=segcli.icodcli and segodont.dfechaact=segcli.dfechaact and segodont.linea=segcli.linea
left join [[instancia]advabousu[empresa]].dbo.vcobradotratamiento vct on vct.idodontograma = segodont.idodontograma and vct.idsegodont = segodont.id
left join [[instancia]advabousu[empresa]].dbo.facturas on facturas.inumfactura=tratcobros.inumfactura and facturas.yearfact=tratcobros.yearfact
and facturas.serie=tratcobros.serie and facturas.codsubusu=tratcobros.codsubusu 
left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = segodont.idcomision
left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = segodont.idTipoComision
left join [[instancia]advabousu[empresa]].dbo.comision comisionAux on comisionAux.id = segodont.idcomisionaux
left join [[instancia]advabousu[empresa]].dbo.centrospredef CP on clientes.idcentros = CP.id
left join [[instancia]advabousu[empresa]].dbo.combovalores especialidades on odontograma.tipoEspecialidad = especialidades.id
LEFT OUTER JOIN tarifasodontograma ON  segodont.idtarifa = tarifasodontograma.id 
--[leftjoinperfil]
--[leftjoinperso] 
WHERE tipoHistorial <> 1 AND ISNULL(esplantilla, 0) != 1",select notas from segodont,id:INT|icodcli:INT,,,,0,,,232,,
233,39,Peticion,"select p.id,p.icodcli,p.dfecha,p.sdescripcion,p.unidades,p.fpreciounitario,p.dctolinea,
p.importe,p.notas,p.ctaservart,p.ctaiva,p.porrecargo,p.poriva,p.ctairpf,p.porirpf,p.codsubusu,
p.realizada,p.fecharealizada,p.facturar,p.facturado,p.inumfactura,p.yearfact,p.subusufact,
p.serie,p.icodmedicoE,p.icodmutuaE,p.icodpacienteE,p.idtipofact,p.snombreE,
p.snombreR,
p.snumauto,p.formapago,p.iforfait,p.iguardia,p.ipdtemutua,p.iempresas,p.icodmedicoR,
p.icodmutuaR,p.icodpacienteR,c.snombrecli as paciente,subusu.nombre as nomsubusu,
tipofactpet.sdescripcion as stipofactura,c.snifcli,c.sdomiciliocli,tipofactpet.itipoR,tipofactpet.ifrecibida,
p.idgasto,
p.idgastotit,p.serietit,p.inumfacturatit,gasto.numfactura as numgasto,gastotit.numfactura as numgastotit,
p.iayudante,titular.snombrecli as titular,
p.icodtitular
from advAboUsu[empresa].dbo.peticioncli p
left join advAboUsu[empresa].dbo.clientes c on c.icodcli=p.icodcli
left join advAboUsu[empresa].dbo.subusu on subusu.icodsubusu=p.codsubusu
left join advAboUsu[empresa].dbo.tipofactpet on tipofactpet.id=p.idtipofact
left join advAboUsu[empresa].dbo.contagastos gasto on gasto.id=p.idgasto
left join  advAboUsu[empresa].dbo.contagastos gastotit on gastotit.id=p.idgastotit
left join  advAboUsu[empresa].dbo.clientes titular on titular.icodcli=p.icodtitular
",select notas from peticioncli,id:INT|icodcli:INT,,,,0,,,233,,
234,40,Gastos,"select l.fecha as dfecha,l.concepto,l.unidades,l.preciounitario,l.baseimponible as importe,
l.idpeticion,l.icodproveedor,l.icodemisor,l.id,l.icodtrabajador,
prov.snombrecli as proveedor, recep.snombrecli as snombreR,mutua.snombrecli as mutua,
trab.snombrecli as snombreE,p.idtipofact,p.icodcli as icodcli,
l.facturar,p.codsubusu as codsubusu,paciente.snombrecli as paciente,
tf.sdescripcion as stipofactura,subusu.nombre as nomsubusu,
p.icodmutuaR,l.idlinea,
paciente.snifcli,paciente.sdomiciliocli
from advAboUsu[empresa].dbo.linecontagastos l
left join advAboUsu[empresa].dbo.clientes prov on prov.icodcli=l.icodproveedor
left join advAboUsu[empresa].dbo.clientes recep on recep.icodcli=l.icodemisor
inner join advAboUsu[empresa].dbo.peticioncli p on p.id=l.idpeticion 
left join advAboUsu[empresa].dbo.clientes mutua on mutua.icodcli=p.icodmutuaR
left join advAboUsu[empresa].dbo.clientes paciente on paciente.icodcli=p.icodcli
left join advAboUsu[empresa].dbo.tipofactpet tf on tf.id=p.idtipofact
left join advAboUsu[empresa].dbo.subusu on subusu.icodsubusu=p.codsubusu
left join advAboUsu[empresa].dbo.clientes trab on trab.icodcli=l.icodtrabajador
where id=-1",,idlinea:INT|icodcli:INT,,,,0,,,234,,
235,41,Pacientes,"select *, anticipos + cobrosparciales + cobros - importetodo as saldo, anticipos + cobrosparciales + cobros - importerealizado as saldorealizados,
todos - realizados as pendientes
from
(select o.id, inumpresu, fecha, descripcion, esplantilla,
snombrecli, snifcli, stelefonocli, smovilcli, telefono2, telefono3, email, sprovinciacli, spoblacioncli, sdomiciliocli, scodpostalcli,
(select max(s.fechaAlta) 
from [[instancia]advabousu[empresa]].dbo.segodont s 
where idOdontograma = o.id) as ultimaFecha,
idPaciente as icodcli,
isnull((select sum(e.importe) from odontentrada e where o.id = e.idOdontograma), 0) as anticipos,
isnull((select sum(cp.importe) 
from [[instancia]advabousu[empresa]].dbo.segodontentrada cp
inner join segodont tr on tr.id = cp.idsegodont
where tr.idOdontograma = o.id and identrada is null), 0) as cobrosparciales,
isnull((select sum(segodont.importe) , segodont.consentimiento 
from [[instancia]advabousu[empresa]].dbo.segodont
LEFT OUTER JOIN [[instancia]advabousu[empresa]].dbo.lineprevcobros ON lineprevcobros.id = segodont.idlineprevcobro 
LEFT OUTER JOIN [[instancia]advabousu[empresa]].dbo.prevcobros c ON c.id = lineprevcobros.idprevcobros 
where segodont.idOdontograma = o.id and (c.cobroOdontograma is null or c.cobroOdontograma = 0) and c.cobrado = 1
), 0) as cobros,
isnull((select sum(importe) 
from [[instancia]advabousu[empresa]].dbo.segodont tr
where tr.idOdontograma = o.id
), 0) as importetodo,
isnull((select sum(tr.importe) from [[instancia]advabousu[empresa]].dbo.segodont tr
LEFT OUTER JOIN [[instancia]advabousu[empresa]].dbo.segcli ON segcli.icodcli = tr.icodcli and segcli.dfechaact = tr.dfechaact and segcli.linea = tr.linea 
where tr.idOdontograma = o.id and (tr.realizado = 1 OR segcli.acturealizada = 1)
), 0) as importerealizado,
isnull((select count(*) from [[instancia]advabousu[empresa]].dbo.segodont tr
LEFT OUTER JOIN [[instancia]advabousu[empresa]].dbo.segcli ON segcli.icodcli = tr.icodcli and segcli.dfechaact = tr.dfechaact and segcli.linea = tr.linea 
where tr.idOdontograma = o.id and (tr.realizado = 1 OR segcli.acturealizada = 1)
), 0) as realizados,
R.total as todos,
R.importeBase,
R.descuento,
R.importe, o.codusu as icodsubusu, subusu.nombre as usuario, MARCAFROM 
from [[instancia]advabousu[empresa]].dbo.odontograma o
inner join [[instancia]advabousu[empresa]].dbo.clientes on icodcli = idPaciente
left join [[instancia]advabousu[empresa]].dbo.subusu on o.codusu=subusu.icodsubusu 
inner join 
(select idOdontograma, count(*) as total, sum(isnull(importeBase, 0)*isnull(unidades, 1)) as importeBase, sum(isnull(importeBase*descuento/100, 0)) as descuento, sum(isnull(importe, 0)) as importe 
from [[instancia]advabousu[empresa]].dbo.segodont
group by idOdontograma) R on R.idOdontograma = o.id) T
where inumpresu is null AND ISNULL(esplantilla, 0) != 1",,id:INT|icodcli:INT,,,,0,,,235,,
236,42,Controles Médicos,"select seg.*, c.snombrecli, c.stelefonocli, c.telefono2, c.telefono3, c.smovilcli, c.email, c.tipobd,u.nombre as usuario
from ControlesMedicosSeg seg
inner join clientes c on c.icodcli = seg.icodcli 
left join subusu u on u.icodsubusu = seg.codsubusu
where tipobd = 0",select notas from ControlesMedicosSeg,id:INT,,,,0,,,236,,
237,44,Control Stock,"select 
	A.id, A.descripcion, A.stockR,
	(s.TotalEntradas - s.TotalSalidas) as StockRealAlmacen, A.fecha, A.referencia, 
	A.codigo, f.nombre as familia, A.tipo, A.stockM, A.stockMax, A.PUMP, A.PedProv,
	A.campo1, A.campo2, A.campo3, A.campo4, 
	A.campo5, A.campo6, A.campo7, A.campo8, 
	A.campofecha1, A.campofecha2, A.campofecha3, A.campofecha4, 
	A.propiedad1, A.propiedad2, A.propiedad3, A.propiedad4, 
	A.tipounidad, A.unidad, A.talla, A.color,
	A.propfecha1, A.propfecha2, A.propfecha3, A.propfecha4, 
	A.PedClie, clientes.snombrecli, A.preciocoste, A.pormargen, A.preciovenSI,
	A.descatalogado,
	TotalPrecioUni, Total, A.codprove, (TotalEntradas + TotalSalidas) as Unidades,
	precioMaxCompra, precioMinCompra, precioMaxVenta, precioMinVenta, 
	A.idfamilia, A.idsubfamilia, sf.nombre as subfamilia,	
	STUFF((SELECT distinct ',' + almacen.nombre FROM movstock 
	inner join almacen on movstock.idalmacen = almacen.id 
	WHERE A.id = movstock.idarticulo FOR XML PATH('')), 1, 1, '') AS almacen
	, MARCAFROM
from
	[[instancia]advabousu[empresa]].dbo.articulos A
left join [[instancia]advabousu[empresa]].dbo.familias f on A.idfamilia = f.id
left join [[instancia]advabousu[empresa]].dbo.subfamilias sf on A.idsubfamilia = sf.id	 
left join (select isnull(sum(case upper(tipo) when 'ENTRADA' then unidades end), 0) as TotalEntradas,
		isnull(sum(case upper(tipo) when 'SALIDA' then unidades end), 0) as TotalSalidas,
		isnull(sum(preciouni), 0) as TotalPrecioUni,
		sum((isnull(preciouni,0) * isnull(unidades,0))) as Total, idarticulo
		from movstock 
		group by idarticulo) S on A.id = S.idarticulo
left join [[instancia]advabousu[empresa]].dbo.clientes on A.codprove = clientes.icodcli

left join (select idarticulo, max(precioUni) as precioMaxCompra, min(precioUni) as precioMinCompra
		from movstock where (upper(tipo) = 'ENTRADA') and ((OrFactProf = 0) or (OrFactProf is null) or (idlineprevcobros is null))
		group by idarticulo) MSE
		on (MSE.idarticulo = A.id)
left join (select idarticulo, max(precioUni) as precioMaxVenta, min(precioUni) as precioMinVenta
		from movstock where (upper(tipo) = 'SALIDA') and ((idlineafactrecib <= 0) or (idlineafactrecib is null))
		group by idarticulo) MSS
		on (MSS.idarticulo = A.id)

WHERE 1=1",,id:INT,,,,0,,,,,
238,42,Controles Médicos Pacientes,"
select seg.*, c.snombrecli, c.stelefonocli, c.telefono2, c.telefono3, c.smovilcli, c.email, c.tipobd,u.nombre as usuario
from ControlesMedicosSeg seg
inner join clientes c on c.icodcli = seg.icodcli 
left join subusu u on u.icodsubusu = seg.codsubusu
where tipobd = 4
",select notas from ControlesMedicosSeg,ID:INT,,,,0,,,,,
239,45,Lotes,"select movstock.idarticulo, movstock.fecha, movstock.linea, movstock.tipo, movstock.preciouni, 
movstock.numfactura, movstock.yearfact,  movstock.codsubusufact, movstock.orfactprof, movstock.serie, movstock.cliprov, isnull(lotes.unidades, movstock.unidades) as unidades, 
movstock.idfactrecib, isnull(lotes.unidades, movstock.unidades) * movstock.preciouni as preciototal, a.indice, a.orden, a.descripcion, 
a.codigo, a.referencia, a.descatalogado,  a.codprove, a.margen, a.preciovensi, 
a.precioveni, a.preciocoste, isnull(lotes.unidades, movstock.unidades) * a.preciocoste as costetotal, fam.nombre as nomFamilia, sfam.nombre as nomSubfamilia, a.unidad, a.tipo as tipoart, a.ctaart, 
a.ctaiva, a.ctairpf, a.fecha as fechaart,  a.iva, a.notas, a.ubicacion, a.pump, 
a.talla, a.color, a.campo1,  a.campo2, a.campo3, a.campo4, a.campo5, a.campo6, 
a.campo7, a.campo8,  a.campofecha1, a.campofecha2, a.campofecha3, a.campofecha4, a.stockr,
a.stockv,  a.stockm, a.pedprov, a.pedclie, a.ctafrart, a.ctafriva, a.ctafrirpf, 
a.stockmax, proveedorart.snombrecli as provarticulo, 1 as uno, 
clienteproveedor.snombrecli as cliprovstock, 
case when orfactprof = 1 then 1 
     else 
	case when (isnull(idfactrecib, 0) > 0) then 
	     case when isnull(fr.tipofact,0) = 0 then 1
	     else 0 end
	else 0 end
end as facturado, 
case when preciocoste = 0 then 0 else (margen/preciocoste) * 100 end as porcientomargen, 
lotes.id as idLote, lotes.fechacaducidad, lotes.lote, a.codigobarras, lotes.serie as serieLote, isnull(al.nombre, '@{Almacén General}') as almacen, a.tipounidad,subusu.nombre as nombreusuario, a.backcolor,
movstock.idTraspasoAlmacen, movstock.lineaTraspaso  
--[camposperso]
from [[instancia]advabousu[empresa]].dbo.movstock
left join  [[instancia]advabousu[empresa]].dbo.lotes on lotes.idarticulo=movstock.idarticulo and lotes.fecha=movstock.fecha and lotes.linea=movstock.linea
inner join [[instancia]advabousu[empresa]].dbo.articulos a on a.id = movstock.idarticulo 
left join [[instancia]advabousu[empresa]].dbo.clientes as proveedorart on a.codprove = proveedorart.icodcli 
left join [[instancia]advabousu[empresa]].dbo.clientes as clienteproveedor on movstock.cliprov = clienteproveedor.icodcli 
left outer join [[instancia]advabousu[empresa]].dbo.almacen al on al.id = movstock.idalmacen
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = movstock.codsubusufact
left join [[instancia]advabousu[empresa]].dbo.familias fam on fam.id = a.idfamilia
left join [[instancia]advabousu[empresa]].dbo.subfamilias sfam on sfam.id = a.idsubfamilia
left join [[instancia]advabousu[empresa]].dbo.traspasoAlmacen tpa on tpa.id = movstock.idTraspasoAlmacen
left join [[instancia]advabousu[empresa]].dbo.contagastos fr on fr.id=movstock.idfactrecib 
--[leftjoinperso]",,idarticulo:INT|fecha:DATETIME|linea:DATETIME,Lotes,,,0,,,,,
240,46,Residentes,"SELECT C1.id,C1.numsofa,C1.habilitada,C1.tiposofa as tiposofa, C1.armario,
H.numhabitacion,H.numplanta,H.tipohabitacion,H.notas,
C2.icodcli, C2.snombrecli, C2.sexo
FROM sofas C1
LEFT JOIN clientes C2
ON C1.id = C2.idsofa AND C2.tipobd = 0 AND C2.fechaBaja IS NULL
LEFT JOIN habitaciones H
ON C1.id_habitacion = H.id",,,Residentes,,,0,,,,,
241,47,Clientes,"select  perso88, clientes.fechanacimiento, tipoficherocli.tipofichero, oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, 
case when oporcli.icodusu = 0 then convert(integer, null) else oporcli.icodusu end as icodusu, oporcli.icodpro, oporcli.estado,oporcli.etapa, oporcli.tipo, oporcli.codigo, oporcli.fuente, oporcli.unidades, 
oporcli.precio,oporcli.probabilidad,oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oferta, oporcli.referencia,
oporcli.oportunidad,subusu.nombre as subusuario, clientes.snombrecli,  clientes.stelefonocli as clitfo1,clientes.telefono2 as clitfo2,
clientes.telefono3 as clitfo3,  clientes.smovilcli as climvl,clientes.email as climail,  oporcli.camponum1,oporcli.camponum2,oporcli.camponum3,
oporcli.camponum4,oporcli.camponum5,oporcli.campo1,oporcli.campo2,oporcli.campo3,oporcli.campo4,oporcli.campo5,oporcli.campo6,oporcli.campo7,
oporcli.campo8,oporcli.campo9,oporcli.campo10, oporcli.campo11,oporcli.campo12,oporcli.campo13,oporcli.campo14,oporcli.campo15,oporcli.campo16,
oporcli.campo17,oporcli.campo18,oporcli.campo19,oporcli.campo20,oporcli.campo21,oporcli.campo22,oporcli.campofecha1,oporcli.campofecha2,oporcli.campofecha3, 
oporcli.campofecha4,oporcli.campofecha5,oporcli.campofecha6,oporcli.campofecha7,oporcli.campofecha8,clientes.nacionalidad  ,  
cast(datediff(day, oporcli.dfecha, COALESCE(fechacierre, getdate())) as int) as edad, 
cast(datediff(day, oporcli.fechapresupuesto, COALESCE(fechacierre, getdate())) as int) as edadpresupuesto,
cast(datediff(day, oporcli.campofecha1, COALESCE(fechacierre, getdate())) as int) as edadcomercial,
hora,
clientes.idcentros, centrospredef.sdescripcion as nombrecentro, clientes.origen as origencli, oporcli.fechapresupuesto, oporcli.fechaseguimiento, oporcli.proximopaso,
oporcli.fechavencimiento, oporcli.proximovencimiento,
oporcli.dcto,oporcli.competencia, oporcli.tipooportunidad

 from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu   
 inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli   and tipobd in (0)
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id where (tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
from oporcli
",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Clientes,0,,0,,,,,
242,47,Clientes Potenciales,"select  perso88, clientes.fechanacimiento, tipoficherocli.tipofichero, oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, 
case when oporcli.icodusu = 0 then convert(integer, null) else oporcli.icodusu end as icodusu, oporcli.icodpro, oporcli.estado,oporcli.etapa, oporcli.tipo, oporcli.codigo, oporcli.fuente, oporcli.unidades, 
oporcli.precio,oporcli.probabilidad,oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oferta, oporcli.referencia,
oporcli.oportunidad,subusu.nombre as subusuario, clientes.snombrecli,  clientes.stelefonocli as clitfo1,clientes.telefono2 as clitfo2,
clientes.telefono3 as clitfo3,  clientes.smovilcli as climvl,clientes.email as climail,  oporcli.camponum1,oporcli.camponum2,oporcli.camponum3,
oporcli.camponum4,oporcli.camponum5,oporcli.campo1,oporcli.campo2,oporcli.campo3,oporcli.campo4,oporcli.campo5,oporcli.campo6,oporcli.campo7,
oporcli.campo8,oporcli.campo9,oporcli.campo10, oporcli.campo11,oporcli.campo12,oporcli.campo13,oporcli.campo14,oporcli.campo15,oporcli.campo16,
oporcli.campo17,oporcli.campo18,oporcli.campo19,oporcli.campo20,oporcli.campo21,oporcli.campo22,oporcli.campofecha1,oporcli.campofecha2,oporcli.campofecha3, 
oporcli.campofecha4,oporcli.campofecha5,oporcli.campofecha6,oporcli.campofecha7,oporcli.campofecha8,clientes.nacionalidad  ,  
cast(datediff(day, oporcli.dfecha, COALESCE(fechacierre, getdate())) as int) as edad, 
cast(datediff(day, oporcli.fechapresupuesto, COALESCE(fechacierre, getdate())) as int) as edadpresupuesto,
cast(datediff(day, oporcli.campofecha1, COALESCE(fechacierre, getdate())) as int) as edadcomercial,
hora,
clientes.idcentros, centrospredef.sdescripcion as nombrecentro, clientes.origen as origencli, oporcli.fechapresupuesto, oporcli.fechaseguimiento, oporcli.proximopaso,
oporcli.fechavencimiento, oporcli.proximovencimiento,
oporcli.dcto,oporcli.competencia, oporcli.tipooportunidad

 from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu   
 inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli   and tipobd in (2)
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id where (tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Clientes Potenciales,2,,0,,,,,
243,47,Terceros,"select  perso88, clientes.fechanacimiento, tipoficherocli.tipofichero, oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, 
case when oporcli.icodusu = 0 then convert(integer, null) else oporcli.icodusu end as icodusu, oporcli.icodpro, oporcli.estado,oporcli.etapa, oporcli.tipo, oporcli.codigo, oporcli.fuente, oporcli.unidades, 
oporcli.precio,oporcli.probabilidad,oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oferta, oporcli.referencia,
oporcli.oportunidad,subusu.nombre as subusuario, clientes.snombrecli,  clientes.stelefonocli as clitfo1,clientes.telefono2 as clitfo2,
clientes.telefono3 as clitfo3,  clientes.smovilcli as climvl,clientes.email as climail,  oporcli.camponum1,oporcli.camponum2,oporcli.camponum3,
oporcli.camponum4,oporcli.camponum5,oporcli.campo1,oporcli.campo2,oporcli.campo3,oporcli.campo4,oporcli.campo5,oporcli.campo6,oporcli.campo7,
oporcli.campo8,oporcli.campo9,oporcli.campo10, oporcli.campo11,oporcli.campo12,oporcli.campo13,oporcli.campo14,oporcli.campo15,oporcli.campo16,
oporcli.campo17,oporcli.campo18,oporcli.campo19,oporcli.campo20,oporcli.campo21,oporcli.campo22,oporcli.campofecha1,oporcli.campofecha2,oporcli.campofecha3, 
oporcli.campofecha4,oporcli.campofecha5,oporcli.campofecha6,oporcli.campofecha7,oporcli.campofecha8,clientes.nacionalidad  ,  
cast(datediff(day, oporcli.dfecha, COALESCE(fechacierre, getdate())) as int) as edad, 
cast(datediff(day, oporcli.fechapresupuesto, COALESCE(fechacierre, getdate())) as int) as edadpresupuesto,
cast(datediff(day, oporcli.campofecha1, COALESCE(fechacierre, getdate())) as int) as edadcomercial,
hora,
clientes.idcentros, centrospredef.sdescripcion as nombrecentro, clientes.origen as origencli, oporcli.fechapresupuesto, oporcli.fechaseguimiento, oporcli.proximopaso,
oporcli.fechavencimiento, oporcli.proximovencimiento,
oporcli.dcto,oporcli.competencia, oporcli.tipooportunidad

 from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu   
 inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli   and tipobd in (3)
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id where (tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,EtiqTercerosProp,3,,1,,,,,
244,48,Clientes,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente,null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaenvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL 

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join [[instancia]advabousu[empresa]].dbo.clientes as C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (0)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,clientes,0,bVerBaseDatosClientes,1,,,,,
245,48,Pacientes,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario,f.fechaenvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp 
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (4)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
where f.inumexprelacionado is null or f.inumexprelacionado = -1
--[leftjoinperfil]
--[leftjoinperso]
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Pacientes,4,bverpaciente,0,,,,,
246,48,Mutuas,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.email,C.estadocli,C.snombrepais,C.sprovinciacli,C.spoblacioncli, 
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
null as inumexpediente, null as iyearexpediente, null as refexpediente,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaenvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
left join [[instancia]advabousu[empresa]].dbo.cliecont as contr on contr.icodclicon = E.codcontrario
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (8)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
where f.inumexprelacionado is null or f.inumexprelacionado = -1
--[leftjoinperfil]
--[leftjoinperso]
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT,Aseguradoras,8,bvermutua,0,,,,,
247,48,Mascotas,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaenvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (7)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
where f.inumexprelacionado is null or f.inumexprelacionado = -1
--[leftjoinperfil]
--[leftjoinperso]
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,EtiqMascotasProp,7,bvermascota,1,,,,,
248,48,Compañias,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo as cpd C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaEnvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (6)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Compañias,6,bvercompania,0,,,,,
249,48,Alumnos,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaEnvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL  

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (5)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Alumnos,5,bveralumno,0,,,,,
250,48,Voluntarios,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente,null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaEnvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (10)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Voluntarios,10,bvervoluntarios,0,,,,,
251,48,Expedientes,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
	CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
e.srefabogado as srefabogado, e.descripcion as descripcion, e.snumasunto as snumasunto ,texp.tipoexp as tipoexp, tasun.tipoasunto as tipoasunto, proce.procedimiento as procedimiento, juzg.juzgado as juzgado, abog.snombreabo as snombreabo,contr.snombreclicon as snombreclicon,
f.inumexp as icodcli,
convert(varchar,c.codigo) as codigo, c.stelefonocli,c.telefono2,c.telefono3,c.sdomiciliocli,c.smovilcli,c.scodpostalcli,c.estadocli,c.email,c.snombrepais,c.sprovinciacli,c.spoblacioncli, 
E.expediente as inumexpediente, E.anyo as iyearexpediente, E.srefcliente as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,

convert(varchar(50), E.inumexp) + '&' +  convert(varchar(50), E.iyear) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario,f.fechaEnvio, usuario.nombre as nombretrabajador, isnull(usuario.icodsubusu,0) as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, E.itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join  [[instancia]advabousu[empresa]].dbo.expedien E 
on  f.origen='cli' and E.inumexp=f.inumexprelacionado and E.iyear=f.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes as C on f.inumexp=C.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join [[instancia]advabousu[empresa]].dbo.tipoexp as texp on texp.codigo = E.itipoexp
left join [[instancia]advabousu[empresa]].dbo.tipoasun as tasun on tasun.codigo = E.itipoasunto
left join [[instancia]advabousu[empresa]].dbo.procedi as proce on proce.codproce = E.codproce
left join [[instancia]advabousu[empresa]].dbo.juzgado as juzg on juzg.codjuzga = E.codjuzga
left join [[instancia]advabousu[empresa]].dbo.abogados as abog on abog.icodabo = E.codpropro
left join [[instancia]advabousu[empresa]].dbo.cliecont as contr on contr.icodclicon = E.codcontrario
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join subusu usuario on usuario.icodsubusu = E.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,EtiqExpedientesProp,,bVerExpedientes,1,,,,,
252,48,Clientes Potenciales,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente,null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaEnvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (2)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Clientes Potenciales,2,bverpotenciales,0,,,,,
253,48,Financieras,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaEnvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (11)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Financieras,11,bVerFinancieras,0,,,,,
254,48,Tercera Edad,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,f.totalgastoeuro as gasto,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario, f.fechaEnvio, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion 
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL  

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f 
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (12)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Tercera Edad,12,bverterceraedad,0,,,,,
311,57,Clientes,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (0)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,clientes,0,bVerBaseDatosClientes,1,,,,,
312,57,Pacientes,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (4)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Pacientes,4,bverpaciente,0,,,,,
313,57,Mutuas,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (8)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma
",inumfactura:INT|codsubusu:INT|yearfact:INT|tipoprof:INT,Aseguradoras,8,bvermutua,0,,,,,
314,57,Mascotas,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.cliecont as contr on contr.icodclicon = E.codcontrario
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (7)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|codsubusu:INT|yearfact:INT|tipoprof:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
315,57,Compañias,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (6)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Compañias,6,bvercompania,0,,,,,
316,57,Alumnos,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
f.totalderechoseuro-f.totaldctoeuro as baseimp,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.cliecont as contr on contr.icodclicon = E.codcontrario
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (5)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Alumnos,5,bveralumno,0,,,,,
317,57,Voluntarios,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (10)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Voluntarios,10,bvervoluntarios,0,,,,,
318,57,Expedientes,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
	f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
	case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
	isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
	f.origen,f.inumexp,f.iyear,f.tipologia1,
	f.tipologia2,f.tipologia3,
	f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
	isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
	isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
	f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
	f.inumexp as icodcli,cli.estadocli, cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
	e.srefabogado as srefabogado, e.descripcion as descripcion, e.snumasunto as snumasunto ,texp.tipoexp as tipoexp, tasun.tipoasunto as tipoasunto, proce.procedimiento as procedimiento, juzg.juzgado as juzgado, abog.snombreabo as snombreabo,contr.snombreclicon as snombreclicon,e.expediente as inumexpediente, e.anyo as iyearexpediente,
	null as tipobddescrip,
	convert(varchar(50), e.inumexp) + '&' +  convert(varchar(50), e.iyear) as idexp,
	subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
	(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

	--[camposperfil]

	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.proforma f
	left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
	inner join  [[instancia]advabousu[empresa]].dbo.expedien e
	on  f.origen='cli' and e.inumexp=f.inumexprelacionado and e.iyear=f.iyearrelacionado
	left join [[instancia]advabousu[empresa]].dbo.tipoexp as texp on texp.codigo = E.itipoexp
	left join [[instancia]advabousu[empresa]].dbo.tipoasun as tasun on tasun.codigo = E.itipoasunto
	left join [[instancia]advabousu[empresa]].dbo.procedi as proce on proce.codproce = E.codproce
	left join [[instancia]advabousu[empresa]].dbo.juzgado as juzg on juzg.codjuzga = E.codjuzga
	left join [[instancia]advabousu[empresa]].dbo.abogados as abog on abog.icodabo = E.codpropro
	left join [[instancia]advabousu[empresa]].dbo.cliecont as contr on contr.icodclicon = E.codcontrario
	left join [[instancia]advabousu[empresa]].dbo.clientes as cp on E.codcliente = cp.icodcli
	left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
	as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
	on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
	
	 left join [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|codsubusu:INT|yearfact:INT|tipoprof:INT,EtiqExpedientesProp,,bVerExpedientes,1,,,,,
319,57,Clientes Potenciales,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (2)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Clientes Potenciales,2,bverpotenciales,0,,,,,
320,57,Financieras,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, f.iyearrelacionado as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (11)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Financieras,11,bverfinancieras,0,,,,,
321,57,Tercera Edad,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,
f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

--[camposperfil]

, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (12)
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
--[leftjoinperfil]
where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)


where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Tercera Edad,12,bverterceraedad,0,,,,,
322,58,Clientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu,
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
  f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (0)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,clientes,0,bVerBaseDatosClientes,1,,,,,
323,58,Pacientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (4)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Pacientes,4,bverpaciente,0,,,,,
324,58,Mutuas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (8)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Aseguradoras,8,bvermutua,0,,,,,
325,58,Mascotas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (7)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
326,58,Compañias,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (6)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Compañias,6,bvercompania,0,,,,,
327,58,Alumnos,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (5)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Alumnos,5,bveralumno,0,,,,,
328,58,Voluntarios,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (10)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Voluntarios,10,bvervoluntarios,0,,,,,
330,58,Clientes Potenciales,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada,  
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (2)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Clientes Potenciales,2,bverpotenciales,0,,,,,
331,58,Financieras,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 
 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (11)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Financieras,11,bverfinancieras,0,,,,,
332,58,Tercera Edad,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu,
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 

 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (12)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Tercera Edad,12,bverterceraedad,0,,,,,
333,59,Clientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (0)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,clientes,0,bVerBaseDatosClientes,1,,,,,
334,59,Pacientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (4)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Pacientes,4,bverpaciente,0,,,,,
335,59,Mutuas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (8)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Aseguradoras,8,bvermutua,0,,,,,
336,59,Mascotas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (7)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
337,59,Compañías,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (6)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Compañías,6,bvercompania,0,,,,,
338,59,Alumnos,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (5)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Alumnos,5,bveralumno,0,,,,,
339,59,Voluntarios,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (10)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Voluntarios,10,bvervoluntarios,0,,,,,
340,59,Clientes Potenciales,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (2)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Clientes Potenciales,2,bverpotenciales,0,,,,,
341,59,Financieras,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (11)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|codsubusu:INT|yearfact:INT|tipoprof:INT,Financieras,11,bverfinancieras,0,,,,,
342,59,Tercera Edad,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (12)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Tercera Edad,12,bverterceraedad,0,,,,,
343,60,Clientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof, f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (0)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,clientes,0,bVerBaseDatosClientes,1,,,,,
344,60,Pacientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (4)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Pacientes,4,bverpaciente,0,,,,,
345,60,Mutuas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (8)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Aseguradoras,8,bvermutua,0,,,,,
346,60,Mascotas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (7)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
347,60,Compañías,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (6)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Compañías,6,bvercompania,0,,,,,
348,60,Alumnos,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (5)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Alumnos,5,bveralumno,0,,,,,
349,60,Voluntarios,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (10)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Voluntarios,10,bvervoluntarios,0,,,,,
350,60,Clientes Potenciales,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (2)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Clientes Potenciales,2,bverpotenciales,0,,,,,
351,60,Financieras,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (11)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Financieras,11,bVerFinancieras,0,,,,,
352,60,Tercera Edad,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof, f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (12)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Tercera Edad,12,bverterceraedad,0,,,,,
353,61,Clientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (0)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,clientes,0,bVerBaseDatosClientes,1,,,,,
354,61,Pacientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (4)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Pacientes,4,bverpaciente,0,,,,,
355,61,Mutuas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (8)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Aseguradoras,8,bvermutua,0,,,,,
356,61,Mascotas,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (7)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
357,61,Compañías,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (6)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Compañías,6,bvercompania,0,,,,,
358,61,Alumnos,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (5)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT,Alumnos,5,bveralumno,0,,,,,
359,61,Voluntarios,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (10)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|yearfact:INT|tipoprof:INT,Voluntarios,10,bvervoluntarios,0,,,,,
360,61,Clientes Potenciales,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (2)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Clientes Potenciales,2,clipot|1,0,,,,,
361,61,Financieras,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (11)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Financieras,11,bverfinancieras,0,,,,,
362,61,Tercera Edad,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (12)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Tercera Edad,12,bverterceraedad,0,,,,,
365,48,Terceros,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
f.reffactu,
f.totalhonoeuro,f.totalgastoeuro as gasto,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.estadocli,C.scodpostalcli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario,f.fechaEnvio,
null as tipoexp, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL  

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (3)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,EtiqTercerosProp,3,bVerTerceros,1,,,,,
366,57,Terceros,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
	f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
	case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
	isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
	f.origen,f.inumexp,f.iyear,f.tipologia1,
	f.tipologia2,f.tipologia3,
	f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
	isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
	isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
	f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
	cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
	null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
	case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
	convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
	subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
	(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

	--[camposperfil]

	, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
	left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
	left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
	inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (3)
	left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
	as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact) as fvto  
	on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact	
	--[leftjoinperfil]
	where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)

	where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqTercerosProp,3,bVerTerceros,1,,,,,
367,58,Terceros,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 


 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (3)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqTercerosProp,3,bVerTerceros,1,,,,,
368,59,Terceros,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (3)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqTercerosProp,3,bVerTerceros,1,,,,,
369,60,Terceros,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof, f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (3)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqTercerosProp,3,bVerTerceros,1,,,,,
370,61,Terceros,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (3)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,EtiqTercerosProp,3,ver_otros|1,1,,,,,
371,62,Clientes,"SELECT 

C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,

C.idcentros,
CEXT.codtercero as icodtercero, CEXT.comComerciales,
CEXT.backcolor,
CEXT.codmutua as icodmutua,
CEXT.estadoLOPD,
-- Campos usados en indicadores (gestorresumen), obligatorios
CR.baja, CR.activo, C.tipofichero

--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientes ct1 on cext.codcontacto = ct1.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef CP on C.idcentros = CP.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CM on CEXT.codmutua = CM.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (0)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,EtiqClientesProp,0,,1,,,,,
372,63,Potenciales,"SELECT 
C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad, CR.baja, CR.activo, 
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,

CEXT.codtercero as icodtercero, CEXT.comComerciales, CEXT.estadoLOPD,
CEXT.backcolor,
C.idcentros, C.tipofichero

--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id
--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (2)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Potenciales,,,0,,,,,
373,11,Terceros,"select distinct tipoficherocli.tipofichero,
c.icodcli, o.id,fechavencimiento, snombrecli, c.snifcli, tipo, grupo, descripcion, realizado, fechacontrato, importe, estado, fechacontacto, 
prima, company, agente,o.formapago,duracion,o.campo1,o.campo2,o.campo3,o.campo4,o.campofecha1,o.campofecha2,c.stelefonocli as telefono1, 
c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, o.codsubusu, S.nombre as nomsubusu,
numpoliza, fechaefecto, tipopoliza, situacionpoliza, fechaanulacion, motivoanulacion, numanulacion, poliza,
c.idcentros, centrospredef.sdescripcion as nombrecentro , propietario, conductor 
from [[instancia]advabousu[empresa]].dbo.clivencimientos o 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on o.icodcli=c.icodcli and tipobd in (3)
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.subusu S on o.codsubusu=S.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.clivencimientosbancos cv on cv.id_clivencimiento = o.id
left join [[instancia]advabousu[empresa]].dbo.clibancos cb on  cb.icodcli = cv.icodcli_clibancos and cb.linea = cv.linea_clibancos","select icodcli, notas from clivencimientos",icodcli:INT|id:INT,Terceros,,,0,,,,,
376,64,Expedientes,"SELECT

E.inumexp, E.iyear, E.anyo, E.codsubusu, E.enPapelera,
E.inumexp * CAST(10000 as bigint) + E.iyear as idexp,
E.expediente, E.descripcion, E.itipoexp, E.itipoasunto,E.codproce,
E.codcliente, C.snombrecli,E.codclitrabajador,
E.codcontrario, E.codcolitiga, E.codabocon, E.codpropro as codabopropio,E.codprocon,
E.codabopro as codprocpropio,E.codjuzga,E.codcliotro,E.codcolab,
E.inivelprivacidad,E.idcentros, E.backcolor, E.codproveedor as codigoProveedor, ER.dormidoeconomico, C.snombreclicomercial as nomcomcli,
E.srefabogado,E.snumasunto,E.NIG,procedi.procedimiento, abocont.snombreabo as abocontrario, aboprop.snombreabo as abopropio,

-- Campos obligatorios para los indicadores
(ISNULL(ER.totalCobrado,0) + ISNULL(E.ftotalprovisiones,0) - ISNULL(ER.totalCosteAct,0)) as totalBeneficio, 
((ISNULL(ER.totalCobrado,0) + ISNULL(E.ftotalprovisiones,0) - ISNULL(ER.totalCosteAct,0)) /nullif((ISNULL(ER.totalCobrado,0) + ISNULL(E.ftotalprovisiones,0)),0))*100  as porcentajeBeneficio,
E.ftotalprovisiones, ER.totalcobrado, E.estado, clicont.snombreclicon, ER.salidasMenosEntradasRecobros,
ER.totalHonorarios, ER.totalGastos, ER.totalbaseimponible, ER.totalAnticipos, ER.totalsuplidos, ER.TotalProvRecibidas, ER.TotalProvSolicitadas, ER.totalfacturacion 

--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.expedien E
LEFT JOIN [[instancia]advabousu[empresa]].dbo.colabora COL ON E.codcolab= COL.codcolab
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT ON E.codcliotro= CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CP ON E.codclipoten = CP.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes C ON E.codcliente = C.icodcli AND C.tipobd <> 16
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes T on E.codclitrabajador = T.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes PROV on E.codproveedor = PROV.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON E.codsubusu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoexp TE ON E.itipoexp = TE.codigo
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedienresumen ER ON E.inumexp = ER.inumexp AND E.iyear = ER.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef on E.idcentros = centrospredef.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo = E.itipoasunto
LEFT JOIN [[instancia]advabousu[empresa]].dbo.procedi on procedi.codproce = E.codproce
LEFT JOIN [[instancia]advabousu[empresa]].dbo.abogados abocont on E.codabocon = abocont.icodabo 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.abogados aboprop on E.codpropro = aboprop.icodabo
LEFT JOIN [[instancia]advabousu[empresa]].dbo.cliecont clicont on E.codcontrario = clicont.icodclicon
LEFT JOIN [[instancia]advabousu[empresa]].dbo.procurad proccont on E.codprocon = proccont.icodpro 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.procurad procprop on E.codabopro = procprop.icodpro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.juzgado on E.codjuzga = juzgado.codjuzga
LEFT JOIN [[instancia]advabousu[empresa]].dbo.segfase SF on E.idfaseprincipal = SF.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.contacto CON on E.codcontacto = CON.codcontacto
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = E.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = E.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.colitiga colit  on colit.codcolit = E.codcolitiga
--[leftjoinperso]

WHERE (inumexp <> 9999 OR iyear <> 1899) AND ISNULL(enPapelera, 0) <> 1
","select notas, notas2, notas3, notas4, notas5, notas6 from expedien",inumexp:INT|iyear:INT,Expedientes,,,0,,,,,
384,66,Clientes,"SELECT 
	B.id,B.estado,B.fechaalta,B.numbono,
	C.icodcli,C.snombrecli,C.tipobd,C.tipofichero,C.idcentros,
	B.tipobono,B.descripcion,B.total,B.unidades,B.saldo,B.ImporteCobrado,
	B.duracion, B.numvolante as numvolante, B.importeconsumido,B.sesionesconsumidas,
	B.tiempoconsumido,B.sesionesdisponibles,B.importedisponible,
	B.tiempodisponible,B.fechacaducidad,b.consumido,b.disponible,b.totalresumen, B.referencia,b.fechacierre,
	S.icodsubusu,S.nombre as susuario,
	DATEDIFF(day, B.fechaalta, getdate()) as edad,
	DATEDIFF(day, B.fechaultimaactuacion, getdate()) as diassinuso,
	b.cobrado,C.stelefonocli,C.smovilcli,
	CEXT.snombretutor1,CEXT.stelefonotutor1,CEXT.snombretutor2,CEXT.stelefonotutor2, MU.snombrecli AS Aseguradora, CEXT.codmutua, MARCAFROM
FROM 
	[[instancia]advabousu[empresa]].dbo.vListadoBonos B
JOIN
	[[instancia]advabousu[empresa]].dbo.clientes C 
	ON B.icodcliClientes = C.icodcli AND C.tipobd in (0)
LEFT JOIN
	[[instancia]advabousu[empresa]].dbo.bonoUsuarios BU
	ON BU.idbono = B.id
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.subusu S
	ON BU.icodusu = S.icodsubusu
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.clientesext CEXT 
	ON C.icodcli = CEXT.icodcli
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.clientes MU 
	ON CEXT.codmutua = MU.icodcli ","SELECT notas,notas2,notas3,notas4,notas5,notas6 FROM bonos",id:INT|icodcli:INT,EtiqClientesProp,0,,1,,,,,
385,66,Pacientes,"SELECT 
	B.id,B.estado,B.fechaalta,B.numbono,
	C.icodcli,C.snombrecli,C.tipobd,C.tipofichero,C.idcentros,
	B.tipobono,B.descripcion,B.total,B.unidades,B.saldo,B.ImporteCobrado,
	B.duracion,B.importeconsumido,B.sesionesconsumidas,
	B.tiempoconsumido,B.sesionesdisponibles,B.importedisponible,
	B.tiempodisponible,B.fechacaducidad,b.consumido,b.disponible,b.totalresumen, B.referencia,b.fechacierre,
	S.icodsubusu,S.nombre as susuario,
	DATEDIFF(day, B.fechaalta, getdate()) as edad,
	DATEDIFF(day, B.fechaultimaactuacion, getdate()) as diassinuso,
	b.cobrado, B.numvolante as numvolante, C.stelefonocli,C.smovilcli,
	CEXT.snombretutor1,CEXT.stelefonotutor1,CEXT.snombretutor2,CEXT.stelefonotutor2, MU.snombrecli AS Aseguradora, CEXT.codmutua, MARCAFROM
FROM 
	[[instancia]advabousu[empresa]].dbo.vListadoBonos B
JOIN
	[[instancia]advabousu[empresa]].dbo.clientes C 
	ON B.icodcliClientes = C.icodcli AND C.tipobd in (4)
LEFT JOIN
	[[instancia]advabousu[empresa]].dbo.bonoUsuarios BU
	ON BU.idbono = B.id
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.subusu S
	ON BU.icodusu = S.icodsubusu
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.clientesext CEXT 
	ON C.icodcli = CEXT.icodcli
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.clientes MU 
	ON CEXT.codmutua = MU.icodcli ","SELECT notas,notas2,notas3,notas4,notas5,notas6 FROM bonos",id:INT|icodcli:INT,Pacientes,4,,0,,,,,
387,68,Proveedores,"SELECT 

C.icodcli,C.tipobd,C.codsubusu,C.inivelprivacidad,
C.snombrecli,C.email,C.stelefonocli,C.telefono2,C.telefono3,C.smovilcli,
C.sfaxcli,C.sdomiciliocli,C.spoblacioncli,C.sprovinciacli,C.fechaalta,C.fechabaja,
C.tipofichero,C.sNombrePais,C.cuentabanco,C.estadocli,C.scodpostalcli,
C.snifcli,C.snombreclicomercial,C.referencia,
year(fechaalta) as anhoalta,DATENAME(MONTH, C.fechaalta) as mesalta,
year(fechabaja) as anhobaja,DATENAME(MONTH, C.fechabaja) as mesbaja,

nie,pasaporte,tarjetaresidencia,campo21,campo22,campo23,campo24,
origen,zona,empresa,departamento,cargo,numempleados,sector,
fechanacimiento,fechapermiso,campofecha9,campofecha10,
campofecha11,campofecha12,campofecha13,campo1,campo2,
campo3,campo4,campo5,campo6,campo7,campo8,campo9,campo10,
campo11,campo12,campo13,campo14,campo15,campo16,campo17,
campo18,campo19,campo20,campofecha1,campofecha2,campofecha3,
campofecha4,campofecha5,campofecha6,campofecha7,campofecha8,
perso83,perso84,perso85,perso86,perso87,perso88,persofecha2,
persofecha3,persofecha4,persofecha5,persofecha9,persofecha7,
persofecha6,persofecha8,perso79,perso78,perso77,perso76,perso75,perso74,

S.nombre as susuario,
CR.dormidoHistorial,CR.dormidoEconomico,CR.totalCobrado,
CR.saldoPendiente,CR.saldoVencidoNoCobrado,CR.fechaProximoCobro,
CR.totalFacturacion,CR.numActuaciones,CR.diasSinAct,CR.diasUltimoCobro,
CR.diasMorosidad,CR.numActRetrasadas,CR.diasActivo,CR.reclamacion,
CR.incidencias,CR.comunicaciones, CR.baja, CR.activo,
C.idcentros,centrospredef.sdescripcion as nombrecentro, C.edad,

CEXT.backcolor, CEXT.comComerciales, CEXT.estadoLOPD
--[camposperso]


FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperso]

WHERE tipobd in (9)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,EtiqClientesProp,0,,1,,,,,
388,34,Pacientes,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro,p.impdef, c.tipofichero as tipoficheroclientes , p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (4)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Pacientes,4,bverpaciente,0,,,,,
389,34,Mutuas,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro,p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos 
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (8)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Aseguradoras,8,bvermutua,0,,,,,
390,34,Mascotas,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (7)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
391,34,Compañias,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva  
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos   
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (6)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Compañias,6,bvercompania,0,,,,,
392,34,Alumnos,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp ,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (5)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Alumnos,5,bveralumno,0,,,,,
393,34,Voluntarios,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (10)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Voluntarios,10,bvervoluntarios,0,,,,,
394,34,Clientes Potenciales,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (2)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Clientes Potenciales,2,,0,,,,,
395,34,Financiadores,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva 
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (11)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Financiadores,11,bVerFinancieras,0,,,,,
396,34,Tercera Edad,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva  
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (12)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Tercera Edad,12,bverterceraedad,0,,,,,
397,34,anticipos odontograma,"select *, MARCAFROM from
(select odontentrada.fecha as fechagasing,
odontentrada.descripcion as descripcion,
odontentrada.fecha as fechacobro,
odontentrada.fecha, c.snombrecli as cliente, c.icodcli,
odontentrada.formacobro as formapago1, null as srefabogado, 
odontentrada.formacobro as formapago,
odontentrada.importe as total,
odontentrada.descripcion as concepto,
1 as cobrado,
1 as realizada, odontentrada.fecha as fecharealizada, null as serie,
null as inumfact, null as yearfact,null as asientocobro, null as ctaacrcli,
null as ctacajban, null as ctagasing, 1 as tipo,
null as baseimp, null as iva, null as irpf, odontentrada.codusu as codsubusu,
null as factura,
null as notas, null as yearcontacobro, null as subusufact, null as id, null as impagado, null as fechaimpagado, null as lineacobro,
null as ctacobrado, null as lineaimpagado, null as ctaimpagado, null as asientoimpagado, null as yearcontaimpagado, null as tipoprof,
null as origen, null as iyear, null as inumexp, null as bproformarel, null as inumproformarel, null as yearproformarel,
null as codsubusuproformarel, null as tipoproformarel, null as facturar, null as ctaiva, null as ctairpf,
null  as diariocobro, 
null diarioimpagado,
null as tipofactura, 
null as tipoimpago, 
null as tipoimpago1, 
null as importeimpagado,
0 as estaremesado, 
null as  banco, 
null as  fechafact,
null as tip1, null as tip2, null as tip3, 
c.fechaalta as fechaaltacliente, 
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro,
c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
null as cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, null as inumcobro, null as numeroexprelac, null as iyearrelac, null as nombreexp, '' as nombrealum,
null as codclitrabajador, null as nombretrab,
null as alcobro, null as impdef, c.tipofichero as tipoficheroclientes, null as inumexprelacionado, null as iyearrelacionado, null as inumexpediente, null as iyearexpediente, null as idexp, null as tipoConcepto, null as poriva  
, NULL AS mod303, NULL AS mod347, NULL AS mod349, NULL AS mod130, NULL AS mod233, NULL AS mod233Subvencion, NULL AS TodosModelos 
, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.odontentrada
inner join [[instancia]advabousu[empresa]].dbo.odontograma on odontograma.id = odontentrada.idodontograma
inner join [[instancia]advabousu[empresa]].dbo.clientes c on odontograma.idpaciente = c.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = odontentrada.codusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd

--[leftjoinperfil]

) p",,id:INT,Anticipos Odontograma,,desactivado,0,,,,,
398,34,cobros parciales odontograma,"select *, MARCAFROM  from
(select segodontentrada.fecha as fechagasing,
segodont.descripcion as descripcion,
segodontentrada.fecha as fechacobro,
segodontentrada.fecha, c.snombrecli as cliente, c.icodcli,
segodontentrada.formacobro as formapago1, null as srefabogado, 
segodontentrada.formacobro as formapago,
segodontentrada.importe as total, 
segodont.descripcion as concepto, 
1 as cobrado,
1 as realizada, segodontentrada.fecha as fecharealizada, null as serie,
null as inumfact, null as yearfact,null as asientocobro, null as ctaacrcli,
null as ctacajban, null as ctagasing, 1 as tipo, 
null as baseimp, null as iva, null as irpf, segodontentrada.codusu as codsubusu, 
null as factura,
null as notas, null as yearcontacobro, null as subusufact, null as id, null as impagado, null as fechaimpagado, null as lineacobro,
null as ctacobrado, null as lineaimpagado, null as ctaimpagado, null as asientoimpagado, null as yearcontaimpagado, null as tipoprof,
null as origen, null as iyear, null as inumexp, null as bproformarel, null as inumproformarel, null as yearproformarel,
null as codsubusuproformarel, null as tipoproformarel, null as facturar, null as ctaiva, null as ctairpf,
null  as diariocobro, null diarioimpagado,
null as tipofactura,
null as tipoimpago, null as tipoimpago1, null as importeimpagado,
0 as estaremesado, null as  banco, null as  fechafact,
null as tip1, null as tip2, null as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3,
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro,
c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
null as cobroodontograma, identrada,
null as expcampo28, null as expcampo29, null as expcampo34,null as inumcobro, null as numeroexprelac, null as iyearrelac, null as nombreexp, '' as nombrealum,
null as codclitrabajador, null as nombretrab,
null as alcobro, null as impdef, c.tipofichero as tipoficheroclientes, null as inumexprelacionado, null as iyearrelacionado, null as inumexpediente, null as iyearexpediente, null as idexp, null as tipoConcepto, null as poriva  
, NULL AS mod303, NULL AS mod347, NULL AS mod349, NULL AS mod130, NULL AS mod233, NULL AS mod233Subvencion, NULL AS TodosModelos 
, NULL AS tipoOperacionIVA, NULL AS detalleOperacionIVA, NULL AS tipoExencionIVA, NULL AS motivoExencionIVA, NULL AS tipoOperacionIRPF 

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.segodontentrada 
inner join [[instancia]advabousu[empresa]].dbo.segodont on segodont.id = segodontentrada.idsegodont
inner join [[instancia]advabousu[empresa]].dbo.odontograma on odontograma.id = segodont.idodontograma
inner join [[instancia]advabousu[empresa]].dbo.clientes c on odontograma.idpaciente = c.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = segodontentrada.codusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd

--[leftjoinperfil]

) p where identrada is null",,id:INT,Cobros Parciales Odontograma,,desactivado,0,,,,,
399,48,Trabajadores,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible,
f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.reffactu,
f.totalhonoeuro,f.totalgastoeuro as gasto,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario,f.fechaEnvio,
null as tipoexp, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL   

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (1)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Trabajadores,1,bvertrabajador,0,,,,,
403,13,Terceros,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
p.total,p.concepto, isnull(p.cobrado,0) as cobrado ,isnull(p.cobrado,0) as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
l.fecha as fecharemesa,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
p.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, f.fracobrada, f.codsubusu as fcodsubusu , e.descripcion as nombreexp, '' as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,e.expediente as numeroexprelac, e.anyo as iyearrelac,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp,
e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador, usuficha.nombre as nombreusuficha

--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id 
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (3)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre
left join [[instancia]advabousu[empresa]].dbo.subusu usuficha on usuficha.icodsubusu = c.codsubusu
left join (
	select distinct(idprevcobros) as idprevCobroTratamiento from ( 
	select idprevcobros from [[instancia]advabousu[empresa]].dbo.lineprevcobros where id in (select idlineprevcobro from [[instancia]advabousu[empresa]].dbo.TratamientosCobros)
	union 
	select prv.id as idprevcobros
	from [[instancia]advabousu[empresa]].dbo.tratamientosfacturas tf 
	left join [[instancia]advabousu[empresa]].dbo.cuencli c ON c.linea = TF.cuenta_linea and c.dfecha = TF.cuenta_dfecha and c.icodcli = tf.cuenta_icodcli
	left join [[instancia]advabousu[empresa]].dbo.prevcobros prv on prv.yearfact = c.yearfact and prv.inumfactura = c.inumfactura and c.serie=prv.serie  and c.codsubusu=prv.subusufact) tl
) estratamiento on P.id = estratamiento.idprevCobroTratamiento
LEFT JOIN [[instancia]advabousu[empresa]].dbo.combovalores especialidades on P.tipoEspecialidad = especialidades.id

--[leftjoinperso]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Terceros,3,,0,,,,,
404,34,Terceros,"select line.fecha as fechagasing, 
line.concepto as descripcion,
p.fechaingreso as fechacobro,
p.fecha, p.nombrecli as cliente, c.icodcli,
isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
p.formapago,
line.total,
p.concepto,
isnull(p.cobrado,0) as cobrado ,
isnull(p.cobrado,0) as realizada,p.fechacobro as fecharealizada,p.serie,
p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,
line.baseimp,line.iva,line.irpf,line.codsubusu,
p.factura,
caja.caja,
p.notas,p.yearcontacobro,p.subusufact,line.id,p.impagado,p.fechaimpagado,p.lineacobro,
p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
case p.factura 
when 1 then 'oficial' 
when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
else 'sin facturar' end as tipofactura,
p.tipoimpago,
case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
p.importeimpagado,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
c.fechaalta as fechaaltacliente,
subusu.nombre as nomsubusu,
c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
c.smovilcli as movil,c.email, 
c.idcentros, centrospredef.sdescripcion as nombrecentro 
, c.starjetasocio , c.perso88, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
p.cobroodontograma, null as identrada,
null as expcampo28, null as expcampo29, null as expcampo34, p.inumcobro, e.expediente as numeroexprelac, e.anyo as iyearrelac, e.descripcion as nombreexp, alum.snombrecli as nombrealum,
e.codclitrabajador, clitrab.snombrecli as nombretrab,
p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado, p.inumexprelacionado as inumexpediente, p.iyearrelacionado as iyearexpediente, convert(varchar(50), p.inumexprelacionado) + '&' +  convert(varchar(50), p.iyearrelacionado) as idexp ,
(select TOP(1)case when line.bhonoarticulo = 1 then persoArt else persoHONO end from [[instancia]advabousu[empresa]].dbo.config) as tipoConcepto, line.poriva  
, CASE WHEN (line.modelosIVA & 0x8) <> 0 THEN 1 ELSE 0 END AS mod303, CASE WHEN (line.modelosIVA & 0x10) <> 0 THEN 1 ELSE 0 END AS mod347, CASE WHEN (line.modelosIVA & 0x20) <> 0 THEN 1 ELSE 0 END AS mod349 
, CASE WHEN (line.modelosIRPF & 0x40) <> 0 THEN 1 ELSE 0 END AS mod130, cast(isnull(line.mod233,0) as int) as mod233 , cast(isnull(line.mod233Subvencion,0) as int) as mod233Subvencion 
, line.modelosIVA | line.modelosIRPF | (ISNULL(line.mod233, 0) * 256) | (ISNULL(line.mod233Subvencion, 0) * 512) AS TodosModelos  
, ci.descripcion AS tipoOperacionIVA, line.detalleOperacionIVA, line.tipoExencionIVA, line.tipoOperacionIRPF 
, CASE WHEN line.tipoOperacionIVA = 11 OR line.tipoExencionIVA = 1 THEN me.descripcion WHEN line.tipoExencionIVA = 0 THEN mne.descripcion ELSE '' END AS motivoExencionIVA

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.lineprevcobros line
inner join [[instancia]advabousu[empresa]].dbo.prevcobros p on line.idprevcobros = p.id
left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=line.yearfact and f.inumfactura=line.inumfactura and 
f.codsubusu=line.subusufact and f.serie=line.serie
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=line.yearfact and prof.inumfactura=line.inumfactura and
prof.codsubusu=line.subusufact and prof.tipoprof=line.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes c on p.inumexp=c.icodcli and p.origen='cli' and c.tipobd in (3)
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = line.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = line.inumexpalum and e.iyear = line.iyearexpalum
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.clientes alum ON line.icodclirelacionado = alum.icodcli 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON ci.idclaseiva = line.tipoOperacionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoExento me ON me.id = line.motivoExencionIVA
LEFT JOIN [[instancia]advabousu[empresa]].dbo.motivoSujetoNoExento mne ON mne.id = line.motivoExencionIVA

--[leftjoinperfil]

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Terceros,3,,0,,,,,
405,66,Alumnos,"SELECT 
	B.id,B.estado,B.fechaalta,B.numbono,
	C.icodcli,C.snombrecli,C.tipobd,C.tipofichero,C.idcentros,
	B.tipobono,B.descripcion,B.total,B.unidades,B.saldo,B.ImporteCobrado,
	B.duracion,B.importeconsumido,B.sesionesconsumidas,
	B.tiempoconsumido,B.sesionesdisponibles,B.importedisponible,
	B.tiempodisponible,B.fechacaducidad,b.consumido,b.disponible,b.totalresumen, B.referencia,b.fechacierre,
	S.icodsubusu,S.nombre as susuario,
	DATEDIFF(day, B.fechaalta, getdate()) as edad,
	DATEDIFF(day, B.fechaultimaactuacion, getdate()) as diassinuso,
	b.cobrado, B.numvolante as numvolante, C.stelefonocli,C.smovilcli,
	CEXT.snombretutor1,CEXT.stelefonotutor1,CEXT.snombretutor2,CEXT.stelefonotutor2, MU.snombrecli AS Aseguradora, CEXT.codmutua, MARCAFROM
FROM 
	[[instancia]advabousu[empresa]].dbo.vListadoBonos B
JOIN
	[[instancia]advabousu[empresa]].dbo.clientes C 
	ON B.icodcliClientes = C.icodcli AND C.tipobd in (5)
LEFT JOIN
	[[instancia]advabousu[empresa]].dbo.bonoUsuarios BU
	ON BU.idbono = B.id
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.subusu S
	ON BU.icodusu = S.icodsubusu
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.clientesext CEXT 
	ON C.icodcli = CEXT.icodcli
LEFT JOIN 
	[[instancia]advabousu[empresa]].dbo.clientes MU 
	ON CEXT.codmutua = MU.icodcli ","SELECT notas,notas2,notas3,notas4,notas5,notas6 FROM bonos",id:INT|icodcli:INT,Alumnos,5,,0,,,,,
406,71,Pacientes,"SELECT 

C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,


C.idcentros, 
CEXT.codtercero as icodtercero, CEXT.comComerciales,
CEXT.backcolor,
CEXT.codmutua as icodmutua,
CEXT.estadoLOPD,
-- Campos usados en indicadores (gestorresumen), obligatorios
CR.baja, CR.activo, C.tipofichero, orto.id as idortodoncia,

stuff((select distinct ',' + diagnostico from [[instancia]advabousu[empresa]].dbo.diagnosticoPac d where d.icodcli = C.icodcli for xml path('')), 1, 1, '') as diagnosticos,
'' as grupodiagnosticos

--[camposperfil]
--[camposperso]

, MARCAFROM
FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef CP on C.idcentros = CP.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CM on CEXT.codmutua = CM.icodcli 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
OUTER APPLY (select top 1 icodcli as icodcliproxcita, segcli.sactuacion as proxcitadesc, dfechaact as fechaproxcita from [[instancia]advabousu[empresa]].dbo.segcli where segcli.agenda = 1 and Convert(date, segcli.dfechaact) >= Convert(date,GETDATE()) and c.icodcli = icodcli order by segcli.dfechaact) proxcita
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.odontograma orto on orto.idPaciente = C.icodcli and orto.inumpresu is null and orto.tipoEspecialidad = (select id from combovalores where tabla = 'segodont' and campo = 'tipoespecialidad' and valor = 'Ortodoncia')
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu usuorto on usuorto.icodsubusu = orto.codUsuario
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu auxorto on auxorto.icodsubusu = orto.codAuxiliar

--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (4)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Pacientes,4,bverpaciente,0,,,,,
407,72,Alumnos,"SELECT 

C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad, 
C.idcentros,
CEXT.codtercero as icodtercero,
CEXT.backcolor,CEXT.docPdteFirma,CEXT.tieneCobrosPdte, CEXT.comComerciales, CEXT.estadoLOPD,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,


-- Campos usados en indicadores (gestorresumen), obligatorios
CR.baja, CR.activo, C.tipofichero


--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CPral on CPral.icodcli = CEXT.codcliente
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef CP on C.idcentros = CP.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (5)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Alumnos,5,bveralumno,0,,,,,
408,73,Historial Clientes,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
            (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
            
            act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,

            act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,

            act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 

            act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 

			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas, 
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

            inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (0)
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]
			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Clientes,,,0,,,,,
409,76,Gastos Clientes,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,
act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohistotr,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre, act.icodprov

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.segcli act
inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli
left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientes proveedor on act.icodprov = proveedor.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
left join [[instancia]advabousu[empresa]].dbo.[events] eventos
on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')

--[leftjoinperfil]
--[controlhorario]

where tipohistotr = 2","select notas, notas2, notas3, notas4, notas5, notas6from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Clientes,,,0,,,,,
411,73,Historial Expedientes,"
select distinct tipoficherocli.tipofichero, act.agenda, 1 as origen,
			
			(CAST(act.inumexp as varchar) + '-' + CAST(act.iyear as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			
			e.expediente as numero,e.expediente, e.estado, c.codigo,act.inumexp as inumexp,e.codcliente as icodcli,act.dfechaact as dfechaact,act.iyear as iyear,
			
            tipoexp.tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,

            act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,

            act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact, c.snombrecli,c.email,act.facturable,act.campo16 as perso88, c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,

            s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas,e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3,
            segfase.id as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16, act.campo17, act.campo18,act.campofecha1,act.campofecha2,act.campofecha3,
            act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, act.tiempoprevisto, 

            cast(null as varchar) as nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli, e.codsubusu as expusu, itipoexp,e.expediente as numexp, itipoasunto, tipoasun.tipoasunto, null as tipocliente, e.codcontrario, cont.snombreabo as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
            case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
            case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
            case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
            clicont.snombreclicon as contrario, prop.snombreabo as abopropio, prop.icodabo as codabopropio, c.origen as origencli, 
			e.inumexp*CAST(10000 as bigint)+e.iyear as idexp, null as clicampo6,
			e.idcentros, centrospredef.sdescripcion as nombrecentro , null as oportunidad, null as zona, procedimiento, e.codproce, null as sfaxcli, null as cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, cont.icodabo as codabocontrario, 
			(select top (1) codjuzga from [[instancia]advabousu[empresa]].dbo.expjuzga
			where expjuzga.numexp=e.inumexp and expjuzga.iyear=e.iyear order by expjuzga.principal desc ) as codjuzga,
			(select top (1) juzgado from [[instancia]advabousu[empresa]].dbo.expjuzga 
			left outer join [[instancia]advabousu[empresa]].dbo.juzgado on expjuzga.codjuzga=juzgado.codjuzga
			where expjuzga.numexp=e.inumexp and expjuzga.iyear=e.iyear order by expjuzga.principal desc ) as juzgado,
			e.snumasunto, act.unidad,
			worker.codigo as numtrabajador, worker.snombrecli as nombretrabajador, exclipro.estado1 as excliproestado1, exclipro.estado2 as excliproestado2, exclipro.estado3 as excliproestado3, 
			exclipro.estado4 as excliproestado4, exclipro.estado5 as excliproestado5, exclipro.estado6 as excliproestado6, '' as origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,

			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, 
			act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli, act.aula, e.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			worker.sector as sectortrabajador, worker.fechaalta as altatrabajador, worker.fechabaja as bajatrabajador, e.fcuantia, b.Descripcion as DescripcionBono, b.NumBono, -1 as icodtercero,
			e.campo22 as expcampo22, clicont.nifclicon as nifcontrario, act.inumordenseg, null as peticionfacturado, null as nombremutua, act.cancelada, act.motivocancelacion,
			segfase.fase as nombrefase, segfase.tipo as tipofase, segfase.estado as estadofase, sf.nombre as usuariofase,
			segfase.porcentaje as porcentajefase, segfase.tiempoprevisto as tiempoprevistofase, segfase.realizada as realizadafase, 
			segfase.fechaini as fechainifase, segfase.fechafin as fechafinfase, segfase.fechainireal as fechainirealfase, segfase.fechafinreal as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas, 
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segexp act

            left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
			left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on e.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
            left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
            left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
			left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
			left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
			left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
			left join [[instancia]advabousu[empresa]].dbo.clientes worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.tipobd = 1
			left join [[instancia]advabousu[empresa]].dbo.exclipro  on exclipro.icodcli=worker.icodcli and exclipro.inumexp=act.inumexp and exclipro.iyear=act.iyear
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.inumexp = ap.inumexpSegexp and act.iyear = ap.iyearSegexp and act.dfechaact = ap.dfechaactSegexp and act.linea = ap.lineaSegexp
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.fasesegexp fsexp on act.inumexp = fsexp.inumexp and act.iyear = fsexp.iyear and act.dfechaact = fsexp.dfechaact and act.linea = fsexp.ilinea
			left join [[instancia]advabousu[empresa]].dbo.segfase on fsexp.id_segfase = segfase.id
			left join [[instancia]advabousu[empresa]].dbo.subusu sf on segfase.icodsubusu=sf.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.inumexp and eventos.iyear = act.iyear and lineaact = act.linea and eventos.origen = 1
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')

			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			--[controlhorario]
			where tipohistotr = 1",,inumexp:INT|iyear:INT|dfechaact:DATETIME|linea:INT|fase:int,Expedientes,,,0,,,,,
412,76,Gastos Expedientes,"select distinct tipoficherocli.tipofichero, act.agenda, 1 as origen,
(CAST(act.inumexp as varchar) + '-' + CAST(act.iyear as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
e.expediente as numero,e.expediente, e.estado, c.codigo,act.inumexp as inumexp,e.codcliente as icodcli,act.dfechaact as dfechaact,act.iyear as iyear,
tipoexp.tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,
act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact, c.snombrecli,c.email,act.facturable,act.campo16 as perso88, c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas,e.descripcion,act.tipohistotr,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3,
segfase.id as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16, act.campo17, act.campo18,act.campofecha1,act.campofecha2,act.campofecha3,
act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, act.tiempoprevisto, 
cast(null as varchar) as nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli, e.codsubusu as expusu, itipoexp,e.expediente as numexp, itipoasunto, tipoasun.tipoasunto, null as tipocliente, e.codcontrario, cont.snombreabo as abocontrario, 
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
clicont.snombreclicon as contrario, prop.snombreabo as abopropio, prop.icodabo as codabopropio, c.origen as origencli, 
e.inumexp*CAST(10000 as bigint)+e.iyear as idexp, null as clicampo6,
e.idcentros, centrospredef.sdescripcion as nombrecentro , null as oportunidad, null as zona, procedimiento, e.codproce, null as sfaxcli, null as cargo,
eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, cont.icodabo as codabocontrario, 
(select top (1) codjuzga from [[instancia]advabousu[empresa]].dbo.expjuzga
where expjuzga.numexp=e.inumexp and expjuzga.iyear=e.iyear order by expjuzga.principal desc ) as codjuzga,
(select top (1) juzgado from [[instancia]advabousu[empresa]].dbo.expjuzga 
left outer join [[instancia]advabousu[empresa]].dbo.juzgado on expjuzga.codjuzga=juzgado.codjuzga
where expjuzga.numexp=e.inumexp and expjuzga.iyear=e.iyear order by expjuzga.principal desc ) as juzgado,
e.snumasunto, act.unidad,
worker.codigo as numtrabajador, worker.snombrecli as nombretrabajador, exclipro.estado1 as excliproestado1, exclipro.estado2 as excliproestado2, exclipro.estado3 as excliproestado3, 
exclipro.estado4 as excliproestado4, exclipro.estado5 as excliproestado5, exclipro.estado6 as excliproestado6, '' as origenactu, act.orden,
case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, 
act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli, act.aula, e.codsubusu as codusuficha, s2.nombre as usuarioficha, 
worker.sector as sectortrabajador, worker.fechaalta as altatrabajador, worker.fechabaja as bajatrabajador, e.fcuantia, b.Descripcion as DescripcionBono, b.NumBono, -1 as icodtercero,
e.campo22 as expcampo22, clicont.nifclicon as nifcontrario, act.inumordenseg, null as peticionfacturado, null as nombremutua, act.cancelada, act.motivocancelacion,
segfase.fase as nombrefase, segfase.tipo as tipofase, segfase.estado as estadofase, sf.nombre as usuariofase,
segfase.porcentaje as porcentajefase, segfase.tiempoprevisto as tiempoprevistofase, segfase.realizada as realizadafase, 
segfase.fechaini as fechainifase, segfase.fechafin as fechafinfase, segfase.fechainireal as fechainirealfase, segfase.fechafinreal as fechafinrealfase,
act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre, act.icodprov

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.segexp act
left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu s2 on e.codsubusu=s2.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
left join [[instancia]advabousu[empresa]].dbo.clientes worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.exclipro  on exclipro.icodcli=worker.icodcli and exclipro.inumexp=act.inumexp and exclipro.iyear=act.iyear
left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.inumexp = ap.inumexpSegexp and act.iyear = ap.iyearSegexp and act.dfechaact = ap.dfechaactSegexp and act.linea = ap.lineaSegexp
left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
left join [[instancia]advabousu[empresa]].dbo.fasesegexp fsexp on act.inumexp = fsexp.inumexp and act.iyear = fsexp.iyear and act.dfechaact = fsexp.dfechaact and act.linea = fsexp.ilinea
left join [[instancia]advabousu[empresa]].dbo.segfase on fsexp.id_segfase = segfase.id
left join [[instancia]advabousu[empresa]].dbo.subusu sf on segfase.icodsubusu=sf.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.clientes proveedor on act.icodprov = proveedor.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
left join [[instancia]advabousu[empresa]].dbo.[events] eventos
on eventos.inumexp = act.inumexp and eventos.iyear = act.iyear and lineaact = act.linea and eventos.origen = 1
and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')

--[controlhorario]

where tipohistotr = 2",,inumexp:INT|iyear:INT|dfechaact:DATETIME|linea:INT|fase:int,Expedientes,,,0,,,,,
413,77,Trabajadores,"SELECT 

C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,


C.idcentros,
CEXT.codtercero as icodtercero,
CEXT.backcolor, CEXT.comcomerciales,
isnull(CEXT.estadoLOPD, 0) as estadoLOPD,

-- Campos usados en indicadores (gestorresumen), obligatorios
CR.baja, CR.activo, C.tipofichero

--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef CP on C.idcentros = CP.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
LEFT JOIN [[instancia]advabocom].dbo.gestorcuadro GC on CEXT.idGestorCuadroRendimiento = GC.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (1)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Trabajadores,1,bvertrabajador,0,,,,,
414,78,Terceros,"SELECT 
C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.email,C.stelefonocli,C.telefono2,C.telefono3,C.smovilcli,C.snifcli,
C.sfaxcli,C.sdomiciliocli,C.spoblacioncli,C.sprovinciacli,C.fechaalta, C.fechabaja,
C.tipofichero,C.sNombrePais,C.cuentabanco,C.estadocli,C.scodpostalcli,
DATENAME(MONTH, C.fechaalta) as fechaaltames, DATEPART(YEAR, C.fechaalta) as fechaaltaano,
DATENAME(MONTH, C.fechabaja) as fechabajames, DATEPART(YEAR, C.fechabaja) as fechabajaano,
C.snombreclicomercial, 
C.nie,C.pasaporte,C.tarjetaresidencia,C.campo21,C.campo22,C.campo23,C.campo24,
C.origen,C.zona,C.empresa,C.departamento,C.cargo,C.numempleados,C.sector,
C.fechanacimiento,C.fechapermiso,C.campofecha9,C.campofecha10,
C.campofecha11,C.campofecha12,C.campofecha13,C.campo1,C.campo2,
C.campo3,C.campo4,C.campo5,C.campo6,C.campo7,C.campo8,C.campo9,C.campo10,
C.campo11,C.campo12,C.campo13,C.campo14,C.campo15,C.campo16,C.campo17,
C.campo18,C.campo19,C.campo20,C.campofecha1,C.campofecha2,C.campofecha3,
C.campofecha4,C.campofecha5,C.campofecha6,C.campofecha7,C.campofecha8,
C.perso83,C.perso84,C.perso85,C.perso86,C.perso87,C.perso88,C.persofecha2,
C.persofecha3,C.persofecha4,C.persofecha5,C.persofecha9,C.persofecha7,
C.persofecha6,C.persofecha8,C.perso79,C.perso78,C.perso77,C.perso76,C.perso75,C.perso74,

S.nombre as susuario,
CR.baja,CR.activo,CR.dormidohistorial,CR.dormidoeconomico,CR.totalcobrado,
CR.saldopendiente,CR.saldovencidonocobrado,CR.fechaproximocobro,
CR.totalfacturacion,CR.numactuaciones,CR.tiempoact,CR.totalcosteact,
CR.diassinact,CR.diasultimocobro,CR.diasmorosidad,CR.numactretrasadas,
CR.oportunidadesabiertas,CR.diasactivo,CR.numclientes,
CR.satisfaccion,CR.ultimavaloracion,CR.participacionencuestas,
CR.reclamacion,CR.incidencias,CR.comunicaciones,CR.informespendientes,
CR.ausencias,CR.asistencias,CR.materialpendiente,CR.matriculas,CR.reservas,
CR.totalTratamientos, CR.totalCobrosTratamientos, (coalesce(CR.totalCobrosTratamientos, 0)+coalesce(CR.totalCobrosMutua, 0) - coalesce(CR.totalTratamientos, 0)) as saldoTratamientos,
CR.numCanceladas, CR.numCancelConAviso, CR.numCancelSinAviso, CR.numCancelAplazada, CR.numTotalActuaciones,  
(convert(numeric(5,2),(CR.numCanceladas))/NULLIF (CR.numTotalActuaciones,0))*100 as porcentajeCanceladas,
C.idcentros,centrospredef.sdescripcion as nombrecentro,CR.totalCobrosMutua,

CEXT.codtercero as icodtercero, CEXT.comComerciales, CEXT.backcolor, CEXT.estadoLOPD,

C.ftotalProvisiones, CR.totalCobradoExp, CR.totalProvisionesExp, CR.totalCosteExp,

(ISNULL(CR.totalCobrado,0) + ISNULL(CR.totalCobradoExp,0) + ISNULL(C.ftotalProvisiones,0) 
+ ISNULL(CR.totalProvisionesExp,0) - ISNULL(CR.totalCosteAct,0) - ISNULL(CR.totalCosteExp,0)) as totalBeneficio,

((ISNULL(CR.totalCobrado,0) + ISNULL(CR.totalCobradoExp,0) + ISNULL(C.ftotalProvisiones,0) 
+ ISNULL(CR.totalProvisionesExp,0) - ISNULL(CR.totalCosteAct,0) - ISNULL(CR.totalCosteExp,0))
/
nullif((ISNULL(CR.totalCobrado,0) + ISNULL(CR.totalCobradoExp,0) + ISNULL(C.ftotalProvisiones,0) 
+ ISNULL(CR.totalProvisionesExp,0)),0)* 100) as porcentajeBeneficio,

--CR.obligacionesPendientes, CR.obligacionesRealizadas,
CR.fechaultimaactuacion,CR.fechaproximaactuacion,
CR.descripcionultimaactu,CR.descripcionproximaactu,
CEXT.codmutua as icodmutua,CM.snombrecli as snombremutua

--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CM on CEXT.codmutua = CM.icodcli 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (3)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,ver_otros,3,,1,,,,,
415,79,Mutuas,"SELECT 

C.icodcli,C.tipobd,C.codsubusu,C.fechaalta,

CR.baja,CR.activo,CR.dormidohistorial,
CR.numactuaciones,CR.tiempoact,CR.totalcosteact,
CR.diassinact,CR.diasultimocobro,CR.numactretrasadas,
CR.oportunidadesabiertas,CR.numclientes,
CR.satisfaccion,CR.ultimavaloracion,CR.participacionencuestas,
CR.reclamacion,CR.incidencias,CR.comunicaciones,CR.informespendientes,
CR.ausencias,CR.asistencias,CR.materialpendiente,CR.matriculas,CR.reservas,
CR.totalTratamientos, CR.totalCobrosTratamientos, (coalesce(CR.totalCobrosTratamientos, 0)+coalesce(CR.totalCobrosMutua, 0) - coalesce(CR.totalTratamientos, 0)) as saldoTratamientos,
CR.numCanceladas, CR.numCancelConAviso, CR.numCancelSinAviso, CR.numCancelAplazada, CR.numTotalActuaciones,  
(convert(numeric(5,2),(CR.numCanceladas))/NULLIF (CR.numTotalActuaciones,0))*100 as porcentajeCanceladas,
C.idcentros,centrospredef.sdescripcion as nombrecentro,CR.totalCobrosMutua,C.tipofichero,

c.snombrecli,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,


CEXT.codtercero as icodtercero,CT.snombrecli as snombretercero,
CEXT.backcolor, CEXT.comComerciales, CEXT.estadoLOPD,

C.ftotalProvisiones, CR.totalCobradoExp, CR.totalProvisionesExp, CR.totalCosteExp,

--CR.obligacionesPendientes, CR.obligacionesRealizadas,
CR.fechaultimaactuacion,CR.fechaproximaactuacion,
CR.descripcionultimaactu,CR.descripcionproximaactu,
CEXT.codmutua as icodmutua,CM.snombrecli as snombremutua

--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CM on CEXT.codmutua = CM.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperfil]
--[leftjoinperso]

 
WHERE tipobd in (8)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Aseguradoras,8,bvermutua,0,,,,,
416,4,Alumnos,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
	oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
	oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr,  oporresumen.saldorecobros,
	oporcli.campofecha1,C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
	Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero, C.fechanacimiento,
	cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
	oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
	convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

	--[camposperfil]
	--[camposperso]

	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
	left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
	left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (5)
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
    left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
	left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
	left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
	LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
	--[leftjoinperfil]
	--[leftjoinperso]
 
	where (1 = 1) AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Alumnos,5,bveralumno,0,,,,,
417,80,Compañías,"SELECT 
C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad,
C.idcentros, cext.backcolor,
C.tipofichero,
c.snifcli,
c.smovilcli,
cr.baja as baja, CR.activo, 
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial, CEXT.comComerciales, CEXT.estadoLOPD

--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR on C.icodcli = CR.icodcli
--[leftjoinperso]

WHERE tipobd in (6)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Compañías,6,bvercompania,0,,,,,
418,81,Voluntarios,"SELECT 

C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,

C.idcentros, CP.sdescripcion as nombrecentro, C.edad, 
CEXT.codtercero as icodtercero,
CEXT.backcolor, CEXT.comComerciales, CEXT.estadoLOPD,
CEXT.codmutua as icodmutua, C.notas,

-- Campos usados en indicadores (gestorresumen), obligatorios
CR.baja, CR.activo, C.tipofichero

--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef CP on C.idcentros = CP.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CM on CEXT.codmutua = CM.icodcli 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (10)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Voluntarios,10,bvervoluntarios,0,,,,,
419,82,Financiadores,"SELECT 
C.icodcli,C.tipobd,C.codsubusu,
C.snombrecli,C.fechaalta,
C.inivelprivacidad,
C.idcentros, cext.backcolor, C.tipofichero,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3, CEXT.comComerciales, CEXT.estadoLOPD,

CRES.baja, CRES.activo,
C.ftotalProvisiones, CRES.totalCobrado,CRES.totalCobradoExp, CRES.totalProvisionesExp, 
(ISNULL(CRES.totalCobrado,0) + ISNULL(CRES.totalCobradoExp,0) + ISNULL(C.ftotalProvisiones,0) 
+ ISNULL(CRES.totalProvisionesExp,0) - ISNULL(CRES.totalCosteAct,0) - ISNULL(CRES.totalCosteExp,0)) as totalBeneficio,
(ISNULL(CRES.saldovencidonocobrado, 0) + ISNULL(CRES.saldoVencidoNoCobradoExp, 0))  as saldovencidonocobrado
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CRES on C.icodcli = CRES.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef as CP on C.idcentros = CP.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CM on CEXT.codmutua = CM.icodcli    
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

--[leftjoinperso]

WHERE tipobd in (11)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Financiadores,11,bVerFinancieras,0,,,,,
420,83,Tutores,"SELECT 

	C.icodcli,C.tipobd,C.codsubusu,
	C.snombrecli,C.fechaalta,
	C.inivelprivacidad, C.edad, 
	c.snifcli,
	c.smovilcli,
	c.stelefonocli,
	c.telefono2,
	c.telefono3,
	c.snombreclicomercial,


	C.idcentros,
	CEXT.codtercero as icodtercero,
	CEXT.backcolor, CEXT.comComerciales, CEXT.codmutua as icodmutua, CEXT.estadoLOPD,
	C.tipofichero,

	-- Campos usados en indicadores (gestorresumen), obligatorios
	CR.baja, CR.activo

	--[camposperfil]
	--[camposperso]

	FROM [[instancia]advabousu[empresa]].dbo.clientes C
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef CP on C.idcentros = CP.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CM on CEXT.codmutua = CM.icodcli
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasiva on cuentasiva.numcta = C.ctaiva
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoiva iva on cuentasiva.idiva = iva.idiva
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva civa on cuentasiva.claseiva = civa.idclaseiva
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] cuentasirpf on cuentasirpf.numcta = C.ctairpf
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoirpf irpf on cuentasirpf.idirpf = irpf.idirpf
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseirpf cirpf on cuentasirpf.tipoirpf = cirpf.id

	--[leftjoinperfil]
	--[leftjoinperso]

	WHERE tipobd in (7)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Tutores,7,bvermascota,0,,,,,
421,84,Valoraciones actuaciones cliente,"SELECT val.id, val.actuacion, val.tipoActuacion, val.puntuacion, val.mail, CAST(CAST(val.fecha AS DATE) AS DATETIME) as fecha, val.ip, val.publicar, val.comentario, val.idExterno,  val.fechaRespuesta, val.respuesta, val.publicadoWeb, 1 - ISNULL(val.pendienteSincronizacion, 0) as sincronizado, val.eliminado,  c.icodcli as codigoCliente, c.icodcli as icodcli, c.snombrecli as nombreCliente, act.sactuacion, su.icodsubusu, su.nombre as nombreUsuario, act.fecharealizacion, NULL as idexp, act.subusu,  
CASE ISNULL(val.publicadoWeb, 0) WHEN 0 THEN @{'No'} WHEN 1 THEN @{'Sí'} WHEN 2 THEN @{'Sí, en anónimo'} END as publicadoWebTexto, 
CASE val.publicar WHEN 0  THEN @{'No'} ELSE @{'Sí'} END as publicadotexto  --[camposperfil]  
FROM [[instancia]advabousu[empresa]].dbo.ValoracionActuacionCliente val  
INNER JOIN [[instancia]advabousu[empresa]].dbo.segcli act ON act.id = val.actuacion AND val.tipoActuacion = 5  
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = act.icodcli  
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su ON su.icodsubusu = act.subusu  --[leftjoinperfil]   
WHERE idExterno > 0 and (eliminado IS NULL OR eliminado = 0)",,id:INT,Valoraciones,,,0,,,,,
422,84,Valoraciones actuaciones expediente,"SELECT val.id, val.actuacion, val.tipoActuacion, val.puntuacion, val.mail, CAST(CAST(val.fecha AS DATE) AS DATETIME) as fecha, val.ip, val.publicar, val.comentario, val.idExterno,  val.fechaRespuesta, val.respuesta, val.publicadoWeb, 1 - ISNULL(val.pendienteSincronizacion, 0) as sincronizado, val.eliminado,  c.icodcli as codigoCliente,c.icodcli as icodcli, c.snombrecli as nombreCliente, act.sactuacion, su.icodsubusu, su.nombre as nombreUsuario, act.fecharealizacion, convert(varchar(50), act.inumexp) + '&' +  convert(varchar(50), act.iyear) as idexp, act.subusu,  
CASE ISNULL(val.publicadoWeb, 0) WHEN 0 THEN @{'No'} WHEN 1 THEN @{'Sí'} WHEN 2 THEN @{'Sí, en anónimo'} END as publicadoWebTexto, 
CASE val.publicar WHEN 0  THEN @{'No'} ELSE @{'Sí'} END as publicadotexto  --[camposperfil]  
FROM [[instancia]advabousu[empresa]].dbo.ValoracionActuacionCliente val  
INNER JOIN [[instancia]advabousu[empresa]].dbo.segexp act ON act.id = val.actuacion AND val.tipoActuacion = 1  
INNER JOIN [[instancia]advabousu[empresa]].dbo.expedien e ON act.iyear = e.iyear AND act.inumexp = e.inumexp  
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = e.codcliente  
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su ON su.icodsubusu = act.subusu   --[leftjoinperfil]  
WHERE idExterno > 0 and (eliminado IS NULL OR eliminado = 0)",,id:INT,Valoraciones,,,0,,,,,
423,85,Facturas Recibidas,"SELECT cg.id, cg.fecha, cg.ejercicio, cg.numfactura, cg.tipofact, cg.icodcli, cg.codsubusu as usuario, exp.inumexp, exp.iyear, cg.nifcli, cg.backcolor, cg.idtipofact as idTipoFactura, cg.idtiporect as idTipoRectificacion, cg.totaldctoeuro, prov.tipofichero,
case when cg.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, cg.subusucre as icodCreador
,CASE WHEN cg.tipoGasto = 1 THEN cg.total ELSE cg.baseimp END AS baseimp
,CASE WHEN cg.tipoGasto = 1 THEN cg.baseimp ELSE cg.total END AS total, cg.totalpagos
FROM [[instancia]advabousu[empresa]].dbo.contagastos cg 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu usu ON usu.icodsubusu = cg.codsubusu 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes prov ON prov.tipobd = 9 AND prov.icodcli = cg.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporcli o on cg.icodopor = o.icodopor 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien exp on cast(exp.inumexp as varchar) = isnull(cg.expedienteasociado, o.inumexp) and  cast(exp.iyear as varchar) = isnull(cg.anoasociado, o.iyear)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tiposfactura tfact ON tfact.id = cg.idtipofact
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tiposrectificacion rect ON rect.id = cg.idtiporect
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = cg.subusucre
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef centro on centro.id = cg.idcentros
WHERE tipofact IS null ",select notas as notas1 from contagastos,id:INT,Facturas Recibidas,,,,,,,,
424,86,Clientes,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso, oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre,
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev, oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor, 
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea  
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (0)  
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado 
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext 
	ON facext.icodopor = oporcli.icodopor   
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
    left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision

	--[leftjoinperfil]
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Clientes,0,,0,," from [[instancia]advabousu[empresa]].dbo.oporcli left join subusu on subusu.icodsubusu = oporcli.icodusu
inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli and tipobd in ([tabla])
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id",,,
425,86,Clientes Potenciales,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, 
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev,   oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,     
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea   
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (2)  
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext
	ON facext.icodopor = oporcli.icodopor 
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
    left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
   
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Clientes Potenciales,2,,0,,,424,,
426,86,Terceros,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, 
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev,   oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,     
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea    
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (3)
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado 
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext 
	ON facext.icodopor = oporcli.icodopor 
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
    left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
    
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|linea:INT|icodopor:INT|dfecha:DATETIME,EtiqTercerosProp,3,,1,,,424,,
427,86,Alumnos,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, 
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev,   oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,     
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea    
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (5)
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext 
	ON facext.icodopor = oporcli.icodopor 
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
     
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Alumnos,5,bveralumno,0,,,424,,
429,87,Registro Horario,"select distinct (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
act.id,
act.dfechaact,
act.linea,
act.sactuacion,
act.horainiact,
act.horafinact,
act.tiempo,
act.icodcli,
act.subusu,
act.fecharealizacion,
act.dfechanotificacion,
cli.snombrecli,
act.tipohistotr,
act.tipo,
s.nombre as nomsubusu,
cx.dpto,
cli.idcentros
from [[instancia]advabousu[empresa]].dbo.segcli act 
inner join [[instancia]advabousu[empresa]].dbo.clientes cli on act.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientesext cx on cx.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu = s.icodsubusu

--[controlhorario]

where tipo = 'Control Horario'",,icodcli:INT|dfechaact:DATETIME|linea:INT,Jornada Cliente,,,0,,,,,
430,86,Trabajadores,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, 
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev,   oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,     
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea    
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (1)
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu		
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext
	ON facext.icodopor = oporcli.icodopor  
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
    
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Trabajadores,1,bvertrabajador,0,,,424,,
431,86,Financiadores,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, 
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev,   oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,     
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea    
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (11) 
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu		
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext 
	ON facext.icodopor = oporcli.icodopor 
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
      
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Financiadores,11,bVerFinancieras,0,,,424,,
432,88,Informe Control Horario,"SELECT * , MARCAFROM FROM ((select distinct (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
	act.id,
	act.dfechaact,
	act.linea,
	act.sactuacion,
	act.horainiact,
	act.horafinact,
	act.horaEntrada,
	act.tiempo,
	act.icodcli,
	act.subusu,
	act.fecharealizacion,
	act.dfechanotificacion,
	cli.snombrecli,
	act.tipohistotr,
	act.tipo,
	s.nombre as nomsubusu,
	cx.dpto, 0 as horasprevistas
	,cli.idcentros
	from  [[instancia]advabousu[empresa]].dbo.segcli act 
	inner join [[instancia]advabousu[empresa]].dbo.clientes cli on act.icodcli=cli.icodcli
	left join [[instancia]advabousu[empresa]].dbo.clientesext cx on cx.icodcli=cli.icodcli
	left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu = s.icodsubusu

	--[controlhorario]

	where tipo = 'Control Horario' 
)	
	UNION ALL
(
	SELECT  '-' as idAct, 0 As int, fecha AS dfechaact, -1 AS linea, '' AS sactuacion, null AS horainiact, null AS horafinact, null AS horaEntrada, 0 AS tiempo, tur.icodcli, cli.CodSubUSu As subusu,
	fecha AS fecharealizacion, null AS dfechanotificacion, cli.snombrecli, null AS tipohistotr, null AS tipo, '' AS nomsubusu, '' AS dpto, sum(tur.tiempo) as horasprevistas
	,cli.idcentros
	from [[instancia]advabousu[empresa]].dbo.turnos tur 
	inner join [[instancia]advabousu[empresa]].dbo.clientes cli on tur.icodcli=cli.icodcli
	WHERE tur.disponibilidad = 1
	GROUP BY fecha, tur.icodcli, cli.snombrecli, cli.CodSubUSu,cli.idcentros 
	)) tabla WHERE 1 =1",,icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Control Horario,,,0,,,,,
433,89,Informe de Progreso,"select oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,oporcli.icodusu as icodusu, 
		oporcli.ordenprioridad, oporcli.porprogreso, oporcli.icodpro,oporcli.estado,oporcli.etapa,
		oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, oporcli.importecierre,
		oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, 
		oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, r.saldorecobros, 
		oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev, oporcli.tipooportunidad, 
		oporcli.fechaseguimiento, oporcli.horaseguimiento, SU2.nombre as apoyoresponsable, oporcli.campo18, 
		oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,
		cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000 else case when fechacierre is null then convert( int, datediff(day, getdate(), oporcli.campofecha1))
		 else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, 
		(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, e.expediente, e.inumexp, e.iyear, e.descripcion
		, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
		--[camposperfil]  
		from [[instancia]advabousu[empresa]].dbo.oporcli  
		left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
		inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (0)  
		left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
		left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
		left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
		left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
		left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
		left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
		left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor   
		left join [[instancia]advabousu[empresa]].dbo.expedien e on oporcli.inumexp = e.inumexp and oporcli.iyear = e.iyear 
		where (1 = 1) AND tipooportunidad=1 AND etapa like '%En Curso%'","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Informe de Progreso,,,0,,0,,,
434,90,Informe de Desviaciones,"select oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,oporcli.icodusu as icodusu, 
		oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,oporcli.etapa,
		oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, oporcli.importecierre,
		oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, 
		oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, r.saldorecobros, 
		oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev, oporcli.tipooportunidad, 
		oporcli.fechaseguimiento, oporcli.horaseguimiento, SU2.nombre as apoyoresponsable, oporcli.campo18, 
		oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,
		cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000 else case when fechacierre is null then convert( int, datediff(day, getdate(), 
		oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad,
		(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, e.expediente, e.inumexp, e.iyear, e.descripcion
		, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
		--[camposperfil]  
		from [[instancia]advabousu[empresa]].dbo.oporcli  
		left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
		inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (0)  
		left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
		left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
		left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
		left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
		left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
		left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
		left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor 
		left join [[instancia]advabousu[empresa]].dbo.expedien e on oporcli.inumexp = e.inumexp and oporcli.iyear = e.iyear  
		where (1 = 1) AND tipooportunidad=1 AND estado like '%Cerrada%'","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Informe de Desviaciones,,,0,,0,,,
435,91,Informe Hoja de Tiempos,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
		(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
		act.icodcli as numero, e.expediente, o.estado as estadooporcli, c.codigo, e.inumexp, act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, tipoexp.tipoexp as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
		act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
		act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
		s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
		act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, tipoexp.codigo as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
		, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, CAST(e.inumexp as varchar) + CAST(e.iyear as varchar) as idexp , c.campo6 as clicampo6 ,
		c.idcentros, centrospredef.sdescripcion as nombrecentro, o.oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
		eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
		case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
		null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
		case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
		act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
		act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
		act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
		act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
		act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
		c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
		case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
		case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
		case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
		(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
		where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
		null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
		null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
		null as porcentajefase, null as tiempoprevistofase, null as realizadafase, o.tipo as tipoopor, o.fuente, o.etapa, o.tiempoprev, 
		null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
		act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre,
		r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
		--[camposperfil]
		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
		left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
		left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
		left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
		left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
		left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
		left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
		left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
		left join [[instancia]advabousu[empresa]].dbo.expedien e on o.inumexp = e.inumexp and o.iyear = e.iyear
		left join [[instancia]advabousu[empresa]].dbo.tipoexp on tipoexp.codigo=e.itipoexp
		left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
		left join [[instancia]advabousu[empresa]].dbo.[events] eventos
		on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
		and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
		--[leftjoinperfil]
		--[controlhorario]
		where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Hoja de Tiempos,5,,0,,,,,
436,73,Historial Trabajadores,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact,e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (1) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]
			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Trabajadores,1,,0,,,408,,
437,73,Historial Clientes Potenciales,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (2) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Clientes Potenciales,2,,0,,,408,,
438,73,Historial Terceros,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact,e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (3) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Terceros,3,,0,,,408,,
439,73,Historial Pacientes,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
		
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (4) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Pacientes,4,bverpaciente,0,,,408,,
440,73,Historial Alumnos,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
	
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (5) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Alumnos,5,bveralumno,0,,,408,,
441,73,Historial Compañias,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos

			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (6) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Compañias,6,bvercompania,0,,,408,,
442,73,Historial Mascotas,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]

			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (7) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Mascotas,7,bvermascota,0,,,408,,
443,73,Historial Aseguradoras,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (8) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Aseguradoras,8,bvermutua,0,,,408,,
444,73,Historial Proveedores,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (9) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Proveedores,9,bverproveedor,0,,,408,,
445,73,Historial Voluntarios,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (10) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Voluntarios,10,bvervoluntarios,0,,,408,,
446,73,Historial Financiadores,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (11) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Financiadores,11,bVerFinancieras,0,,,408,,
447,73,Historial Tercera Edad,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
			(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
			act.icodcli as numero, e.expediente, null as estado,c.codigo,null as inumexp,act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear,cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
			act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
			act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
			s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion,act.tipohisto,e.srefabogado as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
			act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
			case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
			case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
			case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
			, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
			c.idcentros, centrospredef.sdescripcion as nombrecentro, (select oportunidad from [[instancia]advabousu[empresa]].dbo.oporcli where oporcli.icodopor = act.icodopor) as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
			eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
			case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
			null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
			case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
			act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
			act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
			act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
			act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
			act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
			c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
			case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
			case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
			case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
			(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
			where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
			null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
			null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
			null as porcentajefase, null as tiempoprevistofase, null as realizadafase,
			null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
			act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
			,costetrabajador.sdescripcion as descriptarifa, CONVERT( VARCHAR(MAX),act.notas) as notas,
			case when act.acturealizada = 1 and act.tipohistotr = 1 then isnull(act.preciocoste,0)
		else 0 end as sumcostesegclinogastos
			
			--[camposperfil]
			
			from [[instancia]advabousu[empresa]].dbo.segcli act

			inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (12) 
			left join [[instancia]advabousu[empresa]].dbo.oporcli o ON o.icodopor = act.icodopor
			left join [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
			left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
			left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
			left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
			left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
			left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
			left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
			left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
			
			left join [[instancia]advabousu[empresa]].dbo.[events] eventos
			on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
			and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
			left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
			
			--[leftjoinperfil]
			--[controlhorario]

			where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Tercera Edad,12,bverterceraedad,0,,,408,,
448,86,Pacientes,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, 
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev,   oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,     
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea    
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (4)  
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext 
	ON facext.icodopor = oporcli.icodopor  
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
   
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Pacientes,4,bverpaciente,0,,,424,,
449,86,Expedientes,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso, oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre,
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev,
	ISNULL(r.sumTiempoTR, 0) as sumtiempotr, r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev, oporcli.tipooportunidad,
	oporcli.fechaseguimiento, oporcli.horaseguimiento, SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev,
	convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, expedien.descripcion as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, tipoexp.tipoexp as tipoexpedien, expedien.itipoexp, ta.codigo as tipoasun, oporcli.idcentro, expedien.sdirArq, expedien.spobArq, expedien.descripcion as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea  
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]
	--[camposperso]
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
	inner join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
	left join [[instancia]advabousu[empresa]].dbo.tipoasun ta on expedien.itipoasunto = ta.codigo
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
	left join [[instancia]advabousu[empresa]].dbo.subusu usuexp on usuexp.icodsubusu = expedien.codsubusu
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	left join [[instancia]advabousu[empresa]].dbo.expedienresumen er on er.inumexp = expedien.inumexp and er.iyear = expedien.iyear
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext
	ON facext.icodopor = oporcli.icodopor    
	left join tipoexp on expedien.itipoexp = tipoexp.codigo
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision

	--[leftjoinperfil]
	--[leftjoinperso]
	where tipooportunidad=1 AND inumexpOpor IS NOT NULL AND iyearOpor IS NOT NULL","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Expedientes,,,0,,,,,
450,58,Trabajadores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu,
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 

 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (1)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Trabajadores,1,bvertrabajador,0,,,,,
451,92,Informe Horas de Tareas,"SELECT act.icodcli, act.dfechaact, act.linea, act.tipohistotr, act.fecharealizacion, act.sactuacion, act.tipo as tipoActu, act.tiempo, su1.icodsubusu as subusu 
		, su1.nombre as nomsubusu, o.oportunidad, o.etapa, c.snombrecli, e.descripcion, o.clase, act.acturealizada, o.dfecha, o.fechafinprev, o.fechacierre, o.sprint 
		, o.tipo as tipoTarea, o.fuente, su2.nombre as usuTarea, o.estado as estadoTarea, e.expediente, e.iyear, o.icodopor 
		, ISNULL(o.tiempoprev, 0) as tiempoprev, ISNULL(o.porprogreso, 0) as porprogreso, ISNULL(r.sumTiempotr, 0) as sumtiempotr 
		, CASE WHEN ISNULL(o.porprogreso, 0) = 0 THEN 0 ELSE 
			cast(r.sumtiempotr as float) / (cast(o.porprogreso as float) / 100) - cast(o.tiempoprev as float) END as desviaciontiempo 
		, CASE WHEN (ISNULL(r.sumtiempotr, 0) = 0 OR ISNULL(o.tiempoprev, 0) = 0 OR ISNULL(o.porprogreso, 0) = 0) THEN 0 
			ELSE round((cast(r.sumtiempotr as float) / (cast(o.tiempoprev as float) * (cast(o.porprogreso as float) / 100)) * 100), 0) END as porcendesviaciontiempo 
		FROM [[instancia]advabousu[empresa]].dbo.segcli act 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON act.subusu = su1.icodsubusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporcli o ON act.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON o.icodusu = su2.icodsubusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON o.icodopor = r.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON act.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien e ON o.inumexp = e.inumexp AND o.iyear = e.iyear

		--[controlhorario]

		where tipohistotr = 1",,icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Horas de Tareas,,,0,,0,,,
452,93,Clientes,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, null as descripcionexp, o.fuente 
		, null as expediente, null as iyearexp, null as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, cast(null as varchar) as tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli AND c.tipobd = 0 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id 
		--[leftjoinperfil] 
		--[leftjoinperso]
		--[oporcontrolhorario] 
		WHERE tipooportunidad = 1 AND inumexpopor IS NULL AND iyearopor IS NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Clientes,,,0,,0,,,
453,93,Expedientes,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, e.descripcion as descripcionexp, o.fuente 
		, e.expediente, e.iyear as iyearexp, e.inumexp*CAST(10000 as bigint)+e.iyear as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, tipoexp.tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.expedien e ON o.inumexp = e.inumexp and o.iyear = e.iyear
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		left join [[instancia]advabousu[empresa]].dbo.expedienresumen er on er.inumexp = e.inumexp and er.iyear = e.iyear
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id  
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
		--[leftjoinperfil] 
		--[leftjoinperso] 
		--[oporcontrolhorario]
		WHERE tipooportunidad = 1 AND inumexpopor IS NOT NULL AND iyearopor IS NOT NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Expedientes,,,0,,0,,,
454,93,Trabajadores,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, null as descripcionexp, o.fuente 
		, null as expediente, null as iyearexp, null as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, cast(null as varchar) as tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli AND c.tipobd = 1 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id 
		--[leftjoinperfil] 
		--[leftjoinperso] 
		--[oporcontrolhorario]
		WHERE tipooportunidad = 1 AND inumexpopor IS NULL AND iyearopor IS NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Trabajadores,,,0,,0,,,
455,93,Clientes Potenciales,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, null as descripcionexp, o.fuente 
		, null as expediente, null as iyearexp, null as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, cast(null as varchar) as tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli AND c.tipobd = 2 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id 
		--[leftjoinperfil] 
		--[leftjoinperso] 
		--[oporcontrolhorario]
		WHERE tipooportunidad = 1 AND inumexpopor IS NULL AND iyearopor IS NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Clientes Potenciales,,,0,,0,,,
456,93,Terceros,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, null as descripcionexp, o.fuente 
		, null as expediente, null as iyearexp, null as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, cast(null as varchar) as tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli AND c.tipobd = 3 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id 
		--[leftjoinperfil] 
		--[leftjoinperso] 
		--[oporcontrolhorario]
		WHERE tipooportunidad = 1 AND inumexpopor IS NULL AND iyearopor IS NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Terceros,,,0,,0,,,
457,93,Pacientes,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, null as descripcionexp, o.fuente 
		, null as expediente, null as iyearexp, null as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, cast(null as varchar) as tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli AND c.tipobd = 4 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id 
		--[leftjoinperfil] 
		--[leftjoinperso] 
		--[oporcontrolhorario]
		WHERE tipooportunidad = 1 AND inumexpopor IS NULL AND iyearopor IS NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Pacientes,,,0,,0,,,
458,93,Alumnos,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, null as descripcionexp, o.fuente 
		, null as expediente, null as iyearexp, null as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, cast(null as varchar) as tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli AND c.tipobd = 5 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id 
		--[leftjoinperfil] 
		--[leftjoinperso] 
		--[oporcontrolhorario]
		WHERE tipooportunidad = 1 AND inumexpopor IS NULL AND iyearopor IS NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Alumnos,,,0,,0,,,
459,93,Financiadores,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.tipooportunidad, o.inumexp as inumexpopor, o.iyear as iyearopor 
		, o.oportunidad, o.fechacierre, c.idcentros, o.icodusu as subusu, o.creadopor, o.codusuapoyo, su1.nombre as nomsubusu 
		, isnull(o.etapa,'') as etapa, o.estado as estadoTarea, o.clase, o.sprint, c.snombrecli, o.tipo, null as descripcionexp, o.fuente 
		, null as expediente, null as iyearexp, null as idexp, o.tiempoprev, r.sumtiempotr, o.porprogreso
		, cast(tiempoprev as float) * (cast(porprogreso as float)/100) as tiemporealprev, o.puntos, 
		TAR.descripcion as descripcionTarea, o.backcolor, cast(null as varchar) as tipoexp
		--[camposperfil]
		--[camposperso]
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON c.icodcli = o.icodcli AND c.tipobd = 11 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON cext.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen cr ON cr.icodcli = c.icodcli 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su3 ON su3.icodsubusu = o.codusuapoyo 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen r ON r.icodopor = o.icodopor 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoficherocli tf ON tf.tipobd = c.tipobd 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef cp ON cp.id = c.idcentros 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON o.idSubtareaAccion = ST.id
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id 
		--[leftjoinperfil] 
		--[leftjoinperso] 
		--[oporcontrolhorario]
		WHERE tipooportunidad = 1 AND inumexpopor IS NULL AND iyearopor IS NULL",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Financiadores,,,0,,0,,,
460,57,Trabajadores,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
	f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
	case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
	isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
	f.origen,f.inumexp,f.iyear,f.tipologia1,
	f.tipologia2,f.tipologia3,
	f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
	isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
	isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
	f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
	cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
	null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
	case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
	convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
	subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
	(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

	--[camposperfil]

	, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
	left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
	left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
	inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (1)
	left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
	as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact) as fvto  
	on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact	
	--[leftjoinperfil]
	where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)

	where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Trabajadores,1,bvertrabajador,0,,,,,
461,57,Proveedores,"select fvto.pfechavto as fvtoprof,f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
	f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
	case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.TotACuenta=0 or (f.TotACuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.TotACuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado,
	isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
	f.origen,f.inumexp,f.iyear,f.tipologia1,
	f.tipologia2,f.tipologia3,
	f.backcolor,f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
	isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
	isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
	f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
	cli.icodcli,cli.estadocli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,
	null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon, null as inumexpediente, null as iyearexpediente,
	case when (cli.tipobd = 0) then 'Cliente' when (cli.tipobd = 1) then 'Trabajador' when (cli.tipobd = 2) then 'Potencial' when (cli.tipobd = 3) then 'Tercero' when (cli.tipobd = 4) then 'Paciente' when (cli.tipobd = 5) then 'Alumno' when (cli.tipobd = 6) then 'Compañía' when (cli.tipobd = 7) then 'MascotaTutor' when (cli.tipobd = 8) then 'Mutua' when (cli.tipobd = 9) then 'Proveedor' when (cli.tipobd = 10) then 'Voluntario' when (cli.tipobd = 11) then 'Financiador' when (cli.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
	convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
	subusu.nombre as nomsubusu, fac.fecha as fechaFactura,
	(CONVERT(varchar(50),f.inumfactura) + '|' + CONVERT(varchar(10),f.yearfact) + '|' + CONVERT(varchar(5),f.tipoprof)) as idlineaprof

	--[camposperfil]

	, MARCAFROM from  [[instancia]advabousu[empresa]].dbo.proforma f
	left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
	left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
	inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (9)
	left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, min(p.fecha) 
	as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=2 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact) as fvto  
	on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact
	--[leftjoinperfil]
	where (f.inumexprelacionado is null) or (f.inumexprelacionado = -1)	

	where tipoprof=1","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Proveedores,9,bverproveedor,0,,,,,
462,58,Proveedores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 

 f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, null as itipoexp, null as tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (9)

--[leftjoinperfil]

where tipoprof=3 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Proveedores,9,bverproveedor,0,,,,,
463,59,Trabajadores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (1)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Trabajadores,1,bvertrabajador,0,,,,,
464,59,Proveedores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (9)

--[leftjoinperfil]

where tipoprof=4 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Proveedores,9,bverproveedor,0,,,,,
465,60,Trabajadores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof, f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (1)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Trabajadores,1,bvertrabajador,0,,,,,
466,60,Proveedores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof, f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente, null as descripexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado,f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (9)
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Proveedores,9,bverproveedor,0,,,,,
467,61,Trabajadores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (1)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Trabajadores,1,bvertrabajador,0,,,,,
468,61,Proveedores,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, null as inumexpediente, null as iyearexpediente,
convert(varchar(50), f.inumexp) + '&' +  convert(varchar(50), f.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado
from [[instancia]advabousu[empresa]].dbo.proforma f
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' and cli.tipobd in (9)
where tipoprof=5 and (inumexprelacionado is null or inumexprelacionado = -1)","select notas, notas2, notas3, notas4, notas5, notas6 from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Proveedores,9,bverproveedor,0,,,,,
469,94,Bases de Datos,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.inumexp, o.iyear, o.tipooportunidad, o.icodusu, o.fechafinprev, o.fechacierre
	, o.oportunidad, o.tipo, o.etapa, o.estado, pro.snombrecli as nombreProveedor, aso.snombrecli as nombreAsociado, null as descripcionExp
	, null as numExp, null as srefabogado, su1.icodsubusu as codigoUsuario, su1.nombre as nombreUsuario, su2.nombre as nombreCreador, o.serie, o.numopor,o.backcolor, o.idcentro
	, t.numfactura as numfactura, t.ejercicio as ejercicio, t.origenFact as origenFact, t.total 
	--[camposperso]
	, MARCAFROM FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
	INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes pro ON pro.icodcli = o.icodcli 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = o.icodcliRelacionado 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef centrocompra on o.idcentro = centrocompra.id   
	LEFT JOIN  (SELECT frp.icodopor, lc.baseimponible - lc.totaldctoeuro as total, max(ct.numfactura) as numfactura, max(ct.ejercicio) as ejercicio,
case when max(isnull(ct.tipofact,0)) = 3
then upper('a')+'lbarán' else upper('f')+'actura' end as [origenfact]
FROM [[instancia]advabousu[empresa]].dbo.facturaRecibidaParcialOporcli frp 
INNER JOIN [[instancia]advabousu[empresa]].dbo.linecontagastos lc ON frp.lineaLinea = lc.idlinea AND frp.fechaCuenta = lc.fecha 
INNER JOIN [[instancia]advabousu[empresa]].dbo.contagastos ct ON frp.icodcliCuenta = ct.icodcli AND frp.fechaCuenta = ct.fecha AND lc.id = ct.id 
 where frp.icodopor is not null 
group by frp.icodopor, lc.baseimponible, lc.totaldctoeuro ) t on t.icodopor = o.icodopor	
	--[leftjoinperso]
	WHERE tipooportunidad = 2 and inumexp is null",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Bases de Datos,,,0,,0,,,
470,95,Terceros,"select 1 as unidad,com.id,com.backcolor,cli.snombrecli as nombreCliente,com.icodcli,com.inumexp, com.iyear, convert(varchar(50), com.inumexp) + '&' +  convert(varchar(50), com.iyear) as idexp,
e.descripcion, e.srefabogado,  com.idprevcobros,com.serierelacionado,com.fecha as fechaalta,com.fechaliquidacion,com.concepto,  
com.baseimponible,com.poriva,com.porirpf,com.totaliva,com.totalirpf,(ISNULL(com.totaliva,0) - ISNULL(com.totalirpf,0) + ISNULL(com.baseimponible,0)) as total,com.estado,   
case when com.tipoliquidacion = 0 then UPPER('C') + 'obro' when com.tipoliquidacion = 1 then UPPER('F') + 'actura' else UPPER('M') + 'anual' end as tipoliquidacion, 
com.tipoliquidacion as itipo, com.yearfactrelacionado, com.inumfacturarelacionado, com.subusufactrelacionado,   su.nombre as usuarioexp, com.idcomisionista,com.tipocomision, 
CASE WHEN (com.iyear <= 0) THEN clicom2.snombrecli ELSE clicom.snombrecli end as nombreclienteexpediente,
tipoexp.tipoexp as tipoexpedien, case when e.iyear < 0 then '' else convert(varchar,e.expediente) + '/' + CONVERT(varchar,e.iyear) end as expyearnum,
case when f.inumfactura is null then null else isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) end as baseimp,
CASE WHEN com.inumfacturarelacionado IS NOT NULL THEN CAST(com.inumfacturarelacionado AS VARCHAR) + '/' + CAST(com.yearfactrelacionado AS VARCHAR) ELSE NULL END as factura
from [[instancia]AdvAboUsu[empresa]].dbo.comision com 
inner join [[instancia]AdvAboUsu[empresa]].dbo.clientes cli on com.icodcli = cli.icodcli and cli.tipobd in (3)    
left  join [[instancia]AdvAboUsu[empresa]].dbo.expedien e on com.inumexp = e.inumexp and com.iyear = e.iyear 
left join [[instancia]AdvAboUsu[empresa]].dbo.subusu su on e.codsubusu = su.icodsubusu
left join [[instancia]AdvAboUsu[empresa]].dbo.comisionista cm on com.idcomisionista = cm.id
left join [[instancia]AdvAboUsu[empresa]].dbo.linecontagastos l on l.idlinea = com.idLineContagastos
left join [[instancia]AdvAboUsu[empresa]].dbo.clientes clicom on com.iyear > 0 and e.codcliente = clicom.icodcli
left join [[instancia]AdvAboUsu[empresa]].dbo.clientes clicom2 on com.iyear <= 0 and com.inumexp = clicom2.icodcli
left join [[instancia]AdvAboUsu[empresa]].dbo.oporcli opor on opor.idcomision = com.id
left join [[instancia]AdvAboUsu[empresa]].dbo.tipoexp on tipoexp.codigo = e.itipoexp
left join [[instancia]AdvAboUsu[empresa]].dbo.facturas f on f.yearfact = com.yearfactrelacionado and f.inumfactura = com.inumfacturarelacionado and f.codsubusu = com.subusufactrelacionado and f.serie = com.serierelacionado",,id:INT,Terceros,,,0,,,,,
471,95,Trabajadores,"select 1 as unidad,com.id,com.backcolor,cli.snombrecli as nombreCliente,com.icodcli,com.inumexp, com.iyear, convert(varchar(50), com.inumexp) + '&' +  convert(varchar(50), com.iyear) as idexp,
e.descripcion, e.srefabogado,  com.idprevcobros,com.serierelacionado,com.fecha as fechaalta,com.fechaliquidacion,com.concepto,  
com.baseimponible,com.poriva,com.porirpf,com.totaliva,com.totalirpf,(ISNULL(com.totaliva,0) - ISNULL(com.totalirpf,0) + ISNULL(com.baseimponible,0)) as total,com.estado,  
case when com.tipoliquidacion = 0 then UPPER('C') + 'obro' when com.tipoliquidacion = 1 then UPPER('F') + 'actura' else UPPER('M') + 'anual' end as tipoliquidacion, 
com.tipoliquidacion as itipo, com.yearfactrelacionado, com.inumfacturarelacionado, com.subusufactrelacionado,   su.nombre as usuarioexp, com.idcomisionista,com.tipocomision, 
CASE WHEN (com.iyear <= 0) THEN clicom2.snombrecli ELSE clicom.snombrecli end as nombreclienteexpediente,
tipoexp.tipoexp as tipoexpedien, case when e.iyear < 0 then '' else convert(varchar,e.expediente) + '/' + CONVERT(varchar,e.iyear) end as expyearnum,
case when f.inumfactura is null then null else isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) end as baseimp,
CASE WHEN com.inumfacturarelacionado IS NOT NULL THEN CAST(com.inumfacturarelacionado AS VARCHAR) + '/' + CAST(com.yearfactrelacionado AS VARCHAR) ELSE NULL END as factura
from [[instancia]AdvAboUsu[empresa]].dbo.comision com 
inner join [[instancia]AdvAboUsu[empresa]].dbo.clientes cli on com.icodcli = cli.icodcli and cli.tipobd in (1)    
left  join [[instancia]AdvAboUsu[empresa]].dbo.expedien e on com.inumexp = e.inumexp and com.iyear = e.iyear 
left join [[instancia]AdvAboUsu[empresa]].dbo.subusu su on e.codsubusu = su.icodsubusu
left join [[instancia]AdvAboUsu[empresa]].dbo.comisionista cm on com.idcomisionista = cm.id
left join [[instancia]AdvAboUsu[empresa]].dbo.linecontagastos l on l.idlinea = com.idLineContagastos
left join [[instancia]AdvAboUsu[empresa]].dbo.clientes clicom on com.iyear > 0 and e.codcliente = clicom.icodcli
left join [[instancia]AdvAboUsu[empresa]].dbo.clientes clicom2 on com.iyear <= 0 and com.inumexp = clicom2.icodcli
left join [[instancia]AdvAboUsu[empresa]].dbo.oporcli opor on opor.idcomision = com.id
left join [[instancia]AdvAboUsu[empresa]].dbo.tipoexp on tipoexp.codigo = e.itipoexp
left join [[instancia]AdvAboUsu[empresa]].dbo.facturas f on f.yearfact = com.yearfactrelacionado and f.inumfactura = com.inumfacturarelacionado and f.codsubusu = com.subusufactrelacionado and f.serie = com.serierelacionado",,id:INT,Trabajadores,,bvertrabajador,1,,,,,
472,95,Proveedores,"select 1 as unidad,com.id,com.backcolor,cli.snombrecli as nombreCliente,com.icodcli,com.inumexp, com.iyear, convert(varchar(50), com.inumexp) + '&' +  convert(varchar(50), com.iyear) as idexp,
e.descripcion, e.srefabogado,  com.idprevcobros,com.serierelacionado,com.fecha as fechaalta,com.fechaliquidacion,com.concepto,  
com.baseimponible,com.poriva,com.porirpf,com.totaliva,com.totalirpf,(ISNULL(com.totaliva,0) - ISNULL(com.totalirpf,0) + ISNULL(com.baseimponible,0)) as total,com.estado,  
case when com.tipoliquidacion = 0 then UPPER('C') + 'obro' when com.tipoliquidacion = 1 then UPPER('F') + 'actura' else UPPER('M') + 'anual' end as tipoliquidacion, 
com.tipoliquidacion as itipo, com.yearfactrelacionado, com.inumfacturarelacionado, com.subusufactrelacionado,   su.nombre as usuarioexp, com.idcomisionista,com.tipocomision, 
CASE WHEN (com.iyear <= 0) THEN clicom2.snombrecli ELSE clicom.snombrecli end as nombreclienteexpediente,
tipoexp.tipoexp as tipoexpedien, case when e.iyear < 0 then '' else convert(varchar,e.expediente) + '/' + CONVERT(varchar,e.iyear) end as expyearnum,
case when f.inumfactura is null then null else isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) end as baseimp,
CASE WHEN com.inumfacturarelacionado IS NOT NULL THEN CAST(com.inumfacturarelacionado AS VARCHAR) + '/' + CAST(com.yearfactrelacionado AS VARCHAR) ELSE NULL END as factura
from [[instancia]AdvAboUsu[empresa]].dbo.comision com 
inner join [[instancia]AdvAboUsu[empresa]].dbo.clientes cli on com.icodcli = cli.icodcli and cli.tipobd in (9)    
left  join [[instancia]AdvAboUsu[empresa]].dbo.expedien e on com.inumexp = e.inumexp and com.iyear = e.iyear 
left join [[instancia]AdvAboUsu[empresa]].dbo.subusu su on e.codsubusu = su.icodsubusu
left join [[instancia]AdvAboUsu[empresa]].dbo.comisionista cm on com.idcomisionista = cm.id
left join [[instancia]AdvAboUsu[empresa]].dbo.linecontagastos l on l.idlinea = com.idLineContagastos
left join [[instancia]AdvAboUsu[empresa]].dbo.clientes clicom on com.iyear > 0 and e.codcliente = clicom.icodcli
left join [[instancia]AdvAboUsu[empresa]].dbo.clientes clicom2 on com.iyear <= 0 and com.inumexp = clicom2.icodcli
left join [[instancia]AdvAboUsu[empresa]].dbo.oporcli opor on opor.idcomision = com.id
left join [[instancia]AdvAboUsu[empresa]].dbo.tipoexp on tipoexp.codigo = e.itipoexp
left join [[instancia]AdvAboUsu[empresa]].dbo.facturas f on f.yearfact = com.yearfactrelacionado and f.inumfactura = com.inumfacturarelacionado and f.codsubusu = com.subusufactrelacionado and f.serie = com.serierelacionado",,id:INT,Proveedores,,bvertrabajador,2,,,,,
473,94,Expedientes,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.inumexp, o.iyear, o.tipooportunidad, o.icodusu, o.fechafinprev, o.fechacierre
	, o.oportunidad, o.tipo, o.etapa, o.estado, pro.snombrecli as nombreProveedor, e.descripcion as nombreAsociado, e.descripcion as descripcionExp
	, e.expediente as numExp, e.srefabogado, su1.icodsubusu as codigoUsuario, su1.nombre as nombreUsuario, su2.nombre as nombreCreador, o.serie, o.numopor,o.backcolor, o.idcentro
	, t.numfactura as numfactura, t.ejercicio as ejercicio, t.origenFact as origenFact, t.total 
	--[camposperso]
	, MARCAFROM FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
	INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes pro ON pro.icodcli = o.icodcli 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien e ON e.inumexp = o.inumexp AND e.iyear = o.iyear 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef centrocompra on o.idcentro = centrocompra.id    
	LEFT JOIN  (SELECT frp.icodopor, lc.baseimponible - lc.totaldctoeuro as total, max(ct.numfactura) as numfactura, max(ct.ejercicio) as ejercicio,
case when max(isnull(ct.tipofact,0)) = 3
then upper('a')+'lbarán' else upper('f')+'actura' end as [origenfact]
FROM [[instancia]advabousu[empresa]].dbo.facturaRecibidaParcialOporcli frp 
INNER JOIN [[instancia]advabousu[empresa]].dbo.linecontagastos lc ON frp.lineaLinea = lc.idlinea AND frp.fechaCuenta = lc.fecha 
INNER JOIN [[instancia]advabousu[empresa]].dbo.contagastos ct ON frp.icodcliCuenta = ct.icodcli AND frp.fechaCuenta = ct.fecha AND lc.id = ct.id 
 where frp.icodopor is not null 
group by frp.icodopor, lc.baseimponible, lc.totaldctoeuro ) t on t.icodopor = o.icodopor		
	--[leftjoinperso]
	WHERE tipooportunidad = 2 and inumexp is not null",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Expedientes,,,0,,0,,,
474,91,Expedientes,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
		(CAST(act.inumexp as varchar) + '-' + CAST(act.iyear as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
		act.icodcli as numero, e.expediente, null as estadooporcli, c.codigo, e.inumexp, e.codcliente as icodcli,act.dfechaact as dfechaact, e.iyear, tipoexp.tipoexp as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
		act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
		act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
		s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
		act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, tipoexp.codigo as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
		, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, CAST(e.inumexp as varchar) + CAST(e.iyear as varchar) as idexp , c.campo6 as clicampo6 ,
		c.idcentros, centrospredef.sdescripcion as nombrecentro, null as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
		eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
		case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
		null as excliproestado4, null as excliproestado5, null as excliproestado6, null as origenactu, act.orden,
		case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
		act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
		act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
		act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
		act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
		act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
		c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
		case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
		case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
		case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
		(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
		where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
		null as expcampo22, null as nifcontrario, act.inumordenseg, null as peticionfacturado, null as nombremutua, act.cancelada, act.motivocancelacion,
		null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
		null as porcentajefase, null as tiempoprevistofase, null as realizadafase, null as tipoopor, null as fuente, null as etapa, null as tiempoprev, 
		null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
		act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre,
		0 as sumCosteSegcliNoGastos, 0 as sumCosteSegcliGastos, 0 as sumCosteSegcli
		--[camposperfil]
		from [[instancia]advabousu[empresa]].dbo.segexp act
		left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
		left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu s2 on e.codsubusu=s2.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
		left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
		left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
		left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
		left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
		left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
		left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
		left join [[instancia]advabousu[empresa]].dbo.clientes worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.exclipro  on exclipro.icodcli=worker.icodcli and exclipro.inumexp=act.inumexp and exclipro.iyear=act.iyear
		left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.inumexp = ap.inumexpSegexp and act.iyear = ap.iyearSegexp and act.dfechaact = ap.dfechaactSegexp and act.linea = ap.lineaSegexp
		left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
		left join [[instancia]advabousu[empresa]].dbo.fasesegexp fsexp on act.inumexp = fsexp.inumexp and act.iyear = fsexp.iyear and act.dfechaact = fsexp.dfechaact and act.linea = fsexp.ilinea
		left join [[instancia]advabousu[empresa]].dbo.segfase on fsexp.id_segfase = segfase.id
		left join [[instancia]advabousu[empresa]].dbo.subusu sf on segfase.icodsubusu=sf.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
		left join [[instancia]advabousu[empresa]].dbo.[events] eventos
		on eventos.inumexp = act.inumexp and eventos.iyear = act.iyear and lineaact = act.linea and eventos.origen = 1
		and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
		left join (select 0 as sumcostesegclinogastos, 0 as sumcostesegcligastos, 0 as sumcostesegcli) r on 1 = 1

		left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
		
		--[controlhorario]

		where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segexp",inumexp:INT|iyear:INT|dfechaact:DATETIME|linea:INT,Expedientes,,,0,,0,,,
475,58,Expedientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado as estadoprof,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totarticuloeuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,
case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then f.inumfacturada
	 else
		 case when
			(select count(*) from 
			(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		then -1 --tiene las líneas en varias facturas
		else 
			(select max(inumfacturada) as inumfacturada from lineprof 
			where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
			and codsubusu=f.codsubusu and tipoprof=f.tipoprof)
		 end  
     end as inumfacturada, 
f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then upper('O')+'ficial'
		when 1 then upper('P')+'ro forma'
		when 2 then upper('P')+'resupuesto'
		when 3 then upper('A')+'lbarán'
		when 4 then upper('P')+'edido'
		when 5 then upper('O')+'rden'
		else 
		  case when
			  (select count(*) from 
			  (select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
			  where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
			  group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
		  then upper('v')+'arias '+upper('o')+'ficial'
		  else upper('o')+'ficial'
		  end
	end
when 0 then
	case when (select count(inumfactura) as numlineasfacturadas from lineprof 
				 where isnull(facturada,0)=1 and inumfactura=f.inumfactura and yearfact=f.yearfact 
				 and codsubusu=f.codsubusu and tipoprof=f.tipoprof) > 0 then upper('p')+'arcial'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, exp.expediente as inumexpediente, exp.anyo as iyearexpediente, exp.descripcion as descripexpediente,
convert(varchar(50), exp.inumexp) + '&' +  convert(varchar(50), exp.iyear) as idexp,
subusu.nombre as nomsubusu, 
 case when f.inumfacturada is not null and isnull(f.facturada,0) = 1 then fac.fecha	
  else --es parcial
	 case when
		(select count(*) from 
		(select inumfacturada,yearfacturada,codsubusufacturada,seriefacturada from lineprof 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof
		group by inumfacturada,yearfacturada,codsubusufacturada,seriefacturada )tbl) > 1 
	then -1 --tiene las líneas en varias facturas
    else 
		(select max(fecha) as fechafactura from lineprof
		left join facturas on lineprof.inumfacturada=facturas.inumfactura and lineprof.yearfacturada=facturas.yearfact and lineprof.codsubusufacturada=facturas.codsubusu and lineprof.seriefacturada=facturas.serie 
		where isnull(facturada,0)=1 and lineprof.inumfactura=f.inumfactura and lineprof.yearfact=f.yearfact 
		and lineprof.codsubusu=f.codsubusu and lineprof.tipoprof=f.tipoprof)
	 end
  end as fechafactura, 

f.iyearrelacionado, f.inumexprelacionado,
case when isnull(f.fracobrada, 0) = 1 then 1 when ((f.totacuenta=0 or (f.totacuenta is null))) and (isnull(f.fracobrada,0)=0) then 2 when (f.totacuenta<>0) and (isnull(f.fracobrada,0)=0) then 3 else 0 end as estado, exp.itipoexp, texp.tipoexp, f.backcolor

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f 
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
left join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' 
left join [[instancia]advabousu[empresa]].dbo.expedien exp on f.inumexprelacionado = exp.inumexp and f.iyearrelacionado = exp.iyear 
left join [[instancia]advabousu[empresa]].dbo.tipoexp as texp on texp.codigo = exp.itipoexp
left join [[instancia]advabousu[empresa]].dbo.clientes as cp on exp.codcliente = cp.icodcli
--[leftjoinperfil]

where tipoprof=3 and inumexprelacionado is not null and inumexprelacionado <> -1 ","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Expedientes,,bVerExpedientes,1,,,,,
476,59,Expedientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,f.backcolor,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, exp.expediente as inumexpediente, exp.iyear as iyearexpediente, exp.descripcion as descripexpediente,
convert(varchar(50), exp.inumexp) + '&' +  convert(varchar(50), exp.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f 
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada  and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
left join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' 
left join [[instancia]advabousu[empresa]].dbo.expedien exp on f.inumexprelacionado = exp.inumexp and f.iyearrelacionado = exp.iyear 
--[leftjoinperfil]

where tipoprof=4 and inumexprelacionado is not null and inumexprelacionado <> -1 ","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Expedientes,,bVerExpedientes,1,,,,,
477,60,Expedientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof, f.sdescripcionorden,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais, exp.expediente as inumexpediente, exp.iyear as iyearexpediente, exp.descripcion as descripexpediente,
convert(varchar(50), exp.inumexp) + '&' +  convert(varchar(50), exp.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado, f.backcolor, case when o.id is null then null else isnull(tratamientos.valor, upper('o')+'dontología') end as especialidad, tratamientos.id as idTipoEspecialidad,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SA.unidades * SA.importeBase * (100 - ISNULL(SA.descuento, 0))/100) * (100 - ISNULL(SA.dctoGeneralPresupuesto, 0)) / 100)
FROM segodont SA
WHERE SA.idActuPresupuesto IN (SELECT id FROM segodont WHERE idOdontograma = o.id)), 0) ELSE 0 END AS impOdonAceptado,

CASE WHEN o.id IS NOT NULL THEN
ISNULL((SELECT SUM((SP.unidades * SP.importeBase * (100 - ISNULL(SP.descuento, 0))/100))
FROM segodont SP
WHERE SP.idActuPresupuesto IS null AND SP.idOdontograma = o.id), 0) * (100 - ISNULL(f.dcto, 0)) / 100 ELSE 0 END AS impOdonPendiente

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f 
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada  and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
left join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' 
left join [[instancia]advabousu[empresa]].dbo.expedien exp on f.inumexprelacionado = exp.inumexp and f.iyearrelacionado = exp.iyear 
left join [[instancia]advabousu[empresa]].dbo.odontograma o on o.yearpresu=f.yearfact AND o.inumpresu=f.inumfactura AND o.codusupresu=f.codsubusu
left join [[instancia]advabousu[empresa]].dbo.combovalores tratamientos on o.tipoEspecialidad = tratamientos.id

--[leftjoinperfil]

where tipoprof=2 and inumexprelacionado is not null and inumexprelacionado <> -1","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Expedientes,,bVerExpedientes,1,,,,,
478,61,Expedientes,"select f.yearfact,f.fecha,f.inumfactura,f.nombrecli,
f.nifcli,f.totaleuro,f.totaldctoeuro,f.formapago,f.fracobrada,
isnull(f.totacuenta,0) as importecobrado,f.fechacobro,f.codsubusu,
f.origen,f.inumexp,f.iyear,f.tipologia1,
f.tipologia2,f.tipologia3,f.estado,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,
isnull(f.totaleuro,0)-isnull(f.totacuenta,0) as totpendiente,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.facturada,f.tipofactfacturada,f.inumfacturada,f.tipoprof,
case f.facturada
when 1 then
	case f.tipofactfacturada
		when 0 then 'Oficial'
		when 1 then 'Pro forma'
		when 2 then 'Presupuesto'
		when 3 then 'Albarán'
		when 4 then 'Pedido'
		when 5 then 'Orden'
	end
end
as traspasadaa,
cli.icodcli,cli.codigo, cli.stelefonocli, cli.telefono2, cli.telefono3, cli.smovilcli, cli.email, cli.sdomiciliocli, cli.spoblacioncli, cli.sprovinciacli, cli.scodpostalcli, cli.snombrepais,exp.expediente as inumexpediente, exp.iyear as iyearexpediente,
convert(varchar(50), exp.inumexp) + '&' +  convert(varchar(50), exp.iyear) as idexp,
subusu.nombre as nomsubusu, fac.fecha as fechaFactura,f.iyearrelacionado, f.inumexprelacionado

--[camposperfil]

from  [[instancia]advabousu[empresa]].dbo.proforma f 
left join [[instancia]advabousu[empresa]].dbo.facturas fac on fac.yearfact = f.yearfacturada and fac.inumfactura = f.inumfacturada and fac.codsubusu = f.codsubusufacturada and fac.serie = f.seriefacturada 
left join  [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu 
left join  [[instancia]advabousu[empresa]].dbo.clientes cli on f.inumexp=cli.icodcli and f.origen='cli' 
left join [[instancia]advabousu[empresa]].dbo.expedien exp on f.inumexprelacionado = exp.inumexp and f.iyearrelacionado = exp.iyear 
--[leftjoinperfil]

where tipoprof=5 and inumexprelacionado is not null and inumexprelacionado <> -1 ","select notas, notas2, notas3, notas4, notas5, notas6
from proforma",inumfactura:INT|yearfact:INT|codsubusu:INT|tipoprof:INT,Expedientes,,ver_exp|1,1,,,,,
479,48,Proveedores,"select fvto.pfechavto as fvtofact,f.yearfact,f.fecha,f.inumfactura as inumfactura,f.serie,f.id,
CASE WHEN isnull(f.serie, '') = 'seriemn' THEN ''
WHEN isnull(f.serie, '') like 'mn&%' THEN SUBSTRING(f.serie, 4, LEN(f.serie)) 
ELSE f.serie END AS serieVisible, f.nombrecli,
f.nifcli,f.totaleuro as totaleuro,f.totaldctoeuro,f.formapago,isnull(f.fracobrada,0) as fracobrada,
case when isnull(f.fracobrada,0) = 1 then 1 when f.TotalCobros=0 or (f.TotalCobros is null) or (f.TotalCobros-f.Totaldevolucion=0) and (f.FraCobrada=0 or f.FraCobrada is null) then 2 when ((f.TotalCobros<>0) and ((f.TotalCobros-f.Totaldevolucion>0) or (f.totaldevolucion is null)) and (f.FraCobrada=0 or (f.FraCobrada is null))) then 3 else 0 end as estado,
f.importecobrado,f.fechacobro,f.fechaconta,f.codsubusu,
f.documento,f.origen,f.inumexp,f.iyear,f.observaciones,f.tipologia1,
f.tipologia2,f.tipologia3,f.refabonada,f.fechaabonada,
f.totalivaeuro,f.totalirpfeuro,f.totalsuplidoseuro,f.totalprovisioneseuro,f.totalderechoseuro,f.totalhonoeuro,f.totarticuloeuro,
(select cast(round(isnull(sum(lf.salidaeuro),0),2) as numeric(19,2)) from linefact lf left join facturas fac on lf.inumfactura= fac.inumfactura and lf.yearfact = fac.iyear and lf.serie = fac.serie and lf.inumexpexho = fac.inumexp and fac.codsubusu = lf.codsubusu left join cuencli cue on cue.icodcli = lf.inumexpexho and cue.linea = lf.linea and cue.yearfact = fac.iyear where lf.tipo = 'ANTICIPO' and lf.inumfactura = f.inumfactura and lf.yearfact = f.yearfact and lf.serie = f.serie) as totanticipos,
f.backcolor,f.totaleuro-f.importecobrado as totpendiente,f.ccaja,f.tipoBs,
isnull(f.totalderechoseuro,0)-isnull(f.totaldctoeuro,0) as baseimp,
f.reffactu,
f.totalhonoeuro,f.totalgastoeuro as gasto,
null as srefabogado, null as descripcion, null as snumasunto ,null as tipoexp, null as tipoasunto, null as procedimiento, null as juzgado, null as snombreabo,null as snombreclicon,
C.icodcli,Convert(varchar,C.codigo) as codigo, C.stelefonocli,C.telefono2,C.telefono3,C.sdomiciliocli,C.smovilcli,C.scodpostalcli,C.estadocli,C.email,C.snombrepais,C.sprovinciacli,C.spoblacioncli, null as inumexpediente, null as iyearexpediente, null as refexpediente,
case when (C.tipobd = 0) then 'Cliente' when (C.tipobd = 1) then 'Trabajador' when (C.tipobd = 2) then 'Potencial' when (C.tipobd = 3) then 'Tercero' when (C.tipobd = 4) then 'Paciente' when (C.tipobd = 5) then 'Alumno' when (C.tipobd = 6) then 'Compañía' when (C.tipobd = 7) then 'MascotaTutor' when (C.tipobd = 8) then 'Mutua' when (C.tipobd = 9) then 'Proveedor' when (C.tipobd = 10) then 'Voluntario' when (C.tipobd = 11) then 'Financiador' when (C.tipobd = 12) then 'TerceraEdad' end as tipobddescrip,
convert(varchar(50), f.inumexprelacionado) + '&' +  convert(varchar(50), f.iyearrelacionado) as idexp,
subusu.nombre as nomsubusu, (case f.diario when 's' then 1 else 0 end) as diario,f.fechaEnvio,
null as tipoexp, null as nombretrabajador, null as codtrabajador,
CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + f.serie as idlineafact, null as itipoexp
,convert(varchar(255),f.inumfactura) + '|' + convert(varchar(255),f.yearfact) + '|' + f.serie + '|' + convert(varchar(255),f.codsubusu) as idFactura, subusuCli.nombre as NombreClienteUsuario, isnull(subusuCli.icodsubusu,0) as CodClienteUsuario,
case when f.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, f.subusucre as icodCreador, f.fechaOperacion
,ISNULL(f.totalcobros, 0) -ISNULL(pimpagadocob.impagadocob, 0) AS importecobradoCAL
,ISNULL(f.Totaleuro, 0) - (ISNULL(f.totalcobros, 0) - ISNULL(pimpagadocob.impagadocob, 0)) AS totpendienteCAL 

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.facturas f
left join (SELECT l.yearfact, l.inumfactura, l.codsubusu, l.serie,
		(SELECT descripcion + ' ### ' 
		FROM [[instancia]advabousu[empresa]].dbo.linefact
		WHERE (yearfact = l.yearfact and inumfactura = l.inumfactura and codsubusu = l.codsubusu and serie = l.serie)
		FOR XML PATH ('')) AS conceptos
	FROM [[instancia]advabousu[empresa]].dbo.linefact l 
	GROUP BY l.yearfact, l.inumfactura, l.codsubusu, l.serie) tc 
ON f.yearfact = tc.yearfact and f.inumfactura = tc.inumfactura and f.codsubusu = tc.codsubusu and f.serie = tc.serie
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = f.codsubusu
inner join [[instancia]advabousu[empresa]].dbo.clientes C on f.inumexp=C.icodcli and f.origen='cli' and C.tipobd in (9)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join (select p.inumfactura as pinumfactura, p.yearfact as pyearfact,p.subusufact as psubusufact, p.serie as pserie, min(p.fecha) 
as pfechavto from [[instancia]advabousu[empresa]].dbo.prevcobros p   where p.factura=1 and isnull(p.cobrado,0)=0 group by p.inumfactura, p.yearfact, p.subusufact, p.serie) as fvto  
on f.inumfactura = fvto.pinumfactura and f.yearfact = fvto.pyearfact  and f.codsubusu = fvto.psubusufact and f.serie = fvto.pserie
left join tiposfactura tfact on tfact.id = f.idtipofact
left join tiposrectificacion trect on trect.id= f.idtiporect
LEFT JOIN
(select sum(isnull(p.importeimpagado, 0)) as impagadocob, p.inumfactura, p.yearfact, p.subusufact, p.serie
from [[instancia]advabousu[empresa]].dbo.prevcobros p
where p.factura = 1 and isnull(p.cobrado, 0) = 1 and isnull(p.impagado, 0) = 1
group by p.inumfactura, p.yearfact, p.subusufact, p.serie
) AS pimpagadocob
on pimpagadocob.inumfactura = f.inumfactura and pimpagadocob.yearfact = f.yearfact and pimpagadocob.subusufact = f.codsubusu and pimpagadocob.serie = f.serie 
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = f.subusucre
--[leftjoinperfil]
--[leftjoinperso]
where f.inumexprelacionado is null or f.inumexprelacionado = -1
WHERE 1=1
","select notas, notas2, notas3, notas4, notas5, notas6
from facturas",inumfactura:INT|yearfact:INT|codsubusu:INT|serie:VARCHAR,Proveedores,9,bverproveedor,0,,,,,
480,96,Trabajadores,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
act.icodcli as numero, c.codigo, act.icodcli as icodcli,act.dfechaact as dfechaact, act.subusu,act.dfechaact as fecha_act,act.linea,
act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,
act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, null as descripcion, act.tipohistotr, act.campo1,act.campo2,act.campo3, act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli, c.tipofichero as tipocliente, 
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
c.origen as origencli, c.campo6 as clicampo6, c.idcentros, centrospredef.sdescripcion as nombrecentro, c.zona, c.sfaxcli, c.cargo, act.unidad,
case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador,
act.origenactu, act.orden,
case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador,
(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
act.inumordenseg, act.cancelada, act.motivocancelacion,
act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre 

from [[instancia]advabousu[empresa]].dbo.segcli act
inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre

--[controlhorario]

where sactuacion like 'Inactividad Equipo' ","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Trabajadores,,,0,,0,,,
481,97,InformeControlInactividad,"select distinct (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
act.id, act.dfechaact, act.linea, act.sactuacion, act.horainiact, act.horafinact, act.tiempo, act.icodcli, act.subusu, act.fecharealizacion, act.dfechanotificacion,
cli.snombrecli, act.tipohistotr, act.tipo, s.nombre as nomsubusu, cx.dpto
from [[instancia]advabousu[empresa]].dbo.segcli act 
inner join [[instancia]advabousu[empresa]].dbo.clientes cli on act.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientesext cx on cx.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu = s.icodsubusu
where sactuacion like 'Inactividad Equipo' ",,icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Control Inactividad,,,0,,,,,
482,98,InformeControlHorarioDetallado,"SELECT * , MARCAFROM FROM ((select distinct (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
act.id,act.dfechaact,act.linea,act.sactuacion,act.horainiact,act.horafinact,
	act.horaEntrada,act.tiempo,act.icodcli,act.subusu,act.fecharealizacion,act.dfechanotificacion,
cli.snombrecli,act.tipohistotr,act.tipo,s.nombre as nomsubusu,cx.dpto, 0 as horasprevistas
,cli.idcentros 
from [[instancia]advabousu[empresa]].dbo.segcli act 
inner join [[instancia]advabousu[empresa]].dbo.clientes cli on act.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientesext cx on cx.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu = s.icodsubusu

--[controlhorario]

where tipo = 'Control Horario'
)	
	UNION ALL
(
SELECT  '-' as idAct, 0 As id, fecha AS dfechaact, -1 AS linea, '' AS sactuacion, null AS horainiact, null AS horafinact, null AS horaEntrada, 0 AS tiempo, tur.icodcli, cli.CodSubUSu As subusu,
	fecha AS fecharealizacion, null AS dfechanotificacion, cli.snombrecli, null AS tipohistotr, null AS tipo, '' AS nomsubusu, '' AS dpto, sum(tur.tiempo) as horasprevistas
	,cli.idcentros
	from [[instancia]advabousu[empresa]].dbo.turnos tur 
	inner join [[instancia]advabousu[empresa]].dbo.clientes cli on tur.icodcli=cli.icodcli
	WHERE tur.disponibilidad = 1
	GROUP BY fecha, tur.icodcli, cli.snombrecli, cli.CodSubUSu, cli.idcentros 
)) tabla WHERE 1 =1",,icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Control Horario Detallado,,,0,,,,,
483,99,InformeTiemposDetallado,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
		(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
		act.icodcli as numero, e.expediente, o.estado as estadooporcli, c.codigo, e.inumexp, act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, tipoexp.tipoexp as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
		act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
		act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
		s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
		act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, tipoexp.codigo as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
		, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, CAST(e.inumexp as varchar) + CAST(e.iyear as varchar) as idexp , c.campo6 as clicampo6 ,
		c.idcentros, centrospredef.sdescripcion as nombrecentro, o.oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
		eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
		case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
		null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
		case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
		act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
		act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
		act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
		act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
		act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
		c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
		case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
		case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
		case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
		(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
		where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
		null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
		null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
		null as porcentajefase, null as tiempoprevistofase, null as realizadafase, o.tipo as tipoopor, o.fuente, o.etapa, o.tiempoprev, 
		null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
		act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre,
		r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
		--[camposperfil]
		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
		left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
		left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
		left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
		left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
		left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
		left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
		left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
		left join [[instancia]advabousu[empresa]].dbo.expedien e on o.inumexp = e.inumexp and o.iyear = e.iyear
		left join [[instancia]advabousu[empresa]].dbo.tipoexp on tipoexp.codigo=e.itipoexp
		left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
		left join [[instancia]advabousu[empresa]].dbo.[events] eventos
		on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
		and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
		--[leftjoinperfil]
		--[controlhorario]
		where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Hoja de Tiempos Detallado,5,,0,,,,,
484,99,Expedientes,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
		(CAST(act.inumexp as varchar) + '-' + CAST(act.iyear as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
		act.icodcli as numero, e.expediente, null as estadooporcli, c.codigo, e.inumexp, act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, tipoexp.tipoexp as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
		act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
		act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
		s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
		act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, tipoexp.codigo as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
		, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, CAST(e.inumexp as varchar) + CAST(e.iyear as varchar) as idexp , c.campo6 as clicampo6 ,
		c.idcentros, centrospredef.sdescripcion as nombrecentro, null as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
		eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
		case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
		null as excliproestado4, null as excliproestado5, null as excliproestado6, null as origenactu, act.orden,
		case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
		act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
		act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
		act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
		act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
		act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
		c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
		case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
		case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
		case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
		(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
		where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
		null as expcampo22, null as nifcontrario, act.inumordenseg, null as peticionfacturado, null as nombremutua, act.cancelada, act.motivocancelacion,
		null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
		null as porcentajefase, null as tiempoprevistofase, null as realizadafase, null as tipoopor, null as fuente, null as etapa, null as tiempoprev, 
		null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
		act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre,
		0 as sumCosteSegcliNoGastos, 0 as sumCosteSegcliGastos, 0 as sumCosteSegcli
		--[camposperfil]
		from [[instancia]advabousu[empresa]].dbo.segexp act
		left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
		left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu s2 on e.codsubusu=s2.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
		left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
		left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
		left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
		left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
		left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
		left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
		left join [[instancia]advabousu[empresa]].dbo.clientes worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.exclipro  on exclipro.icodcli=worker.icodcli and exclipro.inumexp=act.inumexp and exclipro.iyear=act.iyear
		left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.inumexp = ap.inumexpSegexp and act.iyear = ap.iyearSegexp and act.dfechaact = ap.dfechaactSegexp and act.linea = ap.lineaSegexp
		left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
		left join [[instancia]advabousu[empresa]].dbo.fasesegexp fsexp on act.inumexp = fsexp.inumexp and act.iyear = fsexp.iyear and act.dfechaact = fsexp.dfechaact and act.linea = fsexp.ilinea
		left join [[instancia]advabousu[empresa]].dbo.segfase on fsexp.id_segfase = segfase.id
		left join [[instancia]advabousu[empresa]].dbo.subusu sf on segfase.icodsubusu=sf.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
		left join [[instancia]advabousu[empresa]].dbo.[events] eventos
		on eventos.inumexp = act.inumexp and eventos.iyear = act.iyear and lineaact = act.linea and eventos.origen = 1
		and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')

		left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
		left join (select 0 as sumcostesegclinogastos, 0 as sumcostesegcligastos, 0 as sumcostesegcli) r on 1 = 1
		
		--[controlhorario]

		where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segexp",inumexp:INT|iyear:INT|dfechaact:DATETIME|linea:INT,Expedientes,,,0,,0,,,
485,100,InformeTiemposPorTipo,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
		(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
		act.icodcli as numero, e.expediente, o.estado as estadooporcli, c.codigo, e.inumexp, act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, tipoexp.tipoexp as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
		act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
		act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
		s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
		act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, tipoexp.codigo as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
		, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, CAST(e.inumexp as varchar) + CAST(e.iyear as varchar) as idexp , c.campo6 as clicampo6 ,
		c.idcentros, centrospredef.sdescripcion as nombrecentro, o.oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
		eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
		case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
		null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
		case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
		act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
		act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
		act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
		act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
		act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
		c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
		case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
		case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
		case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
		(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
		where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
		null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
		null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
		null as porcentajefase, null as tiempoprevistofase, null as realizadafase, o.tipo as tipoopor, o.fuente, o.etapa, o.tiempoprev, 
		null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
		act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre,
		r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
		--[camposperfil]
		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
		left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
		left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
		left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
		left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
		left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
		left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
		left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
		left join [[instancia]advabousu[empresa]].dbo.expedien e on o.inumexp = e.inumexp and o.iyear = e.iyear
		left join [[instancia]advabousu[empresa]].dbo.tipoexp on tipoexp.codigo=e.itipoexp
		left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
		left join [[instancia]advabousu[empresa]].dbo.[events] eventos
		on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
		and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
		--[leftjoinperfil]
		--[controlhorario]
		where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Hoja de Tiempos por Tipo,5,,0,,,,,
486,100,Expedientes,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
		(CAST(act.inumexp as varchar) + '-' + CAST(act.iyear as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
		act.icodcli as numero, e.expediente, null as estadooporcli, c.codigo, e.inumexp, act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, tipoexp.tipoexp as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
		act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
		act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
		s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
		act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, tipoexp.codigo as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
		case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
		case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
		case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
		, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, CAST(e.inumexp as varchar) + CAST(e.iyear as varchar) as idexp , c.campo6 as clicampo6 ,
		c.idcentros, centrospredef.sdescripcion as nombrecentro, null as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
		eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
		case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
		null as excliproestado4, null as excliproestado5, null as excliproestado6, null as origenactu, act.orden,
		case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
		act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
		act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
		act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
		act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
		act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
		c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
		case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
		case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
		case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
		(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
		where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
		null as expcampo22, null as nifcontrario, act.inumordenseg, null as peticionfacturado, null as nombremutua, act.cancelada, act.motivocancelacion,
		null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
		null as porcentajefase, null as tiempoprevistofase, null as realizadafase, null as tipoopor, null as fuente, null as etapa, null as tiempoprev, 
		null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
		act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre,
		0 as sumCosteSegcliNoGastos, 0 as sumCosteSegcliGastos, 0 as sumCosteSegcli
		--[camposperfil]
		from [[instancia]advabousu[empresa]].dbo.segexp act
		left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
		left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu s2 on e.codsubusu=s2.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
		left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
		left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
		left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
		left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
		left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
		left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
		left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
		left join [[instancia]advabousu[empresa]].dbo.clientes worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.exclipro  on exclipro.icodcli=worker.icodcli and exclipro.inumexp=act.inumexp and exclipro.iyear=act.iyear
		left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.inumexp = ap.inumexpSegexp and act.iyear = ap.iyearSegexp and act.dfechaact = ap.dfechaactSegexp and act.linea = ap.lineaSegexp
		left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
		left join [[instancia]advabousu[empresa]].dbo.fasesegexp fsexp on act.inumexp = fsexp.inumexp and act.iyear = fsexp.iyear and act.dfechaact = fsexp.dfechaact and act.linea = fsexp.ilinea
		left join [[instancia]advabousu[empresa]].dbo.segfase on fsexp.id_segfase = segfase.id
		left join [[instancia]advabousu[empresa]].dbo.subusu sf on segfase.icodsubusu=sf.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
		left join [[instancia]advabousu[empresa]].dbo.[events] eventos
		on eventos.inumexp = act.inumexp and eventos.iyear = act.iyear and lineaact = act.linea and eventos.origen = 1
		and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')

		left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
		left join (select 0 as sumcostesegclinogastos, 0 as sumcostesegcligastos, 0 as sumcostesegcli) r on 1 = 1
		
		--[controlhorario]

		where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segexp",inumexp:INT|iyear:INT|dfechaact:DATETIME|linea:INT,Expedientes,,,0,,0,,,
487,101,InformeTiemposporTarea,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
	(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
	act.icodcli as numero, e.expediente, o.estado as estadooporcli, c.codigo, e.inumexp, act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
	act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
	act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
	s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
	act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
	case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
	case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
	case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
	case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
	case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
	case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
	, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
	c.idcentros, centrospredef.sdescripcion as nombrecentro, o.oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
	eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
	case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
	null as excliproestado4, null as excliproestado5, null as excliproestado6, act.origenactu, act.orden,
	case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
	act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
	act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
	act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
	act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
	act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
	c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
	case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
	case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
	case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
	(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
	where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
	null as expcampo22, null as nifcontrario, act.inumordenseg, peticioncli.facturado as peticionfacturado, mutuas.snombrecli as nombremutua, act.cancelada, act.motivocancelacion,
	null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
	null as porcentajefase, null as tiempoprevistofase, null as realizadafase, o.tipo as tipoopor, o.fuente, o.etapa, o.tiempoprev, 
	null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
	act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
	--[camposperfil]
	from [[instancia]advabousu[empresa]].dbo.segcli act
	inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli
	left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
	left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
	left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
	left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
	left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
	left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
	left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
	left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
	left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
	left join [[instancia]advabousu[empresa]].dbo.expedien e on o.inumexp = e.inumexp and o.iyear = e.iyear
	left join [[instancia]advabousu[empresa]].dbo.oporresumen r on o.icodopor = r.icodopor
	left join [[instancia]advabousu[empresa]].dbo.[events] eventos
	on eventos.inumexp = act.icodcli and lineaact = act.linea and eventos.origen = 5
	and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')
	--[leftjoinperfil]
	--[controlhorario]
	where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Hoja de Tiempos por Tarea,5,,0,,,,,
488,101,Expedientes,"select distinct tipoficherocli.tipofichero, act.agenda, 2 as origen,
	(CAST(act.inumexp as varchar) + '-' + CAST(act.iyear as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
	act.icodcli as numero, e.expediente, null as estadooporcli, c.codigo, e.inumexp, act.icodcli as icodcli,act.dfechaact as dfechaact, e.iyear, cast(null as varchar) as tipoexp,act.subusu,act.dfechaact as fecha_act,act.linea,
	act.sactuacion,act.sdescripcion2,act.tiempo,act.acturealizada,act.tipo,act.tipohistotr,
	act.precio,act.facturado,act.dfechaven,act.dfechaavi,act.dfecharec,act.dfechase,act.fecharealizacion,act.numfactura,act.yearfact,c.snombrecli,c.email,act.facturable,c.perso88,c.stelefonocli,c.telefono2,c.telefono3,c.smovilcli,
	s.nombre as nomsubusu,act.tipoactu,act.horainiact,act.horafinact,act.preciocoste,act.alertas, e.descripcion, act.tipohisto,cast(null as varchar) as refpropia,act.campo1,act.campo2,act.campo3, null as fase,act.campo4,act.campo5,act.campo6,act.campo7,act.campo8,act.campo9,act.campo10,act.campo11,act.campo12,act.campo13,act.campo14,act.campo15,act.campo16,act.campo17,act.campo18,act.campofecha1,act.campofecha2,act.campofecha3, act.campofecha4,act.campofecha5,act.campofecha6,act.campofecha7,act.campofecha8,act.campofecha9,act.campofecha10,act.campofecha11,act.campofecha12,act.dfechanotificacion, 
	act.tiempoprevisto, c.nacionalidad, c.sprovinciacli , c.sdomiciliocli, c.spoblacioncli, c.scodpostalcli , null as expusu, null as itipoexp,null as numexp, null as itipoasunto, null as tipoasunto, c.tipofichero as tipocliente, null as codcontrario, null as abocontrario, 
	case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
	case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
	case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
	case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
	case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
	case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor
	, null as contrario , null as abopropio, null as codabopropio, c.origen as origencli, null as idexp , c.campo6 as clicampo6 ,
	c.idcentros, centrospredef.sdescripcion as nombrecentro, null as oportunidad, c.zona, null as procedimiento, null as codproce, c.sfaxcli, c.cargo,
	eventos.horaentrada, eventos.horasalida, eventos.tiempoconsulta, eventos.tiemposalaespera, eventos.iestado, null as codabocontrario, null as codjuzga, null as juzgado, null as snumasunto, act.unidad,
	case when c.tipobd = 1 then c.codigo else '' end as numtrabajador, case when c.tipobd = 1 then c.snombrecli else '' end as nombretrabajador, null as excliproestado1, null as excliproestado2, null as excliproestado3,
	null as excliproestado4, null as excliproestado5, null as excliproestado6, null as origenactu, act.orden,
	case when isnumeric(act.campo2) = 1 then convert(money, act.campo2) else 0 end as puntossoporte, act.fcostetotalcoste,
	act.tiempofact, act.tiemponofact, act.tiemponeto, act.preciofact, act.precionofact, act.precioneto, act.porcentaje,
	act.fcostemateriales, act.fcosteamortizacion, act.fcosteterceros, act.fcosteotros, act.fcampolibre6, act.fcampolibre7, act.fcampolibre8, act.fcampolibre9, act.fcampolibre10, 
	act.fcostetotalbeneficio, act.fcosteporbeneficio, c.estadocli, c.referencia as refcliente,
	act.campo19, act.campo20, act.campo21, act.campo22, act.campo23, act.campo24, act.campo25, act.campo26, act.campo27, 
	act.campofecha13, act.campofecha14, act.campofecha15, act.campofecha16, act.campofecha17, act.campofecha18, 
	c.fechaalta as fechaaltacli, c.fechabaja as fechabajacli,  act.aula, c.codsubusu as codusuficha, s2.nombre as usuarioficha, 
	case when c.tipobd = 1 then c.sector else '' end as sectortrabajador, 
	case when c.tipobd = 1 then c.fechaalta else convert(datetime, null) end as altatrabajador,
	case when c.tipobd = 1 then c.fechabaja else convert(datetime, null) end as bajatrabajador, null as fcuantia, b.Descripcion as DescripcionBono, b.NumBono,
	(select top 1 clientes.icodcli from [[instancia]advabousu[empresa]].dbo.segcliterceros st left join [[instancia]advabousu[empresa]].dbo.clientes on st.icodtercero=clientes.icodcli 
	where st.icodcli=act.icodcli and st.dfechaact=act.dfechaact and st.linea=act.linea and st.principal=1) as icodtercero,
	null as expcampo22, null as nifcontrario, act.inumordenseg, null as peticionfacturado, null as nombremutua, act.cancelada, act.motivocancelacion,
	null as nombrefase, null as tipofase, null as estadofase, null as usuariofase,
	null as porcentajefase, null as tiempoprevistofase, null as realizadafase, null as tipoopor, null as fuente, null as etapa, null as tiempoprev, 
	null as fechainifase, null as fechafinfase, null as fechainirealfase, null as fechafinrealfase,
	act.subusucre, case when act.subusucre = 0 then '/**ususupervisor**/' else sbcre.nombre end as nomsubusucre
	--[camposperfil]
	from [[instancia]advabousu[empresa]].dbo.segexp act
	left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear 
	left join [[instancia]advabousu[empresa]].dbo.clientes c on e.codcliente=c.icodcli 
	left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
	left join [[instancia]advabousu[empresa]].dbo.subusu s2 on e.codsubusu=s2.icodsubusu
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
	left join [[instancia]advabousu[empresa]].dbo.tipoexp  on tipoexp.codigo=e.itipoexp
	left join [[instancia]advabousu[empresa]].dbo.tipoasun on tipoasun.codigo=e.itipoasunto 
	left join [[instancia]advabousu[empresa]].dbo.abogados cont on e.codabocon = cont.icodabo 
	left join [[instancia]advabousu[empresa]].dbo.abogados prop on e.codpropro = prop.icodabo 
	left join [[instancia]advabousu[empresa]].dbo.cliecont clicont on e.codcontrario = clicont.icodclicon
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on e.idcentros = centrospredef.id
	left join [[instancia]advabousu[empresa]].dbo.procedi on e.codproce = procedi.codproce
	left join [[instancia]advabousu[empresa]].dbo.clientes worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.tipobd = 1
	left join [[instancia]advabousu[empresa]].dbo.exclipro  on exclipro.icodcli=worker.icodcli and exclipro.inumexp=act.inumexp and exclipro.iyear=act.iyear
	left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.inumexp = ap.inumexpSegexp and act.iyear = ap.iyearSegexp and act.dfechaact = ap.dfechaactSegexp and act.linea = ap.lineaSegexp
	left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
	left join [[instancia]advabousu[empresa]].dbo.fasesegexp fsexp on act.inumexp = fsexp.inumexp and act.iyear = fsexp.iyear and act.dfechaact = fsexp.dfechaact and act.linea = fsexp.ilinea
	left join [[instancia]advabousu[empresa]].dbo.segfase on fsexp.id_segfase = segfase.id
	left join [[instancia]advabousu[empresa]].dbo.subusu sf on segfase.icodsubusu=sf.icodsubusu
	left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
	left join [[instancia]advabousu[empresa]].dbo.[events] eventos
	on eventos.inumexp = act.inumexp and eventos.iyear = act.iyear and lineaact = act.linea and eventos.origen = 1
	and eventos.dfechaact = act.dfechaact and (eventos.tipo = 'ac' or eventos.tipo = 's' or eventos.tipo = 'v')

	left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
		
	--[controlhorario]

	where tipohistotr = 1","select notas, notas2, notas3, notas4, notas5, notas6 from segexp",inumexp:INT|iyear:INT|dfechaact:DATETIME|linea:INT,Expedientes,,,0,,0,,,
489,102,InformeControlInactividadDetallado,"select distinct (CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
act.id, act.dfechaact, act.linea, act.sactuacion, act.horainiact, act.horafinact, act.tiempo, act.icodcli, act.subusu, act.fecharealizacion, act.dfechanotificacion,
cli.snombrecli, act.tipohistotr, act.tipo, s.nombre as nomsubusu, cx.dpto
from [[instancia]advabousu[empresa]].dbo.segcli act 
inner join [[instancia]advabousu[empresa]].dbo.clientes cli on act.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientesext cx on cx.icodcli=cli.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu = s.icodsubusu
where sactuacion like 'Inactividad Equipo' ",,icodcli:INT|dfechaact:DATETIME|linea:INT,Informe Control Inactividad Detallado,,,0,,,,,
490,86,Aseguradoras,"select oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu,
	oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad,
	oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad,  oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario,  null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.horaalta, oporcli.idcentro, null as sdirArq, null as spobArq , c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea        
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and tipobd in (8)  
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli 
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor    
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado 
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext 
	ON facext.icodopor = oporcli.icodopor 
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
   
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where (1 = 1)   
	AND tipooportunidad=1 ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Aseguradoras,8,bvercompania,0,,,424,,
491,86,Proveedores,"select oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu,
	oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad,
	oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad,  oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad  
	, subusu.nombre as subusuario, null as tipoexpedien, subusuCli.nombre as NombreClienteUsuario, null as itipoexp, null as tipoasun, oporcli.horaalta, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea       
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and tipobd in (9)  
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli 
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado 
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext
	ON facext.icodopor = oporcli.icodopor 
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
     
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where (1 = 1)   
	AND tipooportunidad=1 ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Proveedores,9,bverproveedor,0,,,424,,
492,104,Expedientes,"SELECT DISTINCT 1 AS origen, e.inivelprivacidad, act.inivelprivacidad AS inivelactuacion, 
null AS fuenteopor, null AS tipoopor, null AS desviaciontiempo, 
(CAST(act.inumexp AS varchar) + '-' + CAST(act.iyear AS varchar) + '-' + CAST(act.dfechaact AS varchar) + '-' + CAST(act.linea AS varchar)) AS idAct, 
act.tipoactu, act.dfechaavi, act.dfecharec, act.dfechase, act.dfechaven, act.facturado, act.fase, act.linea, act.orden, act.porcentaje, act.preciofact, act.precioneto, 
act.precionofact, act.subusu, act.tiempofact, act.tiemponeto, act.tiemponofact, act.preciocoste, act.tiempoprevisto, act.precio, act.tiempo, act.acturealizada, 
c.codigo, act.inumexp AS inumexp, e.codcliente AS icodcli, act.dfechaact, act.iyear AS iyear, e.anyo AS anyo, c.snombrecli, act.id, act.tipo, 
e.codsubusu AS expusu, itipoexp, itipoasunto, e.codcontrario, act.backcolor, e.codpropro AS codabopropio, 

CONVERT(varchar(50), act.inumexp) + '&' + CONVERT(varchar(50), act.iyear) AS idexp, e.idcentros, e.codproce, e.codabocon AS codabocontrario, e.codsubusu AS codusuficha, 
act.subusucre, excliprincipal.numreferencia AS numReferenciaCliente, act.tipoClase, act.aula, act.numplazas AS plazastotales, DATENAME(weekday, act.dfechaact) AS diaSemana, 
tipoexp.tipoexp AS tipocurso, act.preciocoste - (act.preciocoste * (ISNULL(act.porretencion, 0)) / 100) AS preciocosteneto, ISNULL(act.porretencion, 0) AS porretencion, 
ct.sdescripcion AS descripcionTarifa, ISNULL(e.enpapelera, 0) AS expenpapelera 

--[camposperso] 

, MARCAFROM

FROM [[instancia]advabousu[empresa]].dbo.segexp act 

LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien e ON act.inumexp = e.inumexp AND act.iyear = e.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedienresumen er ON act.inumexp = er.inumexp AND act.iyear = er.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes c ON e.codcliente = c.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext cext ON c.icodcli = cext.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s ON act.subusu = s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu s2 ON e.codsubusu = s2.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoexp ON tipoexp.codigo = e.itipoexp
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tipoasun ON tipoasun.codigo = e.itipoasunto
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef ON e.idcentros = centrospredef.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.exclipro exCliPrincipal ON exCliPrincipal.icodcli = c.icodcli AND exCliPrincipal.inumexp = e.inumexp AND exCliPrincipal.iyear = e.iyear
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu sbcre ON sbcre.icodsubusu = act.subusucre
LEFT JOIN [[instancia]advabousu[empresa]].dbo.actuaci actua ON actua.codigo = act.icodigoactupredef
LEFT JOIN [[instancia]advabousu[empresa]].dbo.comision ON comision.id = act.idcomision
LEFT JOIN [[instancia]advabousu[empresa]].dbo.comisionTipoOpor ON comisionTipoOpor.id = act.idTipoComision
LEFT JOIN [[instancia]advabousu[empresa]].dbo.CosteTrabajador ct ON ct.id = act.idcostetrabajador
LEFT JOIN [[instancia]advabousu[empresa]].dbo.segresumen SR ON SR.idactuacion = act.id AND SR.tipo = 0
LEFT JOIN (SELECT segExpAl.inumexp, segExpAl.iyear, segExpAl.dfechaact, segExpAl.linea, 
(SELECT snombrecli + ' ### ' 
FROM [[instancia]advabousu[empresa]].dbo.clientes 
WHERE clientes.icodcli IN (SELECT icodalum FROM segexpAlumnos sea WHERE sea.inumexp = segExpAl.inumexp AND sea.iyear = segExpAl.iyear AND sea.dfechaact = segExpAl.dfechaact AND sea.linea = segExpAl.linea) 
FOR XML PATH ('')) AS nombreAlumnos 
FROM [[instancia]advabousu[empresa]].dbo.segexpAlumnos segExpAl 
GROUP BY segExpAl.inumexp, segExpAl.iyear, segExpAl.dfechaact, segExpAl.linea) alum 
ON act.inumexp = alum.inumexp AND act.iyear = alum.iyear AND act.linea = alum.linea AND act.dfechaact = alum.dfechaact 

 --[leftjoinperso] 

WHERE (ISNULL(tipo, '') IN ('--[descTipoActuPredef]') AND (expenpapelera <> 1))","select notas, notas2, notas3, notas4, notas5, notas6
from segexp",inumexp:INT|dfechaact:DATETIME|iyear:INT|linea:INT,EtiqExpedientesProp,,,1,,,,,
493,105,Bases de Datos,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.inumexp, o.iyear, o.tipooportunidad, o.icodusu, o.icodcliRelacionado, o.fechacierre, o.backcolor,
o.oportunidad, o.tipo, o.etapa, o.estado, o.serie, o.numopor, C.snombrecli, C.stelefonocli as clitfo1, C.telefono2 as clitfo2, C.telefono3 as clitfo3, C.smovilcli as climvl, C.tipofichero,
null as descripcionExp, null as numExp, null as yearExp, null as itipoexp, null as itipoasunto, null as codproce, null as srefabogado, null as srefcliente, null as usuarioExp,
null as idexp,
su1.nombre as nombreUsuario, su2.nombre as nombreCreador
--[camposperso]
FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes C ON C.icodcli = o.icodcli 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes C2 ON C2.icodcli = o.icodcliRelacionado
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON CR.icodcli = C.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor
LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen ON oporresumen.icodopor = o.icodopor
--[leftjoinperso]
WHERE tipooportunidad = 3 and inumexp is null",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Bases de Datos,,,0,,0,,,
494,105,Expedientes,"SELECT o.icodcli, o.dfecha, o.linea, o.icodopor, o.inumexp, o.iyear, o.tipooportunidad, o.icodusu, o.icodcliRelacionado, o.fechacierre, o.backcolor,
o.oportunidad, o.tipo, o.etapa, o.estado, o.serie, o.numopor, C.snombrecli, C.stelefonocli as clitfo1, C.telefono2 as clitfo2, C.telefono3 as clitfo3, C.smovilcli as climvl, C.tipofichero,
E.descripcion as descripcionExp, E.expediente as numExp, E.iyear as yearExp, E.itipoexp, E.itipoasunto, E.codproce, E.srefabogado, E.srefcliente, E.codsubusu as usuarioExp,
convert(varchar(50), E.inumexp) + '&' +  convert(varchar(50), E.iyear) as idexp,
su1.nombre as nombreUsuario, su2.nombre as nombreCreador
--[camposperso]
FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes C ON C.icodcli = o.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes C2 ON C2.icodcli = o.icodcliRelacionado
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON CR.icodcli = C.icodcli 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.expedien E ON E.inumexp = o.inumexp AND E.iyear = o.iyear 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su1 ON su1.icodsubusu = o.icodusu 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu su2 ON su2.icodsubusu = o.creadopor
LEFT JOIN [[instancia]advabousu[empresa]].dbo.oporresumen ON oporresumen.icodopor = o.icodopor 
--[leftjoinperso]
WHERE tipooportunidad = 3 and inumexp is not null",,icodopor:INT|icodcli:INT|linea:INT|dfecha:DATETIME,Expedientes,,,0,,0,,,
495,106,Articulos,"select A.id,A.indice,A.orden,A.descripcion,A.codigo,A.referencia,A.descatalogado,A.codprove,A.margen,
A.preciovenSI,A.preciovenI,A.preciocoste,A.unidad,A.tipo,A.fecha,A.iva,A.notas,
A.ubicacion,A.stockR,A.stockV,A.stockM,A.PUMP,A.pedprov,A.pedclie,A.talla,A.color,A.campo1,A.campo2,
A.campo3,A.campo4,A.campo5,A.campo6,A.campo7,A.campo8,A.campofecha1,A.campofecha2,A.campofecha3,
A.campofecha4,A.stockMax,A.idalmacen,A.tipounidad,A.tipomargen,A.pormargen,
A.stockkit,A.notas2,A.notas3,A.notas4,A.notas5,A.notas6,A.codificacion,A.codigobarras,A.idpestana,A.tipomedicacion,
A.tipoalmacen,A.tipoenvase,A.notasmed,A.notasmed2,A.notasmed3,A.notasmed4,A.notasmed5,A.notasmed6,
A.idpactivos,A.propiedad1,A.propiedad2,A.propiedad3,A.propiedad4,A.propfecha1,A.propfecha2,A.propfecha3,
A.propfecha4,A.idfamilia,A.idsubfamilia,A.backcolor,
(case when isnull(descatalogado,0)=1 then upper('D') + 'escatalogado' else upper('E') + 'n ' + upper('C') + 'atálogo' end) as estado,
C.snombrecli as nomproveedor,(case when tipomargen=1 then upper('I') + 'ndirecto' else upper('D') + 'irecto' end) as nomtipomargen,
F.nombre as nomfamilia, SF.nombre as subfamilia, T.udsentradas, T.udssalidas, T.preciototalentradas, T.preciototalsalidas, 
udsentradas * a.preciocoste as preciocostetotalentradas,
udssalidas* a.preciocoste as preciocostetotalsalidas 
--[camposperso] 
, MARCAFROM from [[instancia]advabousu[empresa]].dbo.articulos A
left join [[instancia]advabousu[empresa]].dbo.clientes C on A.codprove = C.icodcli
left join [[instancia]advabousu[empresa]].dbo.familias F on F.id = A.idfamilia
left join [[instancia]advabousu[empresa]].dbo.subfamilias SF on SF.id = A.idsubfamilia
left join (select movstock.idarticulo,
	isnull(sum(case upper(tipo) when 'ENTRADA' then movstock.unidades end), 0) as udsentradas,
	isnull(sum(case upper(tipo) when 'SALIDA' then movstock.unidades end), 0) as udssalidas,
	sum(case upper(tipo) when 'ENTRADA' then isnull(lotes.unidades, movstock.unidades) * movstock.preciouni end) as preciototalentradas,
	sum(case upper(tipo) when 'SALIDA' then isnull(lotes.unidades, movstock.unidades) * movstock.preciouni end) as preciototalsalidas
	from [[instancia]advabousu[empresa]].dbo.movstock 
	left join [[instancia]advabousu[empresa]].dbo.lotes on lotes.idarticulo=movstock.idarticulo and lotes.fecha=movstock.fecha and lotes.linea=movstock.linea
	group by movstock.idarticulo) T on A.id = T.idarticulo
--[leftjoinperso]",,id:INT,Articulos,,,0,,0,,,
779,107,Recursos,"SELECT
C.icodcli,C.tipobd,C.codsubusu,C.snombrecli,C.fechaalta,C.inivelprivacidad,
c.snifcli,
c.smovilcli,
c.stelefonocli,
c.telefono2,
c.telefono3,
c.snombreclicomercial,

C.idcentros,CEXT.backcolor,CEXT.recursotipo,S.nombre as nomsubusu

--[camposperfil]
--[camposperso]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes CT on CEXT.codtercero = CT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu S ON C.CodSubUSu = S.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.centrospredef CP on C.idcentros = CP.id 
LEFT JOIN [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
LEFT JOIN [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
LEFT JOIN [[instancia]advabocom].dbo.gestorcuadro GC on CEXT.idGestorCuadroRendimiento = GC.id

--[leftjoinperfil]
--[leftjoinperso]

WHERE tipobd in (13) AND ISNULL(recursotipo, 0) = 0","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,Recursos,0,,0,,,,,
780,103,Trabajadores Activos,"select snombrecli,departamento,sactuacion,fecharealizacion,dfechaact from segcli sg inner join clientes c on sg.icodcli = c.icodcli where sactuacion = 'jornada laboral' and fecharealizacion is null",,snombrecli:VARCHAR:100|departamento:VARCHAR:200,Trabajadores Activos,,,0,,0,,,
781,86,Recursos,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, 
	oporcli.ordenprioridad, oporcli.porprogreso,   oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre, 
	oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr, 
	r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev,   oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, 
	SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,     
	cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad, 
	(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
	, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
	, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
	, subusu.nombre as subusuario, subusuCli.nombre as NombreClienteUsuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.horaalta, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea    
	,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
	--[camposperfil]  
	--[camposperso]    
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (1)  
	left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
	LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
		FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
		GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
	left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id  
	left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos  
	left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
	LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext 
	ON facext.icodopor = oporcli.icodopor 
	left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
     
	--[leftjoinperfil]  
	--[leftjoinperso]    
	where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Recursos,13,bVerRecursos,0,,,424,,
782,111,Expedientes,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesAdjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora, 
	adjuntos.nombreReal, 
	adjuntos.titulo, 
	propiedadesadjun.tipoAdjun, 
	adjuntos.origen, 
	cli.snombrecli, 
	ENTIDAD.codcliente as icodcli,
	ENTIDAD.expediente as codigoexp, 
	ENTIDAD.inumexp,
	ENTIDAD.iyear, 
	ENTIDAD.descripcion as descripcionExp, MARCAFROM

  from ( (select expadjun.inumexp,expadjun.iyear,CAST('1900-01-01 00:00:00.000' AS datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, 
				descripcion as titulo, imagen as nombrecarta,
				 CASE 
					WHEN ((expadjun.origen = 1) and (expadjun.lineaorigen is not null) and (expadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((expadjun.origen = 2) and (expadjun.lineaorigen is not null) and (expadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((expadjun.origen = 3) and (expadjun.lineaorigen is not null) and (expadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((expadjun.origen = 4) and (expadjun.lineaorigen is not null) and (expadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((expadjun.origen = 5) and (expadjun.lineaorigen is not null) and (expadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((expadjun.origen = 6) and (expadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((expadjun.origen = 7) and (expadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((expadjun.origen = 8) and (expadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((expadjun.origen = 9) and (expadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((expadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((expadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((expadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((expadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((expadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen,
				 expadjun.idAdjun as idAdjunto,
				 cast(1 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal] 
				FROM [[instancia]advabousu[empresa]].dbo.expadjun )  
				union all 
					(select e.inumexp, e.iyear, e.dfechaactuacion as fechaactuacion, e.lineaactu as linea, e.fecha as fechadcto,  
					e.descripcion as titulo, e.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, e.idAdjun as idAdjunto,
					cast(2 as smallint) as idTabla,
					REVERSE(SUBSTRING(REVERSE(CASE WHEN e.imagen IS NOT NULL OR e.imagen <> '' THEN (RIGHT(e.imagen, CASE WHEN CHARINDEX('\', REVERSE(e.imagen)) > 0 THEN CHARINDEX('\', REVERSE(e.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN e.imagen IS NOT NULL OR e.imagen <> '' THEN (RIGHT(e.imagen, CASE WHEN CHARINDEX('\', REVERSE(e.imagen)) > 0 THEN CHARINDEX('\', REVERSE(e.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal] 
					FROM [[instancia]advabousu[empresa]].dbo.expimage e 
					) 

					union all

					(select e.inumexp, e.iyear, e.fechaactuacion, e.linea, e.fechadcto,  
					e.titulo, e.nombrecarta, '@{Documento del Historial}' as origen, e.idAdjun as idAdjunto,
					cast(3 as smallint) as idTabla,
					REVERSE(SUBSTRING(REVERSE(CASE WHEN e.nombrecarta IS NOT NULL OR e.nombrecarta <> '' THEN (RIGHT(e.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(e.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(e.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN e.nombrecarta IS NOT NULL OR e.nombrecarta <> '' THEN (RIGHT(e.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(e.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(e.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal] 
					FROM [[instancia]advabousu[empresa]].dbo.expedcto e )
					
					union all
					
					(select distinct
					mailasociacion.dcto as inumexp,
					mailasociacion.ano as iyear,
					mailasociacion.fechaseg as fechaactuacion,
					mailasociacion.lineaseg as linea,
					mail.fecha as fechadcto,
					adjuntos.descripcion as titulo,
					archivo as nombrecarta,
					'@{Adjunto de Correo}' as origen,
					adjuntos.idadjun as idadjunto,
					cast(0 as smallint) as idtabla,
					reverse(substring(reverse(case when archivo is not null or archivo <> '' then (right(archivo, case when charindex('\', reverse(archivo)) > 0 then charindex('\', reverse(archivo)) - 1 else 0 end )) else '' end ),  charindex('.', reverse(case when archivo is not null or archivo <> '' then (right(archivo, case when charindex('\', reverse(archivo)) > 0 then charindex('\', reverse(archivo)) - 1 else 0 end )) else '' end )) + 1, 999)) as [nombrereal]
					from [[instancia]advabocom].dbo.adjuntos
					inner join [[instancia]advabocom].dbo.mailasociacion on adjuntos.id = mailasociacion.idmail and mailasociacion.usuario = [empresa] and mailasociacion.ano is not null
					left join [[instancia]advabocom].dbo.mail on adjuntos.id = mail.id
					)  ) adjuntos
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.expedien ENTIDAD on adjuntos.INumExp = ENTIDAD.inumexp and adjuntos.IYear = ENTIDAD.iyear AND ENTIDAD.codcliente is not null
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segexp ACT on adjuntos.INumExp = ACT.inumexp and adjuntos.IYear = ACT.iyear and adjuntos.fechaactuacion = ACT.dfechaact  and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes cli on cli.icodcli = ENTIDAD.codcliente 
",,inumexp:INT|iyear:INT,EtiqExpedientesProp,,ver_exp|1,1,,,,,
783,111,Clientes,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 0
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,EtiqClientesProp,0,,1,,,,,
784,111,Trabajadores,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 1
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Trabajadores,1,,0,,,,,
785,111,Terceros,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 3
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,EtiqTercerosProp,3,,1,,,,,
786,111,Proveedores,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 9
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Proveedores,9,bverproveedor,0,,,,,
787,111,Pacientes,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 9
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Pacientes,9,bverpaciente,0,,,,,
788,111,Mutuas,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 8
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Aseguradoras,8,bverpaciente,0,,,,,
789,111,Mascotas,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 7
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,EtiqMascotasProp,7,bvermascota,1,,,,,
790,111,Compañías,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 6
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Compañías,6,bvercompania,0,,,,,
791,111,Alumnos,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 5
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Alumnos,5,bveralumno,0,,,,,
792,111,Voluntarios,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 10
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Voluntarios,10,bvervoluntarios,0,,,,,
793,111,Financiadores,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 11
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Financiadores,11,bVerFinancieras,0,,,,,
794,111,Tercera Edad,"Select distinct 
	adjuntos.idAdjunto,
	adjuntos.idTabla,
	propiedadesadjun.tipoRuta,
	adjuntos.nombrecarta,
	isnull (propiedadesAdjun.fechaHora ,adjuntos.fechadcto) as fechaHora,
	adjuntos.nombreReal,
	adjuntos.titulo,
	propiedadesadjun.tipoAdjun,
	adjuntos.origen,
	ENTIDAD.snombrecli,
	ENTIDAD.icodcli,
	null as codigoexp,
	null as inumexp,
	null as iyear,
	'' as descripcionexp, MARCAFROM
	from ( (select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,
				 CASE 
					WHEN ((cliadjun.origen = 1) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Cuentas}' 
					WHEN ((cliadjun.origen = 2) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas}'
					WHEN ((cliadjun.origen = 3) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas1}'
					WHEN ((cliadjun.origen = 4) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas2}'
					WHEN ((cliadjun.origen = 5) and (cliadjun.lineaorigen is not null) and (cliadjun.fechaorigen is not null)) THEN '@{Adjunto Previas3}'
					WHEN ((cliadjun.origen = 6) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Factura}'
					WHEN ((cliadjun.origen = 7) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Proforma}'
					WHEN ((cliadjun.origen = 8) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Presupuestos}'
					WHEN ((cliadjun.origen = 9) and (cliadjun.yearfactor is not null)) THEN '@{Adjunto Albaranes}'
					WHEN ((cliadjun.origen = 10)) THEN '@{Formulario}' 
					WHEN ((cliadjun.origen = 11)) THEN '@{Adjunto Pedidos}' 
					WHEN ((cliadjun.origen = 12)) THEN '@{Adjunto Orden de Trabajo}' 
					WHEN ((cliadjun.origen = 14)) THEN '@{Adjunto Previsión Cobro}'
					WHEN ((cliadjun.origen = 16)) THEN '@{Documento de Texto Temporal}' 
					ELSE '@{Adjunto}' END as origen ,  
                cliadjun.idAdjun as idAdjunto, cast(5 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
				from [[instancia]advabousu[empresa]].dbo.cliadjun )  

				union all

				(select c.icodcli, c.dfechaactuacion as fechaactuacion, c.lineaactu as linea, c.fecha as fechadcto,  c.descripcion as titulo, 
				c.imagen as nombrecarta,'@{Adjunto del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(6 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.imagen IS NOT NULL OR c.imagen <> '' THEN (RIGHT(c.imagen, CASE WHEN CHARINDEX('\', REVERSE(c.imagen)) > 0 THEN CHARINDEX('\', REVERSE(c.imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  

				from [[instancia]advabousu[empresa]].dbo.cliimage c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.dfechaactuacion and s.linea=c.lineaactu)

				union all

				(select c.icodcli, c.fechaactuacion, c.linea, c.fechadcto, c.titulo, c.nombrecarta, '@{Documento del Historial}' as origen, 
                c.idAdjun as idAdjunto, cast(7 as smallint) as idTabla, 
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c.nombrecarta IS NOT NULL OR c.nombrecarta <> '' THEN (RIGHT(c.nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(c.nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(c.nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.clidcto c left join [[instancia]advabousu[empresa]].dbo.segcli s on c.icodcli=s.icodcli and s.dfechaact=c.fechaactuacion and s.linea=c.linea)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo, 
				imagen as nombrecarta,'@{Adjunto Oportunidad}' as origen, 
                oporadjun.id as idAdjunto, cast(8 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.oporadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fechadcto, titulo, nombrecarta,
				'@{Adjunto Oportunidad}'  as origen,
                opordcto.id as idAdjunto, cast(9 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]  
                from [[instancia]advabousu[empresa]].dbo.opordcto)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, cast(0 as integer) as linea, fecha as fechadcto, descripcion as titulo,
				imagen as nombrecarta,'@{Adjunto Concepto Oportunidad}' as origen, 
                oporcuentasadjun.id as idAdjunto, cast(10 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN imagen IS NOT NULL OR imagen <> '' THEN (RIGHT(imagen, CASE WHEN CHARINDEX('\', REVERSE(imagen)) > 0 THEN CHARINDEX('\', REVERSE(imagen)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasadjun)

				union all

				(select icodcli,cast(null as datetime) as fechaactuacion, linea, fechadcto, titulo, nombrecarta,'@{Documento Concepto Oportunidad}'  as origen,  
                oporcuentasdcto.id as idAdjunto, cast(11 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN nombrecarta IS NOT NULL OR nombrecarta <> '' THEN (RIGHT(nombrecarta, CASE WHEN CHARINDEX('\', REVERSE(nombrecarta)) > 0 THEN CHARINDEX('\', REVERSE(nombrecarta)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.oporcuentasdcto)

				union all

				(select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
				descripcion as titulo, adjunto as nombrecarta, '@{Adjunto Obligación}' as origen, 
                c1.id as idAdjunto, cast(12 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN adjunto IS NOT NULL OR adjunto <> '' THEN (RIGHT(adjunto, CASE WHEN CHARINDEX('\', REVERSE(adjunto)) > 0 THEN CHARINDEX('\', REVERSE(adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
                from [[instancia]advabousu[empresa]].dbo.cliobligdetailadj c1 
                left join [[instancia]advabousu[empresa]].dbo.clientesobligdetalles c2 on c1.id_cliobligdetail=c2.id) 
                
                union all

                (select c2.icodcli, cast(null as datetime) as fechaactuacion, cast(null as integer) as linea, c1.fecha as fechadcto,
                c1.descripcion as titulo, c1.adjunto as nombrecarta, '@{Adjunto Vencimiento}' as origen, 
                c1.id as idAdjunto, cast(13 as smallint) as idTabla,
				 REVERSE(SUBSTRING(REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN c1.adjunto IS NOT NULL OR c1.adjunto <> '' THEN (RIGHT(c1.adjunto, CASE WHEN CHARINDEX('\', REVERSE(c1.adjunto)) > 0 THEN CHARINDEX('\', REVERSE(c1.adjunto)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]     
				from [[instancia]advabousu[empresa]].dbo.cliVenAdj c1 
                left join [[instancia]advabousu[empresa]].dbo.clivencimientos c2 on c1.idcliven=c2.id)
                
                union all
                
				(SELECT distinct
				mailasociacion.dcto as icodcli,
				mailasociacion.fechaseg as fechaactuacion,
				mailasociacion.lineaseg as linea,
				mail.fecha as fechadcto,
				adjuntos.descripcion as titulo,
				archivo as nombrecarta,
				'@{Adjunto de Correo}' as origen,
				adjuntos.idAdjun as idAdjunto,
				cast(0 as smallint) as idTabla,
				REVERSE(SUBSTRING(REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END ),  CHARINDEX('.', REVERSE(CASE WHEN archivo IS NOT NULL OR archivo <> '' THEN (RIGHT(archivo, CASE WHEN CHARINDEX('\', REVERSE(archivo)) > 0 THEN CHARINDEX('\', REVERSE(archivo)) - 1 ELSE 0 END )) ELSE '' END )) + 1, 999)) as [nombreReal]
				FROM [[instancia]advabocom].dbo.adjuntos
				INNER JOIN [[instancia]advabocom].dbo.mailasociacion ON adjuntos.Id = mailasociacion.idmail AND mailasociacion.usuario = [empresa] and mailasociacion.ano is null
				LEFT JOIN [[instancia]advabocom].dbo.mail ON adjuntos.Id = mail.id)
                 ) adjuntos 
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun ON adjuntos.idAdjunto = propiedadesAdjun.idAdjunOrigen and adjuntos.idTabla = propiedadesAdjun.idTablaOrigen
					INNER JOIN [[instancia]advabousu[empresa]].dbo.clientes ENTIDAD on adjuntos.icodcli = ENTIDAD.icodcli AND ENTIDAD.tipobd = 12
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.segcli ACT on adjuntos.icodcli = ACT.icodcli and adjuntos.fechaactuacion = ACT.dfechaact and adjuntos.linea = ACT.linea
					LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu USU_ACT on USU_ACT.icodsubusu = ACT.subusu
",,icodcli:INT,Terera Edad,12,bverterceraedad,0,,,,,
795,4,Trabajadores,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (1)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Trabajadores,1,,0,,,,,
796,4,Pacientes,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (4)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id  
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Pacientes,4,bverpaciente,0,,,,,
797,4,Compañías,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (6)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Compañías,6,bvercompania,0,,,,,
798,4,MascotaTutor,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp,icodcliInmueble 

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (7)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,MascotaTutor,7,bvermascota,0,,,,,
799,4,Mutua,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (8)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Mutua,8,bvermutua,0,,,,,
800,4,Proveedor,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (9)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Proveedor,9,,0,,,,,
801,4,Voluntario,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas  

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (10)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Voluntario,10,bvervoluntarios,0,,,,,
802,4,Financiador,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp,icodcliInmueble

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (11)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Financiador,11,bVerFinancieras,0,,,,,
803,4,TerceraEdad,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso, 
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,isnull(oporcli.etapa,'') as etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev, 
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1, C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor,  oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero,  C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp, icodcliInmueble, (SELECT COUNT(1) FROM segcli WHERE icodopor = oporcli.icodopor and tipo = 'visita') as numvisitas 

--[camposperfil]
--[camposperso]

 , MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
 left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
 left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
 left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
 inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (12)
 LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
 left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
 left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
 left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
 left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id   
 left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
 left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
 left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
 left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
 left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
 LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
			FROM [[instancia]advabousu[empresa]].dbo.tipoiva t 
			INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva 
			LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva 
			WHERE c.numcta LIKE '477%') tiva
		ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 
 --[leftjoinperfil]
 --[leftjoinperso]
 
 where (1 = 1)
  AND (tipooportunidad=0  OR tipooportunidad is null) ","select notas, notas1, notas2, notas3, notas4, notas5, notas6
	from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,TerceraEdad,12,bverterceraedad,0,,,,,
804,113,Diario,"SELECT 
	CONVERT(varchar(50),D.asiento) + '|' + CONVERT(varchar(50),D.linea) + '|' + convert(varchar(20), D.fecha, 23) as idClaveDiario,
	D.asiVer, D.asiento as numAsiento, D.fecha as fechaAsiento, D.linea as lineaAsiento,
	D.tipo as tipoAsiento, D.serie as serieAsiento,
	D.icodcli, D.idRemesa,
	d.codsubusu,
	CASE D.tipo WHEN 'H' then 1 else 0 END AS itipo, MARCAFROM
	FROM --[tabla_diario] D 
	LEFT JOIN propiedadesasiento p ON d.asiento = p.asiento AND p.ejercicio = --[anho_contable]
	LEFT JOIN clientes c ON d.icodcli=c.icodcli 
	LEFT JOIN subusu s ON s.icodsubusu = d.codsubusu 
	LEFT JOIN expedien e ON d.inumexp=e.inumexp and d.iyear=e.iyear 
	LEFT JOIN contagastos r ON d.asiento = r.asiento and YEAR(r.fecha) = --[anho_contable]
	LEFT JOIN prevpain pr ON isnull(d.esAgrupado,0)=0 and d.asiento = pr.asiento and pr.yearconta = --[anho_contable]
	LEFT JOIN facturas f ON d.asiento = f.asiefact and f.yearfact = --[anho_contable]
	LEFT JOIN tiposfactura tf ON tf.id=d.idtipofact 
	LEFT JOIN tiposrectificacion tr ON tr.id=d.idtiporect 
	left join --[tabla_cuentas] cuentas on cuentas.numcta = isnull(nullif(d.cuentadebe,''),d.cuentahaber)
	left join motivosujetoexento ms on ms.id = cuentas.idmotivoexento 
	left join motivosujetonoexento msno on msno.id=cuentas.idmotivonoexento ",,numAsiento:INT|fechaAsiento:DATETIME|lineaAsiento:INT,Diario,0,,0,,,,,
805,114,Albaranes Recibidos,"select cg.id, cg.fecha, cg.tipofact, cg.icodcli, cg.codsubusu as usuario, cg.backcolor, cg.totaldctoeuro, cg.baseimp, prov.tipofichero, cg.baseimp - cg.totaldctoeuro as baseimponible
from [[instancia]advabousu[empresa]].dbo.contagastos cg 
left join [[instancia]advabousu[empresa]].dbo.subusu usu on usu.icodsubusu = cg.codsubusu 
left join [[instancia]advabousu[empresa]].dbo.clientes prov on prov.tipobd = 9 and prov.icodcli = cg.icodcli
where tipofact = 3",,,Albaranes Recibidos,,,,,,,,
806,115,Control de Pagos,"select prevp.*, prevp.codsubusu as usuario, prov.tipofichero,
case when prevp.subusucre = 0 then upper('DESPACHO') else creador.nombre end as nombreCreador, prevp.subusucre as icodCreador
from [[instancia]advabousu[empresa]].dbo.prevpain prevp
left join [[instancia]advabousu[empresa]].dbo.subusu usu on usu.icodsubusu = prevp.codsubusu 
left join [[instancia]advabousu[empresa]].dbo.clientes prov on prov.icodcli = prevp.icodcli
left join [[instancia]advabousu[empresa]].dbo.contagastos cg on cg.id=prevp.idgasto
left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = prevp.subusucre",select notas from prevpain,tipo:INT|fecha:DATETIME|linea:INT,Control de Pagos,,,,,,,,
807,116,Cobros a Aseguradoras,"SELECT id, dfecha, c.icodcli, c.snombrecli, sactuacion, fimporte, 
icodmutua, snombremutua, numvolante, c.subusu, usu.nombre, facturar, ISNULL(facturado, 'N') as facturado, dfechaact, inumfactura, yearfact, serie,
cobrar, cobrado, dfechacobro, dfechafact, cli.codigo
FROM [[instancia]advabousu[empresa]].dbo.controlmutua c
left join [[instancia]advabousu[empresa]].dbo.subusu usu on usu.icodsubusu = c.subusu
left join  [[instancia]advabousu[empresa]].dbo.clientes cli on cli.icodcli = c.icodcli",,id:INT,Cobros a Aseguradoras,,,,,,,,
808,117,Cuentas,"select C.icodcli, cuencli.id, stipo = CASE when stipo='GASTO' then UPPER('s') + 'uplido' 
ELSE upper(substring(stipo,1,1)) + rtrim(lower(substring(stipo, 2, len(stipo)))) END,
cuencli.dfecha as fecha, null as fechavencimiento, c.snombrecli, cuencli.sdescripcion as concepto,

case when (fsalidaseuro is null or fsalidaseuro = 0) and fentradaseuro > 0
				then (fentradaseuro * (1 - (isnull(cuencli.dctolinea, 0) / 100))) * (1 - (isnull(cuencli.dcto, 0) / 100))
			when (fentradaseuro is null or fentradaseuro = 0) and fsalidaseuro > 0
				then (fsalidaseuro * (1 - (isnull(cuencli.dctolinea, 0) / 100))) * (1 - (isnull(cuencli.dcto, 0) / 100))
			else 0 end * ((1 + (ISNULL(cuencli.iva, 0)/100)) - (ISNULL(cuencli.irpf, 0)/100)) as total,
0 as cobradopagado, null as fechacobradopagado, null as formacobropago, S.nombre as usuario, S.icodsubusu as codigoUsuario, null as periodo, null as fechabaja, null as fechainivencimiento, null as mesesExcluidos,
cuencli.inumfactura, cuencli.serie, facturas.fecha as fechafact, tfact.descripcion as tipofactura,
e.expediente, e.iyear, e.descripcion as descripcionexpediente, e.srefabogado as refpropia,
isnull(cuencli.facturar, 0) as facturar, null as documento, null as fechadocumento,
0 as estaremesado, null as fecharemesa, null idremesa, null as cobroodontograma,
null as yearfechacobradopagado, null as mesfechacobradopagado, null as yearfechavencimiento, null as mesfechavencimiento,

case  when stipo = 'gasto' then total else 0 end as suplidos, 
case  when stipo not like 'gasto' then total else 0 end as prevision, 
0 as pagos, 0 as cobros, 0 as servicios, null as inumcobro 

from [[instancia]advabousu[empresa]].dbo.cuencli 
inner join [[instancia]advabousu[empresa]].dbo.clientes C on cuencli.icodcli=C.icodcli
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.subusu S on cuencli.codsubusu=S.icodsubusu 
left join [[instancia]advabousu[empresa]].dbo.facturas on facturas.yearfact = cuencli.yearfact
				and facturas.inumfactura = cuencli.inumfactura
				and facturas.codsubusu = cuencli.codsubusu
				and facturas.serie = cuencli.serie
left join [[instancia]advabousu[empresa]].dbo.tiposfactura tfact on tfact.id = facturas.idtipofact
left join [[instancia]advabousu[empresa]].dbo.expedien e on cuencli.inumexprelacionado=e.inumexp and cuencli.iyearrelacionado=e.iyear
where (stipo='provisión' or stipo='suplido')",,id:INT,,,,0,,,,,
809,117,Cobros,"select c.icodcli, p.id, UPPER('c') + 'obro' as stipo, p.fechaingreso as fecha, p.fecha as fechavencimiento, c.snombrecli,
p.concepto, p.total, isnull(p.cobrado,0) as cobradopagado, p.fechacobro as fechacobradopagado,
isnull(p.formapago,'otros') as formacobropago, subusu.nombre as usuario, subusu.icodsubusu as codigoUsuario, null as periodo, null as fechabaja, null as fechainivencimiento, null as mesesExcluidos,
p.inumfactura, p.serie, f.fecha as fechafact, tfact.descripcion as tipofactura,
e.expediente, e.iyear, e.descripcion as descripcionexpediente, e.srefabogado as refpropia,
isnull(p.facturar, 0) as facturar, null as documento, null as fechadocumento,
(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado, l.fecha as fecharemesa, r.idremesa, p.cobroodontograma,
year(p.fechacobro) as yearfechacobradopagado, month(p.fechacobro) as mesfechacobradopagado,
YEAR(p.fecha) as yearfechavencimiento, MONTH(p.fecha) as mesfechavencimiento,
0 as suplidos,
0 as prevision,
0 as pagos,
p.total as cobros,
0 as servicios, inumcobro 

from [[instancia]advabousu[empresa]].dbo.prevcobros p
left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
f.codsubusu=p.subusufact and f.serie=p.serie
left join [[instancia]advabousu[empresa]].dbo.tiposfactura tfact on tfact.id = f.idtipofact
left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
inner join [[instancia]advabousu[empresa]].dbo.clientes as c on p.inumexp=c.icodcli and p.origen='cli'
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
left join [[instancia]advabousu[empresa]].dbo.vListadoCobrosCurso vistac on vistac.id=p.id 
left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli

--leftjoinperfil
--leftjoinperso

where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,,,,0,,,,,
810,117,Pagos,"select prov.icodcli, p.id, UPPER('p') + 'ago' as stipo, p.fechagasing as fecha, p.fecha as fechavencimiento, prov.snombrecli,
p.concepto, p.total, ISNULL(p.realizada, 0) as cobradopagado, p.fecharealizada as fechacobradopagado,
p.formapago as formacobropago, usu.nombre as usuario, usu.icodsubusu as codigoUsuario, null as periodo, null as fechabaja, null as fechainivencimiento, null as mesesExcluidos,
p.inumfact as inumfactura, p.serie, cg.fecha as fechafact, case when cg.idtipofact is null then '' else (select descripcion from [[instancia]advabousu[empresa]].dbo.tiposfactura where id=cg.idtipofact) end as tipofactura,
null as expediente, null as iyear, null as descripcionexpediente, null as refpropia,
0 as facturar, cg.documento, cg.fechadocumento,
0 as estaremesado, null as fecharemesa, null idremesa, null as cobroodontograma,
year(p.fecharealizada) as yearfechacobradopagado, month(p.fecharealizada) as mesfechacobradopagado,
YEAR(p.fecha) as yearfechavencimiento, MONTH(p.fecha) as mesfechavencimiento,
0 as suplidos,
0 as prevision,
p.total as pagos,
0 as cobros, 0 as servicios, null as inumcobro 

from [[instancia]advabousu[empresa]].dbo.prevpain p
left join [[instancia]advabousu[empresa]].dbo.subusu usu on usu.icodsubusu = p.codsubusu 
left join [[instancia]advabousu[empresa]].dbo.clientes prov on prov.icodcli = p.icodcli
left join [[instancia]advabousu[empresa]].dbo.contagastos cg on cg.id=p.idgasto",,id:INT,,,,0,,,,,
811,118,Mascotas,"SELECT 
M.icodcli,M.tipobd,M.codigo,M.snombrecli, M.fechaalta, M.fechabaja, M.estadocli,
M.idcentros,centrospredef.sdescripcion as nombrecentro, 
M.codsubusu, CASE WHEN ISNULL(U.icodsubusu,0) = 0 THEN upper('DESPACHO') ELSE U.nombre END as usuario, tf.tipofichero as tipocliente,
C.icodcli as icodcliente, C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3, C.snifcli, c.snombreclicomercial, CEX.backcolor

--[camposperso]

FROM clientes M
LEFT JOIN centrospredef on M.idcentros = centrospredef.id
LEFT JOIN clientesext CEX on CEX.icodcli = M.icodcli
LEFT JOIN subusu U on M.codsubusu = U.icodsubusu
LEFT JOIN clientes C on C.icodcli = CEX.codcliente
LEFT JOIN tipoficherocli tf on tf.tipobd = C.tipobd
LEFT JOIN clientesresumen CR on M.icodcli = CR.icodcli
LEFT JOIN clientesresumen CC on C.icodcli = CC.icodcli
 --[leftjoinperso]
WHERE tipobd in (14)","select notas, notas2, notas3, notas4, notas5, notas6
from clientes",icodcli:INT,TituloMascotaPl,0,,1,,,,,
812,119,Clientes,"select oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,NULLIF(oporcli.icodusu,0) as icodusu, 
oporcli.icodpro,oporcli.estado,oporcli.etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre,
oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,
oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento, oporcli.icodcliRelacionado, oporcli.fechafinprev,

cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000 else case when fechacierre is null then convert( int, datediff(day, getdate(), 
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, aso.snombrecli as nombreAsociado,
C.snombrecli as nombreCliente,

oporcli.inumexp as inumexpediente,
oporcli.iyear as iyearexpediente,
expedien.descripcion AS descExp,
subusu.nombre as subusuario,
C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3, C.email, C.referencia as refpropiaexp,
C.snifcli as nifcliente, C.referencia AS refcliente,
C.sdomiciliocli, C.scodpostalcli, C.sprovinciacli, C.spoblacioncli, C.sNombrePais,
expedien.sdirArq, expedien.spobArq, expedien.sprovArq, expedien.scpArq, te.tipoexp as tipoexp, oporcli.backcolor,

case when oporcli.inumexp is null then '' else
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) end as idexp,
CASE WHEN dfecha IS NULL THEN null
WHEN horaalta IS NULL THEN DATETIMEFROMPARTS(year(dfecha), month(dfecha), day(dfecha), DATEPART(hour, 0), DATEPART(minute, 0), DATEPART(second, 0), DATEPART(MILLISECOND, 0))
ELSE DATETIMEFROMPARTS(year(dfecha), month(dfecha), day(dfecha), DATEPART(hour, horaalta), DATEPART(minute, horaalta), DATEPART(second, horaalta), DATEPART(MILLISECOND, horaalta))
END as FechaIniCompleta,
CASE WHEN fechacierre IS NULL THEN null
WHEN hora IS NULL THEN DATETIMEFROMPARTS(year(fechacierre), month(fechacierre), day(fechacierre), DATEPART(hour, 0), DATEPART(minute, 0), DATEPART(second, 0), DATEPART(MILLISECOND, 0))
ELSE DATETIMEFROMPARTS(year(fechacierre), month(fechacierre), day(fechacierre), DATEPART(hour, hora), DATEPART(minute, hora), DATEPART(second, hora), DATEPART(MILLISECOND, hora))
END as FechaFinCompleta,

CONVERT(varchar,horaalta,24) + CASE WHEN hora IS NULL THEN '' ELSE '-' + CONVERT(varchar,hora,24) END as horainihorafin

--[camposperfil]
--[camposperso]

from [[instancia]advabousu[empresa]].dbo.oporcli
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
left join [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado 
left join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and C.tipobd in (0)
left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
left join [[instancia]advabousu[empresa]].dbo.tipoexp te on expedien.itipoexp = te.codigo
left join [[instancia]advabousu[empresa]].dbo.subusu subexp on subexp.icodsubusu = expedien.codsubusu

--[leftjoinperfil]
--[leftjoinperso]

where (1 = 1)
 AND tipooportunidad=4 ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Clientes,0,,0,," from [[instancia]advabousu[empresa]].dbo.oporcli left join subusu on subusu.icodsubusu = oporcli.icodusu
inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli and tipobd in ([tabla])
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id",,,
813,1,Mascotas,"select 2 as origen, c.inivelprivacidad, act.inivelprivacidad as inivelactuacion,
null as fuenteopor, null as tipoopor, null as desviaciontiempo, CAST(act.id as varchar) + '-2' as idSubusus,
(CAST(act.icodcli as varchar) + '-' + CAST(act.dfechaact as varchar) + '-' + CAST(act.linea as varchar)) as idAct,
act.tipoactu,act.dfechaavi,act.thoraavi,act.dfecharec,act.dfechase,act.dfechaven,
act.facturado,act.fase,act.linea,act.orden,act.porcentaje,act.preciofact,act.precioneto,
act.precionofact,act.subusu,act.tiempofact,act.tiemponeto,act.tiemponofact,
act.preciocoste,act.tiempoprevisto,act.precio,act.tiempo,act.acturealizada,
c.codigo,cliext.numero,null as inumexp,act.icodcli as icodcli,act.dfechaact,o.iyear as iyear,
c.snombrecli, act.id, act.tipo, act.privada,
null as expusu, null as itipoexp,null as itipoasunto, null as codcontrario, null as anyo, 
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.tiempo else 0 end as tiempofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.tiempo else 0 end as tiemposinfacturar,
case when act.facturable is null or act.facturable < 1 then act.tiempo else 0 end as tiemponofacturable,
case when act.facturado is not null and act.facturado > 0 and act.numfactura is not null and act.numfactura > 0 then act.precio else 0 end as preciofacturado,
case when act.facturable is not null and act.facturable > 0 and (act.facturado is null or act.facturado < 1) then act.precio else 0 end as preciosinfacturar,
case when act.facturable is null or act.facturable < 1 then act.precio else 0 end as precionofacturable, act.backcolor,
null as codabopropio, null as idexp ,
c.idcentros, null as codproce ,
null as codabocontrario,
c.codsubusu as codusuficha,
act.subusucre, '' AS numReferenciaCliente, null as icodclitercero
,costetrabajador.sdescripcion as descriptarifa,cliext.codmutua as codmutua,
pv.cobrado as estadocobrado, case when pv.factura = 1 then null else pv.inumcobro end as inumcobro, 
ISNULL(act.numfactura, cmutua.inumfactura) as numfactura, ISNULL(act.yearfact, cmutua.yearfact) as yearfact, act.preciocoste - (act.preciocoste * (isnull(act.porretencion, 0)) / 100 ) as preciocosteneto, isnull(act.porretencion, 0) as porretencion,
null as nombrepaciente,
null as juzgadoact, null as codjuzgaactu, act.idTarifa, NULL AS codclitrabajador, act.tipohistotr, act.dfecharesolucion, act.icodcliPagador, pagador.snombrecli AS Pagador, act.idEstadoCita, NULL AS expenpapelera, DATENAME(weekday, act.dfechaact) AS diaSemana

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.segcli act

inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and tipobd = 14
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.subusu s2 on c.codsubusu=s2.icodsubusu
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on c.idcentros = centrospredef.id
-- left join [[instancia]advabousu[empresa]].dbo.ActuPrevias ap on act.icodcli = ap.icodcliSegcli and act.dfechaact = ap.dfechaactSegcli and act.linea = ap.lineaSegcli
-- left join [[instancia]advabousu[empresa]].dbo.Bonos b on ap.idBonos = b.id
left join [[instancia]advabousu[empresa]].dbo.Bonos b on act.idBono = b.id
left join [[instancia]advabousu[empresa]].dbo.vListadoBonos lb on lb.id=b.id
left join [[instancia]advabousu[empresa]].dbo.peticioncli on peticioncli.id=act.idpeticion
left join [[instancia]advabousu[empresa]].dbo.clientesext cliext on act.icodcli = cliext.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientes clipral on cliext.codcliente = clipral.icodcli
left join [[instancia]advabousu[empresa]].dbo.clientes mutuas on cliext.codmutua = mutuas.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu sbcre on sbcre.icodsubusu=act.subusucre
left join 
(
	select cli.icodcli,cli.CodSubUSu,cli.tipobd,codigo,snombrecli,sector,fechaalta,fechabaja,cext.dpto,
	row_number() over(partition by codsubusu order by cli.icodcli asc) rnu
	from [[instancia]advabousu[empresa]].dbo.clientes cli
	left join [[instancia]advabousu[empresa]].dbo.clientesext cext on cli.icodcli = cext.icodcli
	where tipobd = 1
) worker on worker.codsubusu = act.subusu and act.subusu > 0 and worker.rnu = 1
left join [[instancia]advabousu[empresa]].dbo.actuaci actua on actua.codigo = act.icodigoactupredef
left join [[instancia]advabousu[empresa]].dbo.tarifas on tarifas.idTarifa = act.idTarifa
left join [[instancia]advabousu[empresa]].dbo.clientes pagador ON pagador.icodcli = act.icodcliPagador
left join [[instancia]advabousu[empresa]].dbo.controlmutua cmutua on cmutua.icodcli = act.icodcli and cmutua.dfechaact = act.dfechaact and cmutua.lineaact = act.linea
left join [[instancia]advabousu[empresa]].dbo.[events] eventos
on eventos.inumexp = act.icodcli and eventos.lineaact = act.linea and eventos.origen = 5
and eventos.dfechaact = act.dfechaact and eventos.tipo IN ('ac', 's', 'v')

left join [[instancia]advabousu[empresa]].dbo.[ValoracionActuacionCliente] val on val.actuacion = act.id and val.tipoActuacion = 5
left join [[instancia]advabousu[empresa]].dbo.contacto on act.icodContacto = contacto.codcontacto
left join [[instancia]advabousu[empresa]].dbo.costetrabajador on act.idcostetrabajador= costetrabajador.id
left join [[instancia]advabousu[empresa]].dbo.prevcobros pv on act.idprevcobros = pv.id
left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = act.idcomision
left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = act.idTipoComision
left join [[instancia]advabousu[empresa]].dbo.oporcli o on act.icodopor = o.icodopor
left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = o.inumexp and e.iyear = o.iyear
left join [[instancia]advabousu[empresa]].dbo.tipoexp tipodeexp  on tipodeexp.codigo=e.itipoexp
left join 
(
	select clipac.icodcli, clipac.icodpaciente, clipacrel.snombrecli, 
	ROW_NUMBER() OVER(PARTITION BY icodpaciente ORDER BY ID ASC) rn
	from [[instancia]advabousu[empresa]].dbo.clipacientes clipac
	left join [[instancia]advabousu[empresa]].dbo.clientes clipacrel on clipac.icodcli = clipacrel.icodcli
) clirel on clirel.icodpaciente = act.icodcli and rn = 1
left join 
(
	select cliter.icodcli, cliter.icodclitercero, clitercrel.snombrecli,
	ROW_NUMBER() OVER(PARTITION BY cliter.icodcli ORDER BY ID ASC) rn2
	from [[instancia]advabousu[empresa]].dbo.cliterceros cliter
	left join [[instancia]advabousu[empresa]].dbo.clientes clitercrel on cliter.icodclitercero = clitercrel.icodcli
) cliterc on cliterc.icodcli = act.icodcli and rn2 = 1
	--[leftjoinperfil]
	--[leftjoinperso]

where (ISNULL(tipoactu, '') NOT IN ('plan individual', 'aviso')) AND (ISNULL(tipohistotr, 0) <> 3) AND (ISNULL(tipo, '') NOT IN ('Control Horario'))","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|linea:INT|dfechaact:DATETIME,Mascotas,,bVerMascotas,0,,,,,
814,86,Mascotas,"select oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor, oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu,
oporcli.ordenprioridad, oporcli.porprogreso, oporcli.icodpro,oporcli.estado,isnull(oporcli.etapa,'') as etapa,oporcli.tipo,oporcli.codigo,oporcli.prevision,oporcli.fechacierre,
oporcli.importecierre,oporcli.oportunidad,oporcli.campofecha1,oporcli.camponum3,C.idcentros,C.inivelprivacidad, oporcli.tiempoprev, ISNULL(r.sumTiempoTR, 0) as sumtiempotr,
r.saldorecobros, oporcli.puntos, oporcli.fechainiprev, oporcli.fechafinprev, oporcli.tipooportunidad, oporcli.fechaseguimiento, oporcli.horaseguimiento,
SU2.nombre as apoyoresponsable, oporcli.campo18, oporcli.codusuapoyo, oporcli.backcolor, SU3.nombre as creadopor,
cast(isnull(convert( int, case when oporcli.dfecha is null then -5000 else convert( int, datediff(day, oporcli.dfecha, (case when oporcli.fechacierre <= getdate() then oporcli.fechacierre else getdate() end))) end), -5000) as int) as cliedad,
(cast(tiempoprev as float) * (cast(porprogreso as float)/100)) as tiemporealprev, null as idexp, aso.snombrecli as nombreAsociado 
, r.sumCosteSegcliNoGastos, r.sumCosteSegcliGastos, ISNULL(r.sumCosteSegcliNoGastos,0) + ISNULL(r.sumCosteSegcliGastos,0) as sumCosteSegcli
, saldos.TotEntradas, saldos.TotSalidas, saldos.TotEntradas - saldos.TotSalidas as saldoRecobro
, subusu.nombre as subusuario, null as tipoexpedien, null as itipoexp, null as tipoasun, oporcli.idcentro, null as sdirArq, null as spobArq, c.snombrecli as nombreFicha, tar.codsubusu as subusutarea, SU4.nombre as nombreUsuarioTarea
,CB.IBAN as ibanopor, oporcli.horacreacion, cast(oporcli.hora as time) as horacierre
--[camposperfil]
--[camposperso]
, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (14)
left join [[instancia]advabousu[empresa]].dbo.subusu as subusuCli on subusuCli.icodsubusu = C.codsubusu	
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes aso ON aso.icodcli = oporcli.icodcliRelacionado
LEFT JOIN (select o.icodopor, SUM(reco.fentradaseuro) as TotEntradas, SUM(reco.fsalidaseuro) as TotSalidas
	FROM [[instancia]advabousu[empresa]].dbo.oporcli o 
	LEFT JOIN [[instancia]advabousu[empresa]].dbo.previcli reco ON reco.icodopor IS NOT NULL AND reco.icodopor = o.icodopor 
	GROUP BY o.icodopor) saldos ON oporcli.icodopor = saldos.icodopor
left join [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrotarea on oporcli.idcentro = centrotarea.id
left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
left join [[instancia]advabousu[empresa]].dbo.subusu SU2 on SU2.icodsubusu = oporcli.codusuapoyo
left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor
left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subTareaAccion ST ON oporcli.idSubtareaAccion = ST.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.tareaAcciones TAR ON ST.idTarea = TAR.id
LEFT JOIN [[instancia]advabousu[empresa]].dbo.subusu SU4 on SU4.icodsubusu = TAR.codsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clibancos CB on CB.icodcli = oporcli.icodcli AND CB.linea=oporcli.lineaClibancos
LEFT JOIN (select icodopor,sum(round(facturado,2)) as facturado  from
				(SELECT cbp.icodopor, sum(line.salidaeuro) as facturado
				FROM [[instancia]advabousu[empresa]].dbo.linefact line
				INNER JOIN [[instancia]advabousu[empresa]].dbo.cobroParcialOporcli cbp ON cbp.yearfact = line.yearfact AND cbp.inumfactura = line.inumfactura 
				AND cbp.codsubusu = line.codsubusu AND cbp.serie = line.serie AND cbp.fechaconcep = line.fechaconcep AND cbp.linea = line.linea 
				LEFT JOIN [[instancia]advabousu[empresa]].dbo.cuencli on cuencli.icodcli = line.inumexpexho and cuencli.dfecha = line.fechaconcep and cuencli.linea=line.lineacuentas
				GROUP BY cbp.icodopor, cuencli.ctaiva,cuencli.CtaServArt,cuencli.modelosIVA,cuencli.inumfactura,cuencli.yearfact,cuencli.codsubusu,cuencli.serie )tcbp
		   GROUP BY tcbp.icodopor) facext
ON facext.icodopor = oporcli.icodopor
left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
 left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision

--[leftjoinperfil]
--[leftjoinperso]
where tipooportunidad=1 AND inumexpOpor IS NULL AND iyearOpor IS NULL ","SELECT notas, notas1, notas2, notas3, notas4, notas5, notas6 FROM oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,EtiqMascotasProp,14,bVerMascotas,1,,,424,,
815,4,Mascotas,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso,
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,oporcli.etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev,
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1,C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor, oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero, C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(),
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli
left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (14)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id
left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
		FROM [[instancia]advabousu[empresa]].dbo.tipoiva t
		INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva
		WHERE c.numcta LIKE '477%') tiva
	ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn,  
		d.tipoVia + ' ' + d.nombreVia + ' ' + cast(d.numero  as varchar) as direccionin,
		d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
 

--[leftjoinperfil]
--[leftjoinperso]

 where (1 = 1)
  AND (tipooportunidad=0 OR tipooportunidad is null) ","SELECT notas, notas1, notas2, notas3, notas4, notas5, notas6 FROM oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,EtiqMascotasProp,14,bVerMascotas,1,,,3,,
816,120,Historial Clientes,"select distinct 2 as origen,
		act.icodcli, act.dfechaact, act.linea, act.id, act.subusu,
		act.sactuacion,act.sdescripcion2,act.tiempo,
		act.tsautomatico,act.tipoactu,trabajador.icodcli as icodclitrabajador,
		null as inumexp, null as iyear,
		act.imputado

		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (0)
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.clientes trabajador on trabajador.codsubusu = act.subusu and act.subusu > 0 and trabajador.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.clientes clisug on act.codclisugerido=clisug.icodcli
		left join [[instancia]advabousu[empresa]].dbo.expedien expsug on act.codexpsugerido=expsug.inumexp and act.yearexpsugerido=expsug.iyear  

		where tsautomatico=1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Clientes,,,0,,,,,
817,121,Clientes,"select oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, oporcli.oportunidad,
oporcli.etapa,oporcli.icodpro,oporcli.estado,oporcli.tipo,oporcli.fechaseguimiento, oporcli.horaseguimiento,oporcli.backcolor,
oporcli.codigo as cod,oporcli.fechacierre,oporcli.fechainiprev,oporcli.fechafinprev,oporcli.tipooportunidad,oporcli.idcentro,
oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor,   
c.snombrecli as nombreFicha,C.idcentros,
SU3.nombre as creadopor,     
subusu.nombre as nombreusuario, cext.numero  
 	
	--[camposperfil]  
	--[camposperso]  
	  
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (0) 
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
		  
	--[leftjoinperfil]  
	--[leftjoinperso]   
	 
	where tipooportunidad=5 ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,EtiqClientesProp,0,,1,," from [[instancia]advabousu[empresa]].dbo.oporcli left join subusu on subusu.icodsubusu = oporcli.icodusu
inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli and tipobd in ([tabla])
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id",,,
818,121,Pacientes,"select oporcli.icodcli,oporcli.dfecha,oporcli.linea,oporcli.icodopor,(isnull(oporcli.icodusu,0)) as icodusu, oporcli.oportunidad,
oporcli.etapa,oporcli.icodpro,oporcli.estado,oporcli.tipo,oporcli.fechaseguimiento, oporcli.horaseguimiento,oporcli.backcolor,
oporcli.codigo as cod,oporcli.fechacierre,oporcli.fechainiprev,oporcli.fechafinprev,oporcli.tipooportunidad,oporcli.idcentro,
oporcli.inumexp as inumexpOpor, oporcli.iyear as iyearOpor,   
c.snombrecli as nombreFicha,C.idcentros,
SU3.nombre as creadopor,     
subusu.nombre as nombreusuario, cext.numero  
 	
	--[camposperfil]  
	--[camposperso]   
	 
	, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu  
	inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli and c.tipobd in (4) 
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd  
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id  
	left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli  
	left join [[instancia]advabousu[empresa]].dbo.subusu SU3 on SU3.icodsubusu = oporcli.creadopor  
	left join [[instancia]advabousu[empresa]].dbo.oporResumen r on r.icodopor = oporcli.icodopor
		  
	--[leftjoinperfil]  
	--[leftjoinperso]    

	where tipooportunidad=5 ","select notas, notas1, notas2, notas3, notas4, notas5, notas6 from oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Pacientes,4,bverpaciente,0,," from [[instancia]advabousu[empresa]].dbo.oporcli left join subusu on subusu.icodsubusu = oporcli.icodusu
inner join [[instancia]advabousu[empresa]].dbo.clientes on clientes.icodcli = oporcli.icodcli and tipobd in ([tabla])
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = clientes.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on clientes.idcentros = centrospredef.id",,,
819,120,Historial Expedientes,"select distinct 1 as origen,
			null as icodcli, act.dfechaact, act.linea, act.id, act.subusu,
			act.sactuacion,act.sdescripcion2,act.tiempo,
			act.tsautomatico,act.tipoactu,trabajador.icodcli as icodclitrabajador,
			act.inumexp, act.iyear,
			act.imputado

			from [[instancia]advabousu[empresa]].dbo.segexp act
			left join [[instancia]advabousu[empresa]].dbo.expedien e on act.inumexp=e.inumexp and act.iyear=e.iyear   
			left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
			left join [[instancia]advabousu[empresa]].dbo.clientes trabajador on trabajador.codsubusu = act.subusu and act.subusu > 0 and trabajador.tipobd = 1
			
			where tsautomatico=1","select notas, notas2, notas3, notas4, notas5, notas6 from segexp",inumexp:INT|iyear:INT|dfechaact:DATETIME|linea:INT,Expedientes,,,0,,,,,
820,122,Escalas,"SELECT ER.id, E.id as idEscala, E.codsubusu, C.icodcli, C.idcentros
  --[camposperfil]
  --[camposperso]
  FROM [[instancia]advAboUsu[empresa]].dbo.escalasRespuestas ER 
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.escalas E ON ER.idEscala = E.id
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.escalasPredef EP ON E.idEscalaPredef = EP.id
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.escalasPredefRespuestas EPR ON ER.idEscalasPredefRespuesta = EPR.id
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.escalasPredefPreguntas EPP ON EPR.idPregunta = EPP.id
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.clientes C ON E.icodcli = C.icodcli
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.subusu S ON E.codsubusu = S.icodsubusu
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.centrospredef CE ON CE.id = C.idcentros
  --[leftjoinperfil]
  --[leftjoinperso]
  ",,id:INT|icodcli:INT,Escalas,,,0,,,,,
821,123,Escalas,"SELECT E.id as idEscala, E.codsubusu, C.icodcli, C.idcentros
  --[camposperfil]
  --[camposperso]
  FROM [[instancia]advAboUsu[empresa]].dbo.escalas E
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.escalasPredef EP ON E.idEscalaPredef = EP.id
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.clientes C ON E.icodcli = C.icodcli
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.subusu S ON E.codsubusu = S.icodsubusu
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.centrospredef CE ON CE.id = C.idcentros
  LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.oporcli O ON E.icodopor = O.icodopor
  --[leftjoinperfil]
  --[leftjoinperso]
  ",,idEscala:INT|icodcli:INT,Escalas,,,0,,,,,
822,120,Historial Trabajadores,"select distinct 2 as origen,
		act.icodcli, act.dfechaact, act.linea, act.id, act.subusu,
		act.sactuacion,act.sdescripcion2,act.tiempo,
		act.tsautomatico,act.tipoactu,trabajador.icodcli as icodclitrabajador,
		null as inumexp, null as iyear,
		act.imputado

		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (1)
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.clientes trabajador on trabajador.codsubusu = act.subusu and act.subusu > 0 and trabajador.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.clientes clisug on act.codclisugerido=clisug.icodcli
		left join [[instancia]advabousu[empresa]].dbo.expedien expsug on act.codexpsugerido=expsug.inumexp and act.yearexpsugerido=expsug.iyear  

		where tsautomatico=1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Trabajadores,,,0,,,,,
823,120,Historial Clientes Potenciales,"select distinct 2 as origen,
		act.icodcli, act.dfechaact, act.linea, act.id, act.subusu,
		act.sactuacion,act.sdescripcion2,act.tiempo,
		act.tsautomatico,act.tipoactu,trabajador.icodcli as icodclitrabajador,
		null as inumexp, null as iyear,
		act.imputado

		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (2)
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.clientes trabajador on trabajador.codsubusu = act.subusu and act.subusu > 0 and trabajador.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.clientes clisug on act.codclisugerido=clisug.icodcli
		left join [[instancia]advabousu[empresa]].dbo.expedien expsug on act.codexpsugerido=expsug.inumexp and act.yearexpsugerido=expsug.iyear  

		where tsautomatico=1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Clientes Potenciales,,,0,,,,,
824,120,Historial Terceros,"select distinct 2 as origen,
		act.icodcli, act.dfechaact, act.linea, act.id, act.subusu,
		act.sactuacion,act.sdescripcion2,act.tiempo,
		act.tsautomatico,act.tipoactu,trabajador.icodcli as icodclitrabajador,
		null as inumexp, null as iyear,
		act.imputado

		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (3)
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.clientes trabajador on trabajador.codsubusu = act.subusu and act.subusu > 0 and trabajador.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.clientes clisug on act.codclisugerido=clisug.icodcli
		left join [[instancia]advabousu[empresa]].dbo.expedien expsug on act.codexpsugerido=expsug.inumexp and act.yearexpsugerido=expsug.iyear  

		where tsautomatico=1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Terceros,,,0,,,,,
825,120,Historial Proveedores,"select distinct 2 as origen,
		act.icodcli, act.dfechaact, act.linea, act.id, act.subusu,
		act.sactuacion,act.sdescripcion2,act.tiempo,
		act.tsautomatico,act.tipoactu,trabajador.icodcli as icodclitrabajador,
		null as inumexp, null as iyear,
		act.imputado

		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (9)
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.clientes trabajador on trabajador.codsubusu = act.subusu and act.subusu > 0 and trabajador.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.clientes clisug on act.codclisugerido=clisug.icodcli
		left join [[instancia]advabousu[empresa]].dbo.expedien expsug on act.codexpsugerido=expsug.inumexp and act.yearexpsugerido=expsug.iyear  

		where tsautomatico=1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Proveedores,,,0,,,,,
826,120,Historial Sin Asignar,"select distinct 2 as origen,
		act.icodcli, act.dfechaact, act.linea, act.id, act.subusu,
		act.sactuacion,act.sdescripcion2,act.tiempo,
		act.tsautomatico,act.tipoactu,trabajador.icodcli as icodclitrabajador,
		null as inumexp, null as iyear,
		act.imputado

		from [[instancia]advabousu[empresa]].dbo.segcli act
		inner join [[instancia]advabousu[empresa]].dbo.clientes c on act.icodcli=c.icodcli and c.tipobd in (9998)
		left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
		left join [[instancia]advabousu[empresa]].dbo.clientes trabajador on trabajador.codsubusu = act.subusu and act.subusu > 0 and trabajador.tipobd = 1
		left join [[instancia]advabousu[empresa]].dbo.clientes clisug on act.codclisugerido=clisug.icodcli
		left join [[instancia]advabousu[empresa]].dbo.expedien expsug on act.codexpsugerido=expsug.inumexp and act.yearexpsugerido=expsug.iyear  

		where tsautomatico=1","select notas, notas2, notas3, notas4, notas5, notas6 from segcli",icodcli:INT|dfechaact:DATETIME|linea:INT,Sin Asignar,,,0,,,,,
827,126,Inmuebles,"SELECT C.referencia, C.icodcli, C.snombrecli, C.scodpostalcli, C.estadoCli , C.codsubusu as codsubusu, CEX.precio as precio, C.tipobd as tipobd
	   --[camposperso]
	 FROM clientes as C 
	  INNER JOIN clientesext CEX ON C.icodcli = CEX.icodcli
	  AND C.tipobd = 15
	 LEFT JOIN clientesresumen CR ON C.icodcli = CR.icodcli 
	--[leftjoinperso]",,,,,,,,,,,
829,127,Trabajos,"SELECT T.id, T.icodcli, T.inumexp, T.iyear, T.codsubusu, convert(varchar(50), T.inumexp) + '&' + convert(varchar(50), T.iyear) as idexp, CONVERT(DATE, T.fecha) as fecha 
--[camposperfil]
--[camposperso]
FROM [[instancia]advAboUsu[empresa]].dbo.tareaAcciones T
LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.clientes C ON C.icodcli = T.icodcli
LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.expedien E ON E.inumexp = T.inumexp AND E.iyear = T.iyear
LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.subusu S ON S.icodsubusu = T.codsubusu
LEFT JOIN [[instancia]advAboUsu[empresa]].dbo.trabajosResumen TR ON TR.id = T.id
--[leftjoinperfil]
--[leftjoinperso]
",,id:INT|icodcli:INT,Trabajos,,,0,,,,,
834,4,Inmobiliarias,"select oporcli.icodcli, oporcli.dfecha, oporcli.linea, oporcli.icodopor, oporcli.ordenprioridad, oporcli.porprogreso,
oporcli.icodusu as icodusu, oporcli.icodpro, oporcli.estado,oporcli.etapa, oporcli.tipo, oporcli.codigo, oporcli.fechainiprev, oporcli.fechafinprev,
oporcli.prevision,oporcli.fechacierre,oporcli.importecierre,oporcli.oportunidad, oporcli.fechaseguimiento, oporcli.tiempoprev, oporresumen.sumtiempotr, oporresumen.saldorecobros,
oporcli.campofecha1,C.idcentros, C.inivelprivacidad, oporcli.horaseguimiento, oporcli.tipooportunidad, oporcli.backcolor, oporcli.fechapresupuesto,
Convert(varchar,year(oporcli.dfecha)) as Año,isnull(oporcli.serie, '') as Serie, oporcli.numopor as Numero, C.fechanacimiento,
cast( isnull(convert( int, case when oporcli.campofecha1 is null then -5000  else case when fechacierre is null then convert( int, datediff(day, getdate(),
oporcli.campofecha1)) else convert( int, datediff(day, oporcli.campofecha1, fechacierre)) end end), -5000) as int) as edad, oporcli.idcentro, oporcli.codusuapoyo,
convert(varchar(50), oporcli.inumexp) + '&' +  convert(varchar(50), oporcli.iyear) as idexp

--[camposperfil]
--[camposperso]

, MARCAFROM from [[instancia]advabousu[empresa]].dbo.oporcli
left join [[instancia]advabousu[empresa]].dbo.expedien on oporcli.inumexp = expedien.inumexp and oporcli.iyear = expedien.iyear
left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = oporcli.icodusu
left join [[instancia]advabousu[empresa]].dbo.subusu subusuapoyo on subusuapoyo.icodsubusu = oporcli.codusuapoyo
inner join [[instancia]advabousu[empresa]].dbo.clientes C on C.icodcli = oporcli.icodcli   and c.tipobd in (15)
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON oporcli.icodcli = CR.icodcli
left join [[instancia]advabousu[empresa]].dbo.oporResumen OpRes ON oporcli.icodopor = OpRes.icodopor
left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = C.tipobd
left join [[instancia]advabousu[empresa]].dbo.centrospredef on C.idcentros = centrospredef.id 
left join [[instancia]advabousu[empresa]].dbo.centrospredef centrooportunidad on oporcli.idcentro = centrooportunidad.id
left join [[instancia]advabousu[empresa]].dbo.plazosc PLC on PLC.id = C.idplazos
left join [[instancia]advabousu[empresa]].dbo.diascobro DC on DC.id = C.iddiascobro
left join [[instancia]advabousu[empresa]].dbo.oporresumen on oporresumen.icodopor = oporcli.icodopor
left join [[instancia]advabousu[empresa]].dbo.comision on comision.id = oporcli.idcomision
left join [[instancia]advabousu[empresa]].dbo.comisionTipoOpor on comisionTipoOpor.id = oporcli.idTipoComision
left join [[instancia]advabousu[empresa]].dbo.clientesext CEXT ON C.icodcli = CEXT.icodcli
LEFT JOIN (SELECT c.numcta, CAST(t.iva AS VARCHAR) + '(' + ISNULL(CASE igic WHEN 0 THEN ci.descripcioncorta ELSE 'IGIC' END, '') + ')' AS descripcionIVA
		FROM [[instancia]advabousu[empresa]].dbo.tipoiva t
		INNER JOIN [[instancia]advabousu[empresa]].dbo.[[ejercicio]cuentas] c ON c.idiva = t.idiva
		LEFT JOIN [[instancia]advabousu[empresa]].dbo.claseiva ci ON c.claseiva = ci.idclaseiva
		WHERE c.numcta LIKE '477%') tiva
	ON tiva.numcta = oporcli.ctaiva
LEFT JOIN (SELECT c.icodcli AS icodcliIn, c.referencia as referenciain, c.snombrecli as snombrecliin, subusuprop.nombre AS usuarioIn, c.codsubusu AS codsubusuIn,i.tipo AS tipoInmuebleIn, i.categoria AS categoriaIn, i.obraNueva AS obraNuevaIn, 
		i.refCatastral AS refCatastralIn, c.estadoCli AS estadoCliIn, d.tipoVia AS tipoViaIn, d.nombreVia AS nombreViaIn, d.numero AS numeroIn, d.bloque AS bloqueIn, d.escalera AS escaleraIN, 
		d.piso AS pisoIn, d.letra AS letraIn, d.pais AS paisIn, d.provincia AS provinciaIn, d.poblacion AS poblacionIn, d.codigoPostal AS codigoPostalIn, CEX.precio AS precioIn, CEX.operacion AS operacionIn,
		con.snombrecli as contactoin, con.stelefonocli as telefonocontactoin, con.smovilcli as movilcontactoin, zona AS zonain 
		from clientes c
		left join inmueblesext i on c.icodcli = i.codcli
		left join direccion d on c.icodcli = d.icod and principal = 1 and d.tipo = 0
		left join clientesext cex on c.icodcli = cex.icodcli 
		OUTER APPLY (select top(1) cl.icodcli, con.snombrecli , con.stelefonocli , con.smovilcli from clientes con
		inner join cliterceros cl on con.icodcli = cl.icodclitercero WHERE cl.icodcli=c.icodcli ) AS con
		left join subusu subusuprop on subusuprop.icodsubusu = c.codsubusu 
		where c.tipobd = 15) inm ON inm.icodcliIn = oporcli.icodcliInmueble
--[leftjoinperfil]
--[leftjoinperso]

 where (1 = 1)
  AND (tipooportunidad=0 OR tipooportunidad is null) ","SELECT notas, notas1, notas2, notas3, notas4, notas5, notas6 FROM oporcli",icodcli:INT|icodopor:INT|linea:INT|dfecha:DATETIME,Inmobiliarias,15,bVerInmuebles,0,,,3,,
836,63,Potenciales,"SELECT 
C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.inivelprivacidad, C.snifcli, C.smovilcli, C.stelefonocli,
C.telefono2, C.telefono3, CEXT.backcolor, C.idcentros

--[camposperfil]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesresumen CR ON C.icodcli = CR.icodcli

--[leftjoinperfil]

WHERE tipobd in (2)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Potenciales,,,0,,,,,1
837,131,Cuentas de Empresa,"SELECT 
id, fechaEnvio, FORMAT(fechaenvio,'dd/' + UPPER('m') + UPPER('m') +'/yyyy ' + UPPER('h') + UPPER('h') +':mm:ss') AS fechaEnvioTexto, asunto, nombrePlantilla, envioPor, realizado, estadoMnSign, Operador, OperadorEnvio, remitente, idController, nEmpresa, fechaEnvioRealizado, 
FORMAT(fechaEnvioRealizado,'dd/' + UPPER('m') + UPPER('m') +'/yyyy ' + UPPER('h') + UPPER('h') +':mm:ss') AS fechaEnvioRealizadoTexto,



icodcli, snombrecli, isnull(gestionRealizada, 0) as gestionRealizada, 
case when fechaenviorealizado is null then upper('P') + 'rogramado' else upper('E') + 'nviado' end as estado, 


Envio, 
tiposignwhatsapp, MARCAFROM
FROM 
(
SELECT id, 
fechaProgramada AS fechaEnvio, asunto, nombrePlantilla, '2' AS envioPor, 
case when fechaEnvio is null then 0 else 1 end  AS realizado, 

case when tipoElementoFirmado >= 0 
OR m.texto like '%urlenlacesweb%' or m.texto like '%comunicacionesmn.com%' or m.texto like '%docsign.mnprogram.net%' or m.texto like '%urlcuestionario%'
then upper('P') + 'endiente' else '' end as estadoMnSign,

o.Operador, ISNULL(oe.Operador, '') AS  OperadorEnvio, 'WhatsApp Empresa' as remitente, m.idController, [empresa] AS nEmpresa,
fechaEnvio as fechaEnvioRealizado, m.icodcli, cli.snombrecli, gestionRealizada,

 case when m.tipoElementoFirmado = 0 then UPPER('S') + 'ign de Adjunto'
 when m.tipoElementoFirmado = 3  then UPPER('C') + 'onfirm Sign' 
 when m.texto like '%urlenlacesweb%'   then upper('f') + 'ormulario'  
 when m.texto like '%urlcuestionario%'  then upper('c') + 'uestionario' 
 when m.texto like '%docsign.mnprogram.net%' or m.texto like '%comunicacionesmn.com%' then upper('f') + 'ormulario o '+upper('c') + 'uestionario '+upper('w') + 'eb'
 else '' end as tiposignwhatsapp,

CASE WHEN (SELECT count(1) FROM [[instancia]advabocom].dbo.mensajeWhatsapp m2 WHERE m2.idSerie = m.idSerie) > 1 THEN upper('M') + 'últiple'
ELSE upper('I') + 'ndividual' END AS Envio  
FROM [[instancia]advabocom].dbo.mensajeWhatsapp m
INNER JOIN [[instancia]advabocom].dbo.Operador o ON m.codOpe = o.CodOpe
LEFT JOIN [[instancia]advabocom].dbo.Operador oe ON m.codOpeEnvio = oe.CodOpe
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes cli on m.icodcli = cli.icodcli
WHERE m.numEmpresa = [empresa] AND fechaEnvio IS NULL

UNION ALL

SELECT id, 
DATETIMEFROMPARTS(DATEPART(YEAR, dfechaact),DATEPART(MONTH, dfechaact),DATEPART(DAY, dfechaact),
DATEPART(HOUR, horainiact),DATEPART(MINUTE, horainiact),DATEPART(SECOND, horainiact),0 )as fechaEnvio,
sactuacion as asunto, UPPER('w') + 'hatsapp' as nombrePlantilla, '3' AS envioPor, 
1  AS realizado, 


case when (act.tipofirmamn = 5 or act.tipofirmamn = 7) then

    case when act.estadofirma = 2 then upper('f') + 'irmado' 
        when act.estadofirma = 1 and not propiedadesadjun.fechacaducidad is null and propiedadesadjun.fechacaducidad < getdate() then upper('c') + 'aducado'
        when act.estadofirma = 1 then upper('p') + 'endiente' 
        else ''
   end

 when (act.notas like '%docsign.mnprogram.net%' or act.notas like '%comunicacionesmn.com%' or act.notas like '%urlenlacesweb%' or act.notas like '%urlcuestionario%') then
     case when propadj2.estadofirma is not null and propadj2.estadofirma like '%cubierto' then upper('f') +'irmado/' + upper('c')+'ompletado'
          when  propadj2.estadofirma is not null and propadj2.estadofirma like '%pendiente' and not propadj2.fechacaducidad is null and propadj2.fechacaducidad < getdate() then upper('c') + 'aducado'
          when  propadj2.estadofirma is not null and propadj2.estadofirma like '%pendiente' then upper('p') + 'endiente' 
          else upper('p') + 'endiente' 
     end

else '' 

end as estadomnsign,

isnull(s.nombre, UPPER('S') + 'upervisor') AS Operador, isnull(s.nombre,UPPER('S') +'upervisor') AS OperadorEnvio, 'WhatsApp Empresa' as remitente, act.idController, [empresa] AS nEmpresa,
DATETIMEFROMPARTS(DATEPART(YEAR, dfechaact),DATEPART(MONTH, dfechaact),DATEPART(DAY, dfechaact),
DATEPART(HOUR, horainiact),DATEPART(MINUTE, horainiact),DATEPART(SECOND, horainiact),0 )as fechaEnvioRealizado, act.icodcli, cli.snombrecli, gestionRealizada,

case when act.tipoFirmaMN = 5 then UPPER('S') + 'ign de Adjunto'
 when act.tipoFirmaMN = 7 then UPPER('C') + 'onfirm Sign' 
 when act.notas like '%urlenlacesweb%'   then upper('f') + 'ormulario'  
 when act.notas like '%urlcuestionario%'  then upper('c') + 'uestionario' 
 when act.notas like '%docsign.mnprogram.net%' or act.notas like '%comunicacionesmn.com%' then upper('f') + 'ormulario o '+upper('c') + 'uestionario '+upper('w') + 'eb'
 else '' end as tiposignwhatsapp,

ISNULL(act.sdescripcion2, upper('I') + 'ndividual') AS Envio    
FROM [[instancia]advabousu[empresa]].dbo.segexp act
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes cli on act.icodcli = cli.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun on act.guid = propiedadesAdjun.guid
left join [[instancia]advabousu[empresa]].dbo.propiedadesadjun propadj2 on act.idAdjunFormularioCuestionario = propadj2.idadjun

WHERE (act.sactuacion LIKE 'WhatsApp Enviado:%') OR (act.sactuacion LIKE 'MN Sign Enviado:%' AND act.tipoFirmaMN = 5)

UNION ALL

SELECT id, 
DATETIMEFROMPARTS(DATEPART(YEAR, dfechaact),DATEPART(MONTH, dfechaact),DATEPART(DAY, dfechaact),
DATEPART(HOUR, horainiact),DATEPART(MINUTE, horainiact),DATEPART(SECOND, horainiact),0 )as fechaEnvio,
 sactuacion as asunto, UPPER('w') + 'hatsapp' as nombrePlantilla, '4' AS envioPor, 
1  AS realizado, 



case when (act.tipofirmamn = 5 or act.tipofirmamn = 7) then

    case when act.estadofirma = 2 then upper('f') + 'irmado' 
        when act.estadofirma = 1 and not propiedadesadjun.fechacaducidad is null and propiedadesadjun.fechacaducidad < getdate() then upper('c') + 'aducado'
        when act.estadofirma = 1 then upper('p') + 'endiente' 
        else ''
   end

 when (act.notas like '%docsign.mnprogram.net%' or act.notas like '%comunicacionesmn.com%' or act.notas like '%urlenlacesweb%' or act.notas like '%urlcuestionario%') then
     case when propadj2.estadofirma is not null and propadj2.estadofirma like '%cubierto' then upper('f') +'irmado/' + upper('c')+'ompletado'
          when  propadj2.estadofirma is not null and propadj2.estadofirma like '%pendiente' and not propadj2.fechacaducidad is null and propadj2.fechacaducidad < getdate() then upper('c') + 'aducado'
          when  propadj2.estadofirma is not null and propadj2.estadofirma like '%pendiente' then upper('p') + 'endiente' 
          else upper('p') + 'endiente' 
     end

else '' 
end as estadomnsign,

isnull(s.nombre,UPPER('S') +'upervisor') AS Operador, isnull(s.nombre,UPPER('S') +'upervisor') AS OperadorEnvio, 'WhatsApp Empresa' as remitente, act.idController, [empresa] AS nempresa,
DATETIMEFROMPARTS(DATEPART(YEAR, dfechaact),DATEPART(MONTH, dfechaact),DATEPART(DAY, dfechaact),
DATEPART(HOUR, horainiact),DATEPART(MINUTE, horainiact),DATEPART(SECOND, horainiact),0 )as fechaEnvioRealizado, act.icodcli, cli.snombrecli, gestionRealizada,


case when act.tipoFirmaMN = 5 then UPPER('S') + 'ign de Adjunto'
 when act.tipoFirmaMN = 7 then UPPER('C') + 'onfirm Sign' 
 when act.notas like '%urlenlacesweb%'   then upper('f') + 'ormulario'  
 when act.notas like '%urlcuestionario%'  then upper('c') + 'uestionario' 
 when act.notas like '%docsign.mnprogram.net%' or act.notas like '%comunicacionesmn.com%' then upper('f') + 'ormulario o '+upper('c') + 'uestionario '+upper('w') + 'eb'
 else '' end as tiposignwhatsapp,

ISNULL(act.sdescripcion2, upper('I') + 'ndividual') AS Envio        
FROM [[instancia]advabousu[empresa]].dbo.segcli act
left join [[instancia]advabousu[empresa]].dbo.subusu s on act.subusu=s.icodsubusu
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientes cli on act.icodcli = cli.icodcli
LEFT JOIN [[instancia]advabousu[empresa]].dbo.propiedadesAdjun on act.guid = propiedadesAdjun.guid
left join [[instancia]advabousu[empresa]].dbo.propiedadesadjun propadj2 on act.idAdjunFormularioCuestionario = propadj2.idadjun
WHERE (act.sactuacion LIKE 'WhatsApp Enviado:%') OR (act.sactuacion LIKE 'MN Sign Enviado:%' AND act.tipoFirmaMN = 5)


) tabla WHERE 1 =1
",,id:INT,Cuentas de Empresa,,,0,,,,,
838,62,Clientes,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.tipofichero,
C.inivelprivacidad, C.snifcli, C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3, C.idcentros,
CEXT.backcolor, CEXT.estadoLOPD

--[camposperfil]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

--[leftjoinperfil]

WHERE tipobd in (0)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,EtiqClientesProp,0,,1,,,,,1
839,77,Trabajadores,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.inivelprivacidad, C.snifcli, C.tipofichero,
C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3, C.idcentros,
CEXT.backcolor

--[camposperfil]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

--[leftjoinperfil]

WHERE tipobd in (1)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Trabajadores,1,bvertrabajador,0,,,,,1
840,78,Terceros,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.spoblacioncli, C.sprovinciacli, C.sNombrePais, C.tipofichero,
C.snombrecli, C.email, C.stelefonocli, C.telefono2, C.telefono3, C.smovilcli, C.snifcli,
C.estadocli, C.fechaalta,
CEXT.backcolor

--[camposperfil]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

--[leftjoinperfil]

WHERE tipobd in (3)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,bVerTerceros,3,bVerTerceros,1,,,,,1
841,71,Pacientes,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.inivelprivacidad, C.snifcli, C.tipofichero,
C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3, C.idcentros,
CEXT.backcolor, CEXT.estadoLOPD

--[camposperfil]

, MARCAFROM
FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

--[leftjoinperfil]

WHERE tipobd in (4)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Pacientes,4,bverpaciente,0,,,,,1
842,72,Alumnos,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.inivelprivacidad, C.idcentros, C.tipofichero,
C.snifcli, C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3,
CEXT.backcolor

--[camposperfil]

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

--[leftjoinperfil]

WHERE tipobd in (5)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Alumnos,5,bveralumno,0,,,,,1
843,80,Compañías,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.inivelprivacidad, C.idcentros, C.tipofichero,
C.snifcli, C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3, CEXT.backcolor

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

WHERE tipobd in (6)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Compañías,6,bvercompania,0,,,,,1
844,83,Tutores,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.inivelprivacidad, C.idcentros, C.tipofichero,
C.snifcli, C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3,
CEXT.backcolor

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

WHERE tipobd in (7)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Tutores,7,bvermascota,0,,,,,1
845,79,Mutuas,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.fechaalta, C.snombrecli, C.snifcli, C.tipofichero,
C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3,
CEXT.backcolor, CEXT.numero

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

WHERE tipobd in (8)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Aseguradoras,8,bvermutua,0,,,,,1
846,68,Proveedores,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.inivelprivacidad, C.snombrecli, C.snifcli, C.fechaalta, C.estadocli, C.idcentros,
C.email, C.stelefonocli, C.telefono2, C.telefono3, C.smovilcli,
C.tipofichero, C.spoblacioncli, C.sprovinciacli, C.sNombrePais,
CEXT.backcolor

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

WHERE tipobd in (9)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,EtiqClientesProp,0,,1,,,,,1
847,81,Voluntarios,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.fechaalta, C.inivelprivacidad, C.snifcli, C.idcentros, C.tipofichero,
C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3,
CEXT.backcolor

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

WHERE tipobd in (10)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Voluntarios,10,bvervoluntarios,0,,,,,1
848,82,Financiadores,"SELECT C.icodcli, C.tipobd, C.codsubusu, C.snombrecli, C.snifcli, C.fechaalta, C.inivelprivacidad, C.idcentros, C.tipofichero,
C.smovilcli, C.stelefonocli, C.telefono2, C.telefono3,
CEXT.backcolor

FROM [[instancia]advabousu[empresa]].dbo.clientes C
LEFT JOIN [[instancia]advabousu[empresa]].dbo.clientesext CEXT on C.icodcli = CEXT.icodcli

WHERE tipobd in (11)","select notas, notas2, notas3, notas4, notas5, notas6 from clientes",icodcli:INT,Financiadores,11,bVerFinancieras,0,,,,,1
850,13,Proveedores,"select p.fechaingreso as fechagasing,p.fecha,p.nombrecli as cliente, c.icodcli,
	isnull(p.formapago,'otros') as formapago1, e.srefabogado, 
	p.formapago,
	p.total,p.concepto, p.cobrado ,p.cobrado as realizada ,isnull(p.cobrar,0) as cobrar ,p.fechacobro as fecharealizada,p.serie,
	p.inumfactura as inumfact,p.yearfact,p.asientocobro,p.ctacliente as ctaacrcli,
	p.ctacajban,p.ctaingreso as ctagasing,1 as tipo,p.baseimp,p.iva,p.irpf,p.codsubusu,p.factura,
	p.notas,p.yearcontacobro,p.subusufact,p.id,p.impagado,p.fechaimpagado,p.lineacobro,
	p.ctacobrado,p.lineaimpagado,p.ctaimpagado,p.asientoimpagado,p.yearcontaimpagado,p.tipoprof,
	p.origen,p.iyear,p.inumexp,p.bproformarel,p.inumproformarel,p.yearproformarel,
	p.codsubusuproformarel,p.tipoproformarel,p.facturar,p.ctaiva,p.ctairpf,
	(case p.diariocobro when 's' then 1 else 0 end) as diariocobro,
	(case p.diarioimpagado when 's' then 1 else 0 end) as diarioimpagado,
	case p.factura 
	when 1 then 'oficial' 
	when 2 then (case p.tipoprof when 2 then 'presupuesto' when 3 then 'albarán' else 'proforma' end) 
	else 'sin facturar' end as tipofactura,
	l.fecha as fecharemesa,
	p.tipoimpago,
	case p.tipoimpago when 'perdido definitivo' then 'definitivo' else p.tipoimpago end as tipoimpago1, 
	p.importeimpagado,
	(case isnull(l.fecha,'') when '' then 0 else 1 end) as estaremesado,
	r.banco as banco,
	(case p.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
	f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
	c.fechaalta as fechaaltacliente,
	subusu.nombre as nomsubusu,
	caja.caja,
	c.stelefonocli as telefono1, c.telefono2, c.telefono3, 
	c.smovilcli as movil,c.email, 
	p.idcentros, centrospredef.sdescripcion as nombrecentro 
	, c.starjetasocio , c.perso88, f.fracobrada, f.codsubusu as fcodsubusu, vistac.expedientedes as nombreexp, vistac.expedientealum as nombrealum, tipoficherocli.tipofichero as tipocliente, c.estadocli, c.origen as origencli,
	p.cobroodontograma, null as identrada,
	null as expcampo28, null as expcampo29, null as expcampo34,p.inumcobro,vistac.expedientenum as numeroexprelac, e.anyo as iyearrelac,
	e.codclitrabajador, clitrab.snombrecli as nombretrab,
	p.alcobro, p.impdef, c.tipofichero as tipoficheroclientes, p.inumexprelacionado, p.iyearrelacionado,
	e.itipoexp, c.snombreclicomercial as 'nomcomercial', p.icodclirelacionado, 
	isnull((CONVERT(varchar(255),f.inumfactura) + '|' + CONVERT(varchar(255),f.yearfact) + '|' + CONVERT(varchar(255),f.codsubusu)  + '|' + f.serie),'|||') as idLineaFacPrevCobro, 
	case when p.subusucre = 0 then upper('/**ususupervisor**/') else creador.nombre end as nombreCreador, p.subusucre as icodCreador

	--[camposperfil]
	--[camposperso]

	from [[instancia]advabousu[empresa]].dbo.prevcobros p
	left join [[instancia]advabousu[empresa]].dbo.cajasArqueo caja on p.idcaja=caja.id
	left join [[instancia]advabousu[empresa]].dbo.linereme l on l.idprevcobros=p.id
	left join [[instancia]advabousu[empresa]].dbo.remesas r on l.idremesa=r.idremesa
	left join [[instancia]advabousu[empresa]].dbo.recibos rec on rec.idprevcobros=p.id
	left join [[instancia]advabousu[empresa]].dbo.facturas f on f.yearfact=p.yearfact and f.inumfactura=p.inumfactura and 
	f.codsubusu=p.subusufact and f.serie=p.serie
	left join [[instancia]advabousu[empresa]].dbo.proforma prof on prof.yearfact=p.yearfact and prof.inumfactura=p.inumfactura and
	prof.codsubusu=p.subusufact and prof.tipoprof=p.tipoprof 
	inner join [[instancia]advabousu[empresa]].dbo.clientes as c on p.inumexp=c.icodcli and (p.inumexprelacionado is null and (p.iyearrelacionado is null or p.iyearrelacionado < 0)) and p.origen='cli' and c.tipobd in (9)
	left join [[instancia]advabousu[empresa]].dbo.subusu on subusu.icodsubusu = p.codsubusu
	left join [[instancia]advabousu[empresa]].dbo.centrospredef on p.idcentros = centrospredef.id
	left join [[instancia]advabousu[empresa]].dbo.tipoficherocli on tipoficherocli.tipobd = c.tipobd
	left join [[instancia]advabousu[empresa]].dbo.expedien e on e.inumexp = p.inumexprelacionado and e.iyear = p.iyearrelacionado
	left join [[instancia]advabousu[empresa]].dbo.clientes clitrab on clitrab.icodcli = e.codclitrabajador and clitrab.tipobd = 1
	left join [[instancia]advabousu[empresa]].dbo.vListadoCobrosCurso vistac on vistac.id=p.id 
	left join [[instancia]advabousu[empresa]].dbo.tipoexp on e.itipoexp = tipoexp.codigo
	left join [[instancia]advabousu[empresa]].dbo.clientesext cext on c.icodcli = cext.icodcli
	left join [[instancia]advabousu[empresa]].dbo.subusu creador on creador.icodsubusu = p.subusucre

	--[leftjoinperfil]
	--[leftjoinperso]

	where (cobroodontograma is null or cobroodontograma = 0)",,id:INT,Proveedores,9,,0,,,,,
