id_linedcto,id_tabla,query,consulta,datasource
267,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
267,4,qrycli,"select clientes.codigo,clientes.snombrecli,clientes.stelefonocli,clientes.fechaalta,clientes.snifcli,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
267,21,qrycontact,"select contacto.nombre,contacto.telefono1 from clientes inner join contactlin on clientes.icodcli = contactlin.icodcli inner join contacto on contactlin.icodcontacto = contacto.codcontacto where clientes.icodcli=:icodcli",
267,37,qrysubusu,select subusu.nombre from subusu left join clientes on subusu.icodsubusu=clientes.codsubusu where clientes.icodcli=:icodcli,
268,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
268,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,clientes.codigo,clientes.fechaalta,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
268,21,qrycontact,"select contacto.nombre,contacto.telefono1,contacto.email1 from clientes inner join contactlin on clientes.icodcli = contactlin.icodcli inner join contacto on contactlin.icodcontacto = contacto.codcontacto where clientes.icodcli=:icodcli",
268,37,qrysubusu,select subusu.nombre from subusu left join clientes on subusu.icodsubusu=clientes.codsubusu where clientes.icodcli=:icodcli,
269,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
269,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,clientes.codigo,clientes.fechaalta,clientes.notas,clientes.notas2,clientes.notas3,clientes.notas4,clientes.notas5,clientes.notas6,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
269,21,qrycontact,"select contacto.nombre,contacto.telefono1,contacto.email1 from clientes inner join contactlin on clientes.icodcli = contactlin.icodcli inner join contacto on contactlin.icodcontacto = contacto.codcontacto where clientes.icodcli=:icodcli",
269,37,qrysubusu,select subusu.nombre from subusu left join clientes on subusu.icodsubusu=clientes.codsubusu where clientes.icodcli=:icodcli,
270,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
270,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
270,36,qrycliadjun,"select cliadjun.fecha,cliadjun.imagen,cliadjun.descripcion from cliadjun where cliadjun.icodcli=:icodcli",
271,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
271,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
271,35,qryseg,"select segcli.dfechaact,segcli.sactuacion,subusu.nombre as usuario,DATENAME(hh, horainiact) + ':' +DATENAME(mi, horainiact) + ':' + DATENAME(ss, horainiact) as horainiact,DATENAME(hh, horafinact) + ':' +DATENAME(mi, horafinact) + ':' + DATENAME(ss, horafinact) as horafinact,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo from segcli left join subusu on segcli.subusu=subusu.icodsubusu where icodcli=:icodcli",
272,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
272,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
272,35,qryseg,"select segcli.dfechaact,segcli.sactuacion,segcli.notas,subusu.nombre as usuario,DATENAME(hh, horainiact) + ':' +DATENAME(mi, horainiact) + ':' + DATENAME(ss, horainiact) as horainiact,DATENAME(hh, horafinact) + ':' +DATENAME(mi, horafinact) + ':' + DATENAME(ss, horafinact) as horafinact,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo from segcli left join subusu on segcli.subusu=subusu.icodsubusu where icodcli=:icodcli",
272,37,qrysubusu,select subusu.nombre from subusu left join clientes on subusu.icodsubusu=clientes.codsubusu where clientes.icodcli=:icodcli,
273,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
273,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,clientes.ftotalbaseimp,clientes.ftotaliva,clientes.ftotalirpf,clientes.ftotaleuro,clientes.ftotalcobro,clientes.fsaldofinal,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
273,57,qrycue,"select (sdescripcion  + ' ' + isnull(cast(notas as varchar(MAX)),' ')) as descripnotas,cuencli.dfecha,cuencli.sDescripcion,cuencli.fentradaseuro,cuencli.fsalidaseuro from cuencli where icodcli=:icodcli",
274,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
274,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,clientes.totaloportunidades,clientes.totalprevisionoportunidades,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
274,70,qryoporcli,"select oporcli.*,subusu.nombre as subusuario from oporcli left join subusu on oporcli.icodusu=subusu.icodsubusu where oporcli.icodcli=:icodcli",
275,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
275,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.inumfactura,facturas.fecha,facturas.totalivaeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
275,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.descripcion,linefact.salidaeuro, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
276,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
276,71,qryprevcobros,"SELECT prevcobros.fechaingreso as fechagasing,prevcobros.nombrecli as cliente,
prevcobros.cobrado as realizada,prevcobros.fechacobro as fecharealizada,
prevcobros.inumfactura as inumfact,prevcobros.ctacliente as ctaacrcli,
prevcobros.ctaingreso as ctagasing, 1 as tipo,
(case prevcobros.factura when 1 then 'Factura Oficial' when 2 then
(case prevcobros.tipoprof when 2 then 'Presupuesto' when 3 then 'Albarán'
else 'Factura Proforma' end)
else '' end) as tipofactura,
l.fecha as fecharemesa,
(case isnull(l.fecha, '') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case prevcobros.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
cli.fechaalta as fechaaltacliente, null,prevcobros.concepto,prevcobros.total,centrospredef.sdescripcion,prevcobros.total as totalletra ,s.nombre as usuario ,vistapac.pacientenombre  FROM prevcobros
left join linereme l on l.idprevcobros=prevcobros.id
left join remesas r on l.idremesa=r.idremesa
left join facturas f on f.yearfact=prevcobros.yearfact and f.inumfactura=prevcobros.inumfactura and
f.codsubusu=prevcobros.subusufact and f.serie=prevcobros.serie
left join proforma prof on prof.yearfact=prevcobros.yearfact and prof.inumfactura=prevcobros.inumfactura and
prof.codsubusu=prevcobros.subusufact and prof.tipoprof=prevcobros.tipoprof
left join clientes cli on prevcobros.inumexp=cli.icodcli and prevcobros.origen = 'cli'
left join centrospredef on centrospredef.id=cli.idcentros
left join subusu s on prevcobros.codsubusu=s.icodsubusu left join vListadoCobrosPacientes vistapac on vistapac.id=prevcobros.id  where prevcobros.id = @id ",sourcedatosfact
277,4,qryclientes,"SELECT clientes.snombrecli,clientes.snifcli FROM clientes WHERE icodcli = @icodcli",
277,37,qrysubusu,SELECT subusu.nombre FROM subusu WHERE icodsubusu = @icodsubusu,
277,72,qryrecetasmedicas,"SELECT recetasMedicas.id, recetasmedicas.duracion,recetasmedicas.unidades,recetasmedicas.denominacion,recetasmedicas.dosificacion,recetasmedicas.formato,recetasmedicas.via,recetasmedicas.fechaprescripcion,recetasmedicas.diagnostico,recetasmedicas.instrucciones FROM recetasMedicas where id = @id",
277,73,qryc2,"SELECT snombrecli as snombretra, snifcli as sniftra, sdomiciliocli as sdomiciliotra, spoblacioncli as spoblaciontra, numcolegiado, especialidad FROM clientes c2 WHERE c2.codsubusu = @icodsubusu and tipobd=1",
277,74,qryrecetasxml,"SELECT numerolote, numero as numreceta, cve from recetasXML where id = @id_xml",
278,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
278,4,qrycli,"select clientes.snombrecli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli from clientes 
where clientes.icodcli = @icodcli
",
281,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
281,4,qrycli,"select clientes.nmandato,clientes.snombrecli,clientes.sdomiciliocli,clientes.scodpostalcli,clientes.spoblacioncli,clientes.snombrepais,clientes.iban,clientes.bicswift, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli from clientes 
where clientes.icodcli = @icodcli
",
282,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
282,4,qrycli,"select clientes.snombrecli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
282,71,qryprevcobros,"SELECT prevcobros.fechaingreso as fechagasing,prevcobros.nombrecli as cliente,
prevcobros.cobrado as realizada,prevcobros.fechacobro as fecharealizada,
prevcobros.inumfactura as inumfact,prevcobros.ctacliente as ctaacrcli,
prevcobros.ctaingreso as ctagasing, 1 as tipo,
(case prevcobros.factura when 1 then 'Factura Oficial' when 2 then
(case prevcobros.tipoprof when 2 then 'Presupuesto' when 3 then 'Albarán'
else 'Factura Proforma' end)
else '' end) as tipofactura,
l.fecha as fecharemesa,
isnull(rec.nrecibo,l.nrecibo) as nrecibo,
(case isnull(l.fecha, '') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case prevcobros.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
cli.fechaalta as fechaaltacliente, null,prevcobros.concepto,prevcobros.total,centrospredef.sdescripcion,prevcobros.total as totalletra ,s.nombre as usuario, cp2.sdescripcion as sdescripcioncentrospredef ,vistapac.pacientenombre  FROM prevcobros
left join linereme l on l.idprevcobros=prevcobros.id
left join remesas r on l.idremesa=r.idremesa
left join recibos rec on rec.idprevcobros=prevcobros.id
left join facturas f on f.yearfact=prevcobros.yearfact and f.inumfactura=prevcobros.inumfactura and
f.codsubusu=prevcobros.subusufact and f.serie=prevcobros.serie
left join proforma prof on prof.yearfact=prevcobros.yearfact and prof.inumfactura=prevcobros.inumfactura and
prof.codsubusu=prevcobros.subusufact and prof.tipoprof=prevcobros.tipoprof
left join clientes cli on prevcobros.inumexp=cli.icodcli and prevcobros.origen = 'cli'
left join centrospredef on centrospredef.id=cli.idcentros
left join centrospredef cp2 on cp2.id=prevcobros.idcentros
left join subusu s on prevcobros.codsubusu=s.icodsubusu left join vListadoCobrosPacientes vistapac on vistapac.id=prevcobros.id  where prevcobros.id = @id ",sourcedatosfact
284,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
284,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.scodpostalcli,clientes.spoblacioncli,clientes.sprovinciacli,clientes.stelefonocli,clientes.smovilcli,clientes.telefono2,clientes.sfaxcli,clientes.telefono3,clientes.email, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli from clientes 
where clientes.icodcli = @icodcli
",
284,35,qryseg,"select null,segcli.sactuacion,segcli.notas, segcli.icodcli,segcli.dfechaact,segcli.linea,subusu.nombre as usuario, clientes.snombrecli as tercero,
CONVERT(VARCHAR, horainiact, 108) as horainiact,CONVERT(VARCHAR, horafinact, 108) as horafinact,convert(char(8), dateadd(second, segcli.tiempo, ''), 114) as tiempo, isnull(coleg.numcolegiado,'') as numcolegusuact  , ecita.descripcion as estadosalaespera  from segcli left join subusu on segcli.subusu=subusu.icodsubusu
left join segcliterceros st on segcli.icodcli=st.icodcli and segcli.dfechaact=st.dfechaact and segcli.linea=st.linea and st.principal=1
left join clientes on st.icodtercero=clientes.icodcli
left join vlistadobonos on vlistadobonos.id = segcli.idbono
left join clientes coleg on segcli.subusu =coleg.codsubusu and coleg.tipobd=1  left join estadosCita ecita on ecita.id=segcli.idEstadoCita where segcli.icodcli = @icodcli and tipoactu <> 'Aviso' order by segcli.dfechaact,segcli.horainiact",
284,37,qrysubusu,"SELECT subusu.nombre ,tra.especialidad AS especialidadtra  ,tra.numcolegiado as numcolegiadotra  FROM subusu LEFT JOIN clientes ON subusu.icodsubusu=clientes.codsubusu   LEFT JOIN clientes tra ON subusu.icodsubusu=tra.CodSubUSu AND tra.tipobd=1  WHERE clientes.icodcli = @icodcli",
285,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
285,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.smovilcli,clientes.telefono2,clientes.telefono3,clientes.email,clientes.pagweb,clientes.codigo,clientes.fechaalta, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli from clientes 
where clientes.icodcli = @icodcli
",
285,37,qrysubusu,"SELECT subusu.nombre ,tra.especialidad AS especialidadtra  ,tra.numcolegiado as numcolegiadotra  FROM subusu LEFT JOIN clientes ON subusu.icodsubusu=clientes.codsubusu   LEFT JOIN clientes tra ON subusu.icodsubusu=tra.CodSubUSu AND tra.tipobd=1  WHERE clientes.icodcli = @icodcli",
287,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion from director where icodprocu=:icodprocu",
287,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo from clientes where icodcli=:icodcli",
287,35,qryseg,"select segcli.dfechaact,segcli.sactuacion,segcli.notas,subusu.nombre as usuario,DATENAME(hh, horainiact) + ':' +DATENAME(mi, horainiact) + ':' + DATENAME(ss, horainiact) as horainiact,DATENAME(hh, horafinact) + ':' +DATENAME(mi, horafinact) + ':' + DATENAME(ss, horafinact) as horafinact,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo from segcli left join subusu on segcli.subusu=subusu.icodsubusu where icodcli=:icodcli",
287,37,qrysubusu,select subusu.nombre from subusu left join clientes on subusu.icodsubusu=clientes.codsubusu where clientes.icodcli=:icodcli,
288,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
288,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr from clientes where icodcli=:icodcli",
288,35,qryseg,"select segcli.dfechaact,segcli.sactuacion,segcli.notas,subusu.nombre as usuario,DATENAME(hh, horainiact) + ':' +DATENAME(mi, horainiact) + ':' + DATENAME(ss, horainiact) as horainiact,DATENAME(hh, horafinact) + ':' +DATENAME(mi, horafinact) + ':' + DATENAME(ss, horafinact) as horafinact,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo from segcli left join subusu on segcli.subusu=subusu.icodsubusu where icodcli=:icodcli",
288,37,qrysubusu,select subusu.nombre from subusu left join clientes on subusu.icodsubusu=clientes.codsubusu where clientes.icodcli=:icodcli,
289,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
289,4,qrycli,"select clientes.snombrecli,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr,(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,clientes.icodcli  from clientes where icodcli=:icodcli",
290,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
290,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,clientes.stelefonocli,clientes.telefono2,clientes.smovilcli,clientes.sfaxcli,clientes.email,clientes.pagweb,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr,(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,clientes.icodcli  from clientes where icodcli=:icodcli",
290,35,qryseg,"select null,segcli.sactuacion,segcli.icodcli,segcli.dfechaact,segcli.linea,subusu.nombre as usuario, clientes.snombrecli as tercero, CONVERT(VARCHAR, horainiact, 108) as horainiact,CONVERT(VARCHAR, horafinact, 108) as horafinact,convert(char(8), dateadd(second, segcli.tiempo, ''), 114) as tiempo  from segcli left join subusu on segcli.subusu=subusu.icodsubusu left join segcliterceros st on segcli.icodcli=st.icodcli and segcli.dfechaact=st.dfechaact and segcli.linea=st.linea and st.principal=1 left join clientes on st.icodtercero=clientes.icodcli where segcli.icodcli=:icodcli order by segcli.dfechaact,segcli.horainiact",
291,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+datename(month, getdate())+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
291,4,qrycli,"select clientes.codigo,clientes.snombrecli,clientes.sdomiciliocli,clientes.scodpostalcli,clientes.spoblacioncli,clientes.stelefonocli,clientes.smovilcli,clientes.email,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr,(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,clientes.icodcli  from clientes where icodcli=:icodcli",
291,35,qryseg,"select segcli.notas,segcli.notas2,segcli.notas3,segcli.icodcli,segcli.dfechaact,segcli.linea,subusu.nombre as usuario, clientes.snombrecli as tercero, CONVERT(VARCHAR, horainiact, 108) as horainiact,CONVERT(VARCHAR, horafinact, 108) as horafinact,convert(char(8), dateadd(second, segcli.tiempo, ''), 114) as tiempo  from segcli left join subusu on segcli.subusu=subusu.icodsubusu left join segcliterceros st on segcli.icodcli=st.icodcli and segcli.dfechaact=st.dfechaact and segcli.linea=st.linea and st.principal=1 left join clientes on st.icodtercero=clientes.icodcli where segcli.icodcli=:icodcli order by segcli.dfechaact,segcli.horainiact",
291,37,qrysubusu,"select subusu.nombre ,tra.especialidad as especialidadtra  ,tra.numcolegiado as numcolegiadotra  from subusu left join clientes on subusu.icodsubusu=clientes.codsubusu   left join clientes tra on subusu.icodsubusu=tra.CodSubUSu and tra.tipobd=1  where clientes.icodcli=:icodcli",
291,77,qryclivaloresperfil,"select [1] as Campo0101,[2] as Campo0102,[3] as Campo0103,[4] as Campo0104,[5] as Campo0105,[6] as Campo0106,[7] as Campo0107,[8] as Campo0108,[9] as Campo0109,[10]  as Campo0110,[11] as Campo0201,[12] as Campo0202,[13] as Campo0203,[14] as Campo0204,[15] as Campo0205,[16] as Campo0206,[17] as Campo0207,[18] as Campo0208,[19] as Campo0209,[20] as Campo0210,[21] as Campo0301, [22] as Campo0302,[23] as Campo0303,[24] as Campo0304,[25] as Campo0305,[26] as Campo0306,[27] as Campo0307,[28] as Campo0308,[29] as Campo0309,[30] as Campo0310, [31] as Campo0111, [32] as Campo0112,[33] as Campo0113,[34] as Campo0114,[35] as Campo0115,[36] as Campo0211,[37] as Campo0212,[38] as Campo0213,[39] as Campo0214,[40] as Campo0215, [41] as Campo0311, [42] as Campo0312,[43] as Campo0313,[44] as Campo0314,[45] as Campo0315 from cliValoresPerfil PIVOT( min(valor) FOR idcampo IN ([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15],[16],[17],[18],[19],[20],[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],[31],[32],[33],[34],[35],[36],[37],[38],[39],[40],[41],[42],[43],[44],[45])) AS pt where icodcli=:icodcli",
292,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+lower(datename(month, getdate()))+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
292,4,qrycli,"select clientes.snombrecli,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr,(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,clientes.icodcli  from clientes  where clientes.icodcli=:icodcli",
293,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+lower(datename(month, getdate()))+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
293,4,qrycli,"select clientes.snombrecli,clientes.snifcli,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr,(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,clientes.icodcli  from clientes  where clientes.icodcli=:icodcli",
294,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+lower(datename(month, getdate()))+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
294,4,qrycli,"select clientes.snombrecli,clientes.snifcli,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr,(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,clientes.icodcli  from clientes  where clientes.icodcli=:icodcli",
294,35,qryseg,"select null,segcli.icodcli,segcli.dfechaact,segcli.linea,subusu.nombre as usuario, clientes.snombrecli as tercero, CONVERT(VARCHAR, horainiact, 108) as horainiact,CONVERT(VARCHAR, horafinact, 108) as horafinact,convert(char(8), dateadd(second, segcli.tiempo, ''), 114) as tiempo, isnull(coleg.numcolegiado,'') as numcolegusuact  from segcli left join subusu on segcli.subusu=subusu.icodsubusu  left join segcliterceros st on segcli.icodcli=st.icodcli and segcli.dfechaact=st.dfechaact and segcli.linea=st.linea and st.principal=1  left join clientes on st.icodtercero=clientes.icodcli  left join vlistadobonos on vlistadobonos.id = segcli.idbono  left join clientes coleg on segcli.subusu =coleg.codsubusu and coleg.tipobd=1 where segcli.icodcli=:icodcli and tipoactu <> 'Aviso' order by segcli.dfechaact,segcli.horainiact",
295,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) +'/'+ cast(datepart(mm,getdate()) as varchar) +'/'+ cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,(datename(day,getdate())+' de '+lower(datename(month, getdate()))+' de '+datename(year,getdate())) as fechaimpresionlarga from director where icodprocu=:icodprocu",
295,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4)+'************'+substring(cuentabanco,17,4)) as cuentabancocifr,(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,clientes.icodcli  from clientes  where clientes.icodcli=:icodcli",
295,70,qryoporcli,"select oporcli.*,subusu.nombre as subusuario from oporcli left join subusu on oporcli.icodusu=subusu.icodsubusu where oporcli.icodopor=:icodopor",
295,78,qryoporcuentas," select oporcuentas.*,subusu.nombre as subusuario  ,(oporcuentas.oportunidad+ ' ' + isnull(cast(oporcuentas.notas as varchar(MAX)),' ')) as conceptonotas  from oporcuentas  left join subusu on oporcuentas.icodusu=subusu.icodsubusu  where oporcuentas.icodopor=:icodopor order by oporcuentas.orden ",
296,4,qryclientes,"SELECT clientes.snombrecli,clientes.snifcli, CEXT.mascotanumero as chip,CEXT.mascotaespecie as especie FROM clientes LEFT JOIN clientesext CEXT on clientes.icodcli = CEXT.icodcli WHERE clientes.icodcli = @icodcli",
296,37,qrysubusu,SELECT subusu.nombre FROM subusu WHERE icodsubusu = @icodsubusu,
296,72,qryrecetasmedicas,"SELECT R.*, CAST (R.idPActivo AS varchar(MAX)) AS principio, CASE WHEN R.prescripExtra = 1 THEN 'Sí' ELSE 'No' END AS prescripcion FROM recetasMedicas R WHERE R.id = @id",
296,73,qryc2,"SELECT snombrecli as snombretra, snifcli as sniftra, sdomiciliocli as sdomiciliotra, spoblacioncli as spoblaciontra, numcolegiado, especialidad FROM clientes c2 WHERE c2.codsubusu = @icodsubusu and tipobd=1",
296,74,qryrecetasxml,"SELECT numerolote, numero as numreceta, cve from recetasXML where id = @id_xml",
297,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
297,4,qrycli,"select clientes.snombrecli,clientes.snifcli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
297,35,qryseg,"select null, segcli.icodcli,segcli.dfechaact,segcli.linea,subusu.nombre as usuario, clientes.snombrecli as tercero,
CONVERT(VARCHAR, horainiact, 108) as horainiact,CONVERT(VARCHAR, horafinact, 108) as horafinact,convert(char(8), dateadd(second, segcli.tiempo, ''), 114) as tiempo, isnull(coleg.numcolegiado,'') as numcolegusuact  , ecita.descripcion as estadosalaespera  from segcli left join subusu on segcli.subusu=subusu.icodsubusu
left join segcliterceros st on segcli.icodcli=st.icodcli and segcli.dfechaact=st.dfechaact and segcli.linea=st.linea and st.principal=1
left join clientes on st.icodtercero=clientes.icodcli
left join vlistadobonos on vlistadobonos.id = segcli.idbono
left join clientes coleg on segcli.subusu =coleg.codsubusu and coleg.tipobd=1  left join estadosCita ecita on ecita.id=segcli.idEstadoCita where segcli.icodcli = @icodcli and tipoactu <> 'Aviso' order by segcli.dfechaact,segcli.horainiact",
298,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
298,4,qrycli,"select clientes.snombrecli,clientes.snifcli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
299,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
299,4,qrycli,"select clientes.codigo,clientes.snombrecli,clientes.edad,clientes.sdomiciliocli,clientes.spoblacioncli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
299,81,qryhistoriaclinica,select 'Historia Clínica',
300,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
300,4,qrycli,"select clientes.codigo,clientes.snombrecli,clientes.edad,clientes.sdomiciliocli,clientes.spoblacioncli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
300,35,qryseg,"select null, segcli.icodcli,segcli.dfechaact,segcli.linea,subusu.nombre as usuario, clientes.snombrecli as tercero,
CONVERT(VARCHAR, horainiact, 108) as horainiact,CONVERT(VARCHAR, horafinact, 108) as horafinact,convert(char(8), dateadd(second, segcli.tiempo, ''), 114) as tiempo, isnull(coleg.numcolegiado,'') as numcolegusuact  , ecita.descripcion as estadosalaespera  from segcli left join subusu on segcli.subusu=subusu.icodsubusu
left join segcliterceros st on segcli.icodcli=st.icodcli and segcli.dfechaact=st.dfechaact and segcli.linea=st.linea and st.principal=1
left join clientes on st.icodtercero=clientes.icodcli
left join vlistadobonos on vlistadobonos.id = segcli.idbono
left join clientes coleg on segcli.subusu =coleg.codsubusu and coleg.tipobd=1  left join estadosCita ecita on ecita.id=segcli.idEstadoCita where segcli.icodcli = @icodcli and tipoactu <> 'Aviso' order by segcli.dfechaact,segcli.horainiact",
300,81,qryhistoriaclinica,select 'Historia Clínica',
301,1,qrydirector,"select d.*,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga, p.nombre as paisempresa 
from director d  
left join paises p on d.idpais=p.id where d.icodprocu = @icodprocu",
301,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.scodpostalcli,clientes.spoblacioncli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
302,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
302,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
302,70,qryoporcli,"SELECT O.*, S.nombre AS subusuario, ISNULL(C.snombrecli, E.descripcion) AS asociadoa
FROM oporcli O
LEFT JOIN clientes CO ON O.icodcli = CO.icodcli
LEFT JOIN subusu S ON O.icodusu = S.icodsubusu
LEFT JOIN clientes C ON O.icodcliRelacionado = C.icodcli
LEFT JOIN expedien E ON O.inumexp = E.inumexp AND O.iyear = E.iyear
WHERE O.icodopor = @icodopor",
302,78,qryoporcuentas,"select oporcuentas.*, subusu.nombre as subusuario,
				(oporcuentas.oportunidad + ' ' + isnull(cast(oporcuentas.notas as varchar(MAX)),' ')) as conceptonotas
				 ,round(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * (ISNULL(poriva, 0) + ISNULL(porrecargo, 0)))/100,2) as totaliva 
					,round(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * isnull(irpf,0))/100,2) as totalirpf 
					,round((isnull(importecierre,0) -(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * isnull(irpf,0))/100) + 
				(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * (ISNULL(poriva, 0) + ISNULL(porrecargo, 0)))/100)),2) as total 
				from oporcuentas
				left join subusu on oporcuentas.icodusu=subusu.icodsubusu
				where oporcuentas.icodopor = @icodopor order by oporcuentas.orden ",
302,83,qryoporclipedido,"SELECT oporclipedido.numopor,oporclipedido.dfecha, subusu.nombre AS subusuario, ISNULL(C.snombrecli, E.descripcion) AS asociadoa, P.snombrecli AS nomproveedor, P.snifcli AS nifproveedor
FROM oporcli oporclipedido
LEFT JOIN subusu ON oporclipedido.icodusu = subusu.icodsubusu
LEFT JOIN clientes P ON oporclipedido.icodcli = P.icodcli
LEFT JOIN clientes C ON oporclipedido.icodcliRelacionado = C.icodcli
LEFT JOIN expedien E ON oporclipedido.inumexp = E.inumexp AND oporclipedido.iyear = E.iyear
WHERE oporclipedido.icodopor = @icodopor",
303,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
303,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli,clientes.sprovinciacli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
303,70,qryoporcli,"SELECT O.*, S.nombre AS subusuario, ISNULL(C.snombrecli, E.descripcion) AS asociadoa
FROM oporcli O
LEFT JOIN clientes CO ON O.icodcli = CO.icodcli
LEFT JOIN subusu S ON O.icodusu = S.icodsubusu
LEFT JOIN clientes C ON O.icodcliRelacionado = C.icodcli
LEFT JOIN expedien E ON O.inumexp = E.inumexp AND O.iyear = E.iyear
WHERE O.icodopor = @icodopor",
303,78,qryoporcuentas,"select oporcuentas.*, subusu.nombre as subusuario,
				(oporcuentas.oportunidad + ' ' + isnull(cast(oporcuentas.notas as varchar(MAX)),' ')) as conceptonotas
				 ,round(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * (ISNULL(poriva, 0) + ISNULL(porrecargo, 0)))/100,2) as totaliva 
					,round(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * isnull(irpf,0))/100,2) as totalirpf 
					,round((isnull(importecierre,0) -(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * isnull(irpf,0))/100) + 
				(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * (ISNULL(poriva, 0) + ISNULL(porrecargo, 0)))/100)),2) as total 
				from oporcuentas
				left join subusu on oporcuentas.icodusu=subusu.icodsubusu
				where oporcuentas.icodopor = @icodopor order by oporcuentas.orden ",
303,83,qryoporclipedido,"SELECT oporclipedido.numopor,oporclipedido.dfecha, subusu.nombre AS subusuario, ISNULL(C.snombrecli, E.descripcion) AS asociadoa, P.snombrecli AS nomproveedor, P.snifcli AS nifproveedor
FROM oporcli oporclipedido
LEFT JOIN subusu ON oporclipedido.icodusu = subusu.icodsubusu
LEFT JOIN clientes P ON oporclipedido.icodcli = P.icodcli
LEFT JOIN clientes C ON oporclipedido.icodcliRelacionado = C.icodcli
LEFT JOIN expedien E ON oporclipedido.inumexp = E.inumexp AND oporclipedido.iyear = E.iyear
WHERE oporclipedido.icodopor = @icodopor",
304,1,qrydirector,"select d.*,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga, p.nombre as paisempresa 
from director d  
left join paises p on d.idpais=p.id where d.icodprocu = @icodprocu",
304,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.scodpostalcli,clientes.spoblacioncli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
305,1,qrydirector,"select d.*,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga, p.nombre as paisempresa 
from director d  
left join paises p on d.idpais=p.id where d.icodprocu = @icodprocu",
305,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
305,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
306,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
306,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totalivaeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
306,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
307,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
307,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaldctoeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
307,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion,linefact.fpreciounitario,linefact.dctolinea, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
308,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
308,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaldctoeuro,facturas.totalivaeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
308,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion,linefact.fpreciounitario,linefact.dctolinea, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
309,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
309,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaldctoeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
309,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion,linefact.fpreciounitario,linefact.dctolinea, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
309,82,qryclipacientes,"select clipac.snombrecli,convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
				(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr,clipac.icodcli  from clipacientes pac left join clientes clipac on pac.icodpaciente=clipac.icodcli  where pac.icodcli = @icodcli",
310,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
310,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaldctoeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
310,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion,linefact.fpreciounitario,linefact.dctolinea, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
311,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
311,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.inumfactabonada,facturas.serieabonada,facturas.fechaabonada,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
311,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
312,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
312,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.inumfactabonada,facturas.serieabonada,facturas.fechaabonada,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
312,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, linefact.unidades,linefact.descripcion, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
313,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
313,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
313,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, null,linefact.descripcion, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
314,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
314,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaldctoeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
314,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, null,linefact.descripcion, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
315,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
315,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.nombrecli,facturas.nifcli,facturas.domiciliocli,facturas.poblacioncli,facturas.codpostalcli,facturas.provinciacli,facturas.inumfactura,facturas.serie,facturas.fecha,facturas.totaldctoeuro,facturas.totaleuro,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
315,45,qrylinefact,"select (linefact.descripcion + ' ' + isnull(cast(linefact.notas as varchar(MAX)),' ')) as descripnotas, (isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, null,linefact.unidades,linefact.descripcion,linefact.fpreciounitario,linefact.dctolinea, s.nombre as usuario,
(round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0)) -
round((round((isnull(linefact.salidaeuro,0) - round(isnull(linefact.salidaeuro,0)*(isnull(linefact.dctolinea,0)/100),2)),0))*(isnull(linefact.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,linefact.origen,c.idartstock,c.honogasto, c.referencia as referenciacuencli, art.codigo as codarticulo,
(case linefact.tipoproformarel
 when 0 then 'Oficial'
 when 1 then 'Pro forma'
 when 2 then 'Presupuesto'
 when 3 then 'Albarán'
 when 4 then 'Pedido'
 When 5 then 'Orden'
 else ''
 end) as TipoDoc
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.porrecargo)/100) as cuotarec
,((((isnull(linefact.salidaeuro,0))-(isnull(linefact.totaldctoeuro,0)))*linefact.poriva)/100) as cuotaivasinrec
,art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8
,art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when linefact.unidades=0 then linefact.fpreciounitario
else cast(round(isnull(linefact.fpreciounitario,0)-(isnull(linefact.totaldctoeuro,0)/isnull(linefact.unidades,1)),2) as money) end as preciounimenosdcto,
c.numexpediente  , case (isnull(cm.snombrecli, ''))
when '' then
	case (isnull(cliseg.snombrecli, ''))
	when '' then clisegclider.snombrecli
	else cliseg.snombrecli
	end
else cm.snombrecli
end
as pacientenombre from linefact
left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea 
left join subusu s on c.subusu=s.icodsubusu 
left join articulos art on c.idartstock=art.id left join controlmutua cm on linefact.linea = cm.linefact and linefact.inumfactura = cm.inumfactura and linefact.yearfact = cm.yearfact and linefact.codsubusu=cm.codsubusu and linefact.serie=cm.serie 
and linefact.fechaconcep=cm.dfechaconceptofact
left join segcli_cuencli segcuen on linefact.Origen = 'cli' and segcuen.icodcli_cuencli=linefact.inumexpexho and segcuen.linea_cuencli=linefact.lineacuentas and segcuen.dfecha_cuencli=linefact.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on linefact.origen = 'cli' and cuenclisegclider.icodclicuencli=linefact.inumexpexho and cuenclisegclider.dfechacuencli=linefact.fechaconcep and cuenclisegclider.lineacuencli=linefact.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>linefact.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where linefact.inumfactura = @inumfactura and linefact.yearfact = @yearfact and linefact.codsubusu = @codsubusu and linefact.serie = @serie order by linefact.numero",sourcedatosfact
316,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
316,4,qrycli,"select clientes.snombrecli,clientes.snifcli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
316,71,qryprevcobros,"SELECT prevcobros.fechaingreso as fechagasing,prevcobros.nombrecli as cliente,
prevcobros.cobrado as realizada,prevcobros.fechacobro as fecharealizada,
prevcobros.inumfactura as inumfact,prevcobros.ctacliente as ctaacrcli,
prevcobros.ctaingreso as ctagasing, 1 as tipo,
(case prevcobros.factura when 1 then 'Factura Oficial' when 2 then
(case prevcobros.tipoprof when 2 then 'Presupuesto' when 3 then 'Albarán'
else 'Factura Proforma' end)
else '' end) as tipofactura,
l.fecha as fecharemesa,
isnull(rec.nrecibo,l.nrecibo) as nrecibo,
(case isnull(l.fecha, '') when '' then 0 else 1 end) as estaremesado,
r.banco as banco,
(case prevcobros.factura when 1 then f.fecha when 2 then prof.fecha end) as fechafact,
f.tipologia1 as tip1,f.tipologia2 as tip2,f.tipologia3 as tip3,
cli.fechaalta as fechaaltacliente, null,prevcobros.concepto,prevcobros.total,centrospredef.sdescripcion,prevcobros.total as totalletra ,s.nombre as usuario, cp2.sdescripcion as sdescripcioncentrospredef ,vistapac.pacientenombre  FROM prevcobros
left join linereme l on l.idprevcobros=prevcobros.id
left join remesas r on l.idremesa=r.idremesa
left join recibos rec on rec.idprevcobros=prevcobros.id
left join facturas f on f.yearfact=prevcobros.yearfact and f.inumfactura=prevcobros.inumfactura and
f.codsubusu=prevcobros.subusufact and f.serie=prevcobros.serie
left join proforma prof on prof.yearfact=prevcobros.yearfact and prof.inumfactura=prevcobros.inumfactura and
prof.codsubusu=prevcobros.subusufact and prof.tipoprof=prevcobros.tipoprof
left join clientes cli on prevcobros.inumexp=cli.icodcli and prevcobros.origen = 'cli'
left join centrospredef on centrospredef.id=cli.idcentros
left join centrospredef cp2 on cp2.id=prevcobros.idcentros
left join subusu s on prevcobros.codsubusu=s.icodsubusu left join vListadoCobrosPacientes vistapac on vistapac.id=prevcobros.id  where prevcobros.id = @id ",sourcedatosfact
317,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
317,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.fechanacimiento, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
317,85,qrypaccli,"select paccli.snombrecli,paccli.snifcli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr,paccli.icodcli
from clipacientes pac left join clientes paccli on pac.icodcli=paccli.icodcli
where pac.icodpaciente = @icodcli",
318,1,qrydirector,"select d.*,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga, p.nombre as paisempresa 
from director d  
left join paises p on d.idpais=p.id where d.icodprocu = @icodprocu",
318,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.scodpostalcli,clientes.spoblacioncli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
319,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
319,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
319,46,qryprof,"select ((totalderechoseuro - isnull(totaldctoeuro,0)) + totalivaeuro - totalirpfeuro) as totalbaseivairpf,((totalderechoseuro - isnull(totaldctoeuro,0)) + totalivaeuro) as totalbaseiva,
(totalderechoseuro - isnull(totaldctoeuro,0) + totalivaeuro) as totalhonodctoiva,
(isnull(proforma.totalderechoseuro,0) - isnull(proforma.totanticipos,0)) as totderechomenosanticipo,
(totalderechoseuro - isnull(totaldctoeuro,0)) as totalbaseimp,
(totalsuplidoseuro + (totalderechoseuro - isnull(totaldctoeuro,0)) + totalivaeuro - totalirpfeuro) as totalminuta, proforma.inumfactura,proforma.fecha,proforma.totalivaeuro,proforma.totaleuro, (substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,(datename(day,fecha) + ' de ' + lower(datename(month, fecha)) + ' de ' + datename(year,fecha)) as fechafacturalarga,
(((isnull(proforma.honocondctolin,0) - isnull(proforma.totsolodctofact,0)) + isnull(proforma.totportes,0))) as baseConPortes, pl.descripcion as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM lineprof
left join cuencli c on lineprof.inumexpexho=c.icodcli and lineprof.fechaconcep=c.dfecha and lineprof.lineacuentas=c.linea
where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
and proforma.inumfactura = lineprof.inumfactura and proforma.yearfact=lineprof.yearfact and proforma.codsubusu=lineprof.codsubusu and proforma.tipoprof=lineprof.tipoprof) as totbaseimpsolohono,
(isnull(proforma.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos,
 totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos,
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos,
ISNULL(proforma.totacuenta, 0) as importecobrado,
ISNULL(proforma.TotalEuro, 0) - ISNULL(proforma.totacuenta, 0) as totalpendiente,
exp.inumexp, exp.expediente, exp.iyear,
(isnull(proforma.totalsuplidoseuro,0) + isnull(proforma.totalhonoeuro,0)) as totsupmashono,
(isnull(proforma.totalhonoeuro,0) - isnull(proforma.totalgastoeuro,0) - isnull(proforma.totanticipos,0)) as tothonomenosgastomenosanticipo
from proforma left join plazosc pl on proforma.idplazos = pl.id
left join expedien exp on proforma.inumexprelacionado = exp.inumexp and proforma.iyearrelacionado = exp.iyear

left join
(select
sum
(
case lineprof.tipo
when 'ANTICIPO' then
isnull(totalivaeuro,0)
else 0
end  )as totalivaanticipos,
sum
(
case lineprof.tipo
when 'HONORARIO' then
case ISNULL(c.honogasto,0)
when 0 then
case ISNULL(c.bhonoarticulo,0)
when 0 then
isnull(totalivaeuro,0)
else 0
end
else 0
end
else 0
end )as totalivahonorarios,

sum
(
case lineprof.tipo
when 'HONORARIO' then
case ISNULL(c.bhonoarticulo,0)
when 1 then
isnull(totalivaeuro,0)
else 0
end
else 0
end )as totalivaarticulos,
 sum  
    (   
     case lineprof.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case lineprof.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case lineprof.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case lineprof.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case lineprof.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case lineprof.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case lineprof.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case lineprof.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case lineprof.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,       
lineprof.inumfactura as lineprofinumfactura, lineprof.yearfact as lineprofyearfact, lineprof.tipoprof as lineproftipoprof, lineprof.codsubusu as lineprofcodsubusu from lineprof
left join cuencli c on c.icodcli=lineprof.inumexpexho and c.dfecha =lineprof.fechaconcep and c.linea  = lineprof.lineacuentas
where (lineprof.tipo= 'HONORARIO' or lineprof.tipo= 'ANTICIPO')
group by lineprof.inumfactura, lineprof.yearfact, lineprof.tipoprof, lineprof.codsubusu)
as tbliva on tbliva.lineprofinumfactura=proforma.inumfactura and tbliva.lineprofyearfact=proforma.yearfact and tbliva.lineprofcodsubusu=proforma.codsubusu and tbliva.lineproftipoprof=proforma.tipoprof
where inumfactura = @inumfactura and yearfact = @yearfact and proforma.codsubusu = @codsubusu and tipoprof = @tipoprof ",sourcedatosfact
319,86,qrylineprof,"select (lineprof.descripcion + ' ' + isnull(cast(lineprof.notas as varchar(MAX)), ' ')) as descripnotas,(isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, lineprof.descripcion,lineprof.unidades,lineprof.fpreciounitario,lineprof.salidaeuro, s.nombre as usuario,
(round((isnull(lineprof.salidaeuro,0) - round(isnull(lineprof.salidaeuro,0)*(isnull(lineprof.dctolinea,0)/100),2)),0)) -
round((round((isnull(lineprof.salidaeuro,0) - round(isnull(lineprof.salidaeuro,0)*(isnull(lineprof.dctolinea,0)/100),2)),0))*(isnull(lineprof.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,lineprof.origen,c.idartstock,
(case lineprof.tipoproformarel
when 0 then 'Oficial'
when 1 then 'Pro forma'
when 2 then 'Presupuesto'
when 3 then 'Albarán'
when 4 then 'Pedido'
when 5 then 'Orden'
else ''
end) as TipoDoc,
((((isnull(lineprof.salidaeuro,0))-(isnull(lineprof.totaldctoeuro,0)))*lineprof.porrecargo)/100) as cuotarec,
((((isnull(lineprof.salidaeuro,0))-(isnull(lineprof.totaldctoeuro,0)))*lineprof.poriva)/100) as cuotaivasinrec,
art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8,
art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when lineprof.unidades=0 then lineprof.fpreciounitario
else cast(round(isnull(lineprof.fpreciounitario,0)-(isnull(lineprof.totaldctoeuro,0)/isnull(lineprof.unidades,1)),2) as money) end as preciounimenosdcto, c.referencia as referenciacuencli   ,case (isnull(cliseg.snombrecli, '')) when '' then clisegclider.snombrecli else cliseg.snombrecli end as pacientenombre from lineprof
left join cuencli c on lineprof.inumexpexho=c.icodcli and lineprof.fechaconcep=c.dfecha and lineprof.lineacuentas=c.linea
left join subusu s on c.subusu=s.icodsubusu
left join articulos art on c.idartstock=art.id left join segcli_cuencli segcuen on lineprof.Origen = 'cli' and segcuen.icodcli_cuencli=lineprof.inumexpexho and segcuen.linea_cuencli=lineprof.lineacuentas and segcuen.dfecha_cuencli=lineprof.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on lineprof.origen = 'cli' and cuenclisegclider.icodclicuencli=lineprof.inumexpexho and cuenclisegclider.dfechacuencli=lineprof.fechaconcep and cuenclisegclider.lineacuencli=lineprof.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>lineprof.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where lineprof.inumfactura = @inumfactura and lineprof.yearfact = @yearfact and lineprof.codsubusu = @codsubusu and lineprof.tipoprof = @tipoprof order by lineprof.numero",sourcedatosfact
320,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
320,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli,clientes.spoblacioncli,clientes.scodpostalcli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
320,70,qryoporcli,"SELECT O.*, S.nombre AS subusuario, ISNULL(C.snombrecli, E.descripcion) AS asociadoa
FROM oporcli O
LEFT JOIN clientes CO ON O.icodcli = CO.icodcli
LEFT JOIN subusu S ON O.icodusu = S.icodsubusu
LEFT JOIN clientes C ON O.icodcliRelacionado = C.icodcli
LEFT JOIN expedien E ON O.inumexp = E.inumexp AND O.iyear = E.iyear
WHERE O.icodopor = @icodopor",
320,78,qryoporcuentas,"select oporcuentas.*, subusu.nombre as subusuario,
				(oporcuentas.oportunidad + ' ' + isnull(cast(oporcuentas.notas as varchar(MAX)),' ')) as conceptonotas
				 ,round(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * (ISNULL(poriva, 0) + ISNULL(porrecargo, 0)))/100,2) as totaliva 
					,round(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * isnull(irpf,0))/100,2) as totalirpf 
					,round((isnull(importecierre,0) -(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * isnull(irpf,0))/100) + 
				(((isnull(prevision,0) -((isnull(prevision,0)*isnull(dctolinea,0))/100)) * (ISNULL(poriva, 0) + ISNULL(porrecargo, 0)))/100)),2) as total 
				from oporcuentas
				left join subusu on oporcuentas.icodusu=subusu.icodsubusu
				where oporcuentas.icodopor = @icodopor order by oporcuentas.orden ",
321,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
321,4,qrycli,"select clientes.snombrecli,clientes.snifcli,clientes.sdomiciliocli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli, clientesext.*, tiposIdentificacion.descripcion as tipoidentificacion, clientesext.paistipoid as paisexpedicion from clientes 
left join clientesext on clientes.icodcli = clientesext.icodcli 
left join tiposIdentificacion on tiposIdentificacion.codigo = clientesext.tipoid 
where clientes.icodcli = @icodcli
",
323,1,qrydirector,"select *,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga from director where icodprocu = @icodprocu",
323,4,qrycli,"select clientes.snombrecli, convert(char(8), dateadd(second, tiempo, ''), 114) as tiempo,(substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8) + replicate('*',LEN(iban)-8)) as ibancifr, clientes.icodcli from clientes 
where clientes.icodcli = @icodcli
",
324,1,qrydirector,"select d.*,cast(datepart(dd,getdate()) as varchar) + '/' + cast(datepart(mm,getdate()) as varchar) + '/' + cast(datepart(yyyy,getdate()) as varchar) as fechaimpresion,
(datename(day,getdate()) + ' de ' + lower(datename(month, getdate())) + ' de ' + datename(year,getdate())) as fechaimpresionlarga, p.nombre as paisempresa 
from director d  
left join paises p on d.idpais=p.id where d.icodprocu = @icodprocu",
324,32,qryfact,"select ((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalbaseivairpf,((facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro) as totalbaseiva,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0) + facturas.totalivaeuro) as totalhonodctoiva,
(isnull(facturas.totalderechoseuro,0) - isnull(facturas.totanticipos,0)) as totderechomenosanticipo,
(facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) as totalbaseimp,
(facturas.totalsuplidoseuro + (facturas.totalderechoseuro - isnull(facturas.totaldctoeuro,0)) + facturas.totalivaeuro - facturas.totalirpfeuro) as totalminuta, facturas.fecha,(substring(facturas.cuentabanco,1,4) + '************' + substring(facturas.cuentabanco,17,4)) as cuentabancocifr,
(substring(facturas.iban,1,8) + replicate('*',LEN(facturas.iban)-8)) as ibancifr,(datename(day,facturas.fecha) + ' de ' + lower(datename(month, facturas.fecha)) + ' de ' + datename(year,facturas.fecha)) as fechafacturalarga,
(f2.totalderechoseuro - isnull(f2.totaldctoeuro,0)) as totalbaseimpAbo,f2.TotalIvaEuro as totalivaAbo,f2.TotalEuro as totaleuroabo,
(((isnull(facturas.honocondctolin,0) - isnull(facturas.totsolodctofact,0)) + isnull(facturas.totportes,0))) as baseConPortes,
case when isnull(facturas.usarplazosfechafija,1) = 0 then pl.descripcion else '' end as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM linefact
	left join cuencli c on linefact.inumexpexho=c.icodcli and linefact.fechaconcep=c.dfecha and linefact.lineacuentas=c.linea
	where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
	and facturas.inumfactura = linefact.inumfactura and facturas.yearfact=linefact.yearfact and facturas.codsubusu=linefact.codsubusu and facturas.serie=linefact.serie) as totbaseimpsolohono,
(isnull(facturas.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos
 ,totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos, 
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos, identificadorTBAI,
ISNULL(facturas.TotalEuro, 0) - ISNULL(facturas.importecobrado, 0) as totalpendiente,
(isnull(facturas.totalsuplidoseuro,0) + isnull(facturas.totalhonoeuro,0)) as totsupmashono, DATENAME(MONTH,facturas.fecha) as mesfechafactletra,
(isnull(facturas.totalhonoeuro,0) - isnull(facturas.totalgastoeuro,0) - isnull(facturas.totanticipos,0)) as tothonomenosgastomenosanticipo  from facturas
left join facturas f2 on facturas.yearfactabonada=f2.yearfact and facturas.inumfactabonada=f2.inumfactura and facturas.serieabonada=f2.serie
left join facturasTicketBai ft on facturas.yearfact = ft.yearfact and facturas.inumfactura = ft.inumfactura and facturas.codsubusu = ft.codsubusu and facturas.serie = ft.serie
left join plazosc pl on pl.id = facturas.idplazos
left join
(select
	sum
	(
	case linefact.tipo
	when 'ANTICIPO' then
	isnull(totalivaeuro,0)
	else 0
	end) as totalivaanticipos,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.honogasto,0)
		when 0 then
			case ISNULL(c.bhonoarticulo,0)
			when 0 then
			isnull(totalivaeuro,0)
			else 0
			end
		else 0
		end
	else 0
	end) as totalivahonorarios,
	sum
	(
	case linefact.tipo
	when 'HONORARIO' then
		case ISNULL(c.bhonoarticulo,0)
		when 1 then
		isnull(totalivaeuro,0)
		else 0
		end
	else 0
	end) as totalivaarticulos,
    sum  
    (   
     case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case linefact.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case linefact.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case linefact.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case linefact.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case linefact.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case linefact.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,                                                 
linefact.inumfactura as linefactinumfactura, linefact.yearfact as linefactyearfact, linefact.serie as linefactserie, linefact.codsubusu as linefactcodsubusu from linefact
left join cuencli c on c.icodcli=linefact.inumexpexho and c.dfecha =linefact.fechaconcep and c.linea  = linefact.lineacuentas
where (linefact.tipo = 'HONORARIO' or linefact.tipo = 'ANTICIPO')
group by linefact.inumfactura, linefact.yearfact,  linefact.serie, linefact.codsubusu)
as tbliva on tbliva.linefactinumfactura=facturas.inumfactura and tbliva.linefactyearfact=facturas.yearfact and tbliva.linefactcodsubusu=facturas.codsubusu and tbliva.linefactserie=facturas.serie
where facturas.inumfactura = @inumfactura and facturas.yearfact = @yearfact and facturas.codsubusu = @codsubusu and facturas.serie like @serie ",sourcedatosfact
324,46,qryprof,"select ((totalderechoseuro - isnull(totaldctoeuro,0)) + totalivaeuro - totalirpfeuro) as totalbaseivairpf,((totalderechoseuro - isnull(totaldctoeuro,0)) + totalivaeuro) as totalbaseiva,
(totalderechoseuro - isnull(totaldctoeuro,0) + totalivaeuro) as totalhonodctoiva,
(isnull(proforma.totalderechoseuro,0) - isnull(proforma.totanticipos,0)) as totderechomenosanticipo,
(totalderechoseuro - isnull(totaldctoeuro,0)) as totalbaseimp,
(totalsuplidoseuro + (totalderechoseuro - isnull(totaldctoeuro,0)) + totalivaeuro - totalirpfeuro) as totalminuta, proforma.nombrecli,proforma.nifcli,proforma.domiciliocli,proforma.poblacioncli,proforma.codpostalcli,proforma.provinciacli,proforma.inumfactura,proforma.fecha,proforma.totaleuro, (substring(cuentabanco,1,4) + '************' + substring(cuentabanco,17,4)) as cuentabancocifr,
(substring(iban,1,8)+replicate('*',LEN(iban)-8)) as ibancifr,(datename(day,fecha) + ' de ' + lower(datename(month, fecha)) + ' de ' + datename(year,fecha)) as fechafacturalarga,
(((isnull(proforma.honocondctolin,0) - isnull(proforma.totsolodctofact,0)) + isnull(proforma.totportes,0))) as baseConPortes, pl.descripcion as descplazo,
(select sum(isnull(salidaeuro,0)) - sum(isnull(totaldctoeuro,0)) FROM lineprof
left join cuencli c on lineprof.inumexpexho=c.icodcli and lineprof.fechaconcep=c.dfecha and lineprof.lineacuentas=c.linea
where (tipo = 'HONORARIO') AND (ISNULL(honogasto,0) = 0) and (ISNULL(bhonoarticulo,0) = 0) and (ISNULL(bhonodcto,0) = 0)
and proforma.inumfactura = lineprof.inumfactura and proforma.yearfact=lineprof.yearfact and proforma.codsubusu=lineprof.codsubusu and proforma.tipoprof=lineprof.tipoprof) as totbaseimpsolohono,
(isnull(proforma.TotalEuro,0)) as totalletra, totalivaanticipos,totalivahonorarios,totalivaarticulos,
 totalivagastos, totaldctoanticipos, totaldctohonorarios, totaldctoarticulos, totaldctogastos, 
totalsalidaanticipos, totalsalidahonorarios, totalsalidaarticulos, totalsalidagastos, 
(totalsalidaanticipos - totaldctoanticipos + totalivaanticipos) as totmenosdctomasivaanticipos,
(totalsalidahonorarios - totaldctohonorarios + totalivahonorarios) as totmenosdctomasivahonorarios, 
(totalsalidaarticulos - totaldctoarticulos + totalivaarticulos) as totmenosdctomasivaarticulos, 
(totalsalidagastos - totaldctogastos + totalivagastos) as totmenosdctomasivagastos,
ISNULL(proforma.totacuenta, 0) as importecobrado,
ISNULL(proforma.TotalEuro, 0) - ISNULL(proforma.totacuenta, 0) as totalpendiente,
exp.inumexp, exp.expediente, exp.iyear,
(isnull(proforma.totalsuplidoseuro,0) + isnull(proforma.totalhonoeuro,0)) as totsupmashono,
(isnull(proforma.totalhonoeuro,0) - isnull(proforma.totalgastoeuro,0) - isnull(proforma.totanticipos,0)) as tothonomenosgastomenosanticipo
from proforma left join plazosc pl on proforma.idplazos = pl.id
left join expedien exp on proforma.inumexprelacionado = exp.inumexp and proforma.iyearrelacionado = exp.iyear

left join
(select
sum
(
case lineprof.tipo
when 'ANTICIPO' then
isnull(totalivaeuro,0)
else 0
end  )as totalivaanticipos,
sum
(
case lineprof.tipo
when 'HONORARIO' then
case ISNULL(c.honogasto,0)
when 0 then
case ISNULL(c.bhonoarticulo,0)
when 0 then
isnull(totalivaeuro,0)
else 0
end
else 0
end
else 0
end )as totalivahonorarios,

sum
(
case lineprof.tipo
when 'HONORARIO' then
case ISNULL(c.bhonoarticulo,0)
when 1 then
isnull(totalivaeuro,0)
else 0
end
else 0
end )as totalivaarticulos,
 sum  
    (   
     case lineprof.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totalivaeuro,0) 
     else 0  
      end  
     else 0  
     end )as totalivagastos, 
     sum  
     (  
     case lineprof.tipo 
     when 'ANTICIPO' then 
     isnull(totaldctoeuro,0) 
     else 0  
     end  )as totaldctoanticipos, 
     sum 
    ( case lineprof.tipo 
     when 'HONORARIO' then  
     case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0) 
        when 0 then  
        isnull(totaldctoeuro,0) 
      else 0 
       end 
     else 0  
      end  
     else 0 
     end )as totaldctohonorarios, 
     sum 
     (case lineprof.tipo 
     when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(totaldctoeuro,0) 
      else 0 
      end  
     else 0 
    end )as totaldctoarticulos, 
    sum 
    (case lineprof.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0) 
     when 1 then  
      isnull(totaldctoeuro,0) 
     else 0  
      end  
     else 0  
     end )as totaldctogastos, 
    sum  
        (case lineprof.tipo  
        when 'ANTICIPO' then  
        isnull(salidaeuro,0) 
        else 0 
        end  )as totalsalidaanticipos, 
       sum 
    ( case lineprof.tipo 
     when 'HONORARIO' then  
    case ISNULL(c.honogasto,0) 
     when 0 then   
       case ISNULL(c.bhonoarticulo,0)  
        when 0 then 
        isnull(salidaeuro,0) 
      else 0  
        end 
     else 0 
      end  
     else 0  
     end )as totalsalidahonorarios, 
     sum 
     (case lineprof.tipo 
    when 'HONORARIO' then 
      case ISNULL(c.bhonoarticulo,0) 
     when 1 then 
      isnull(salidaeuro,0) 
      else 0  
      end 
     else 0  
    end )as totalsalidaarticulos, 
    sum 
    (case lineprof.tipo 
     when 'HONORARIO' then 
     case ISNULL(c.honogasto,0)  
     when 1 then 
      isnull(salidaeuro,0)  
     else 0 
      end 
     else 0  
     end )as totalsalidagastos,       
lineprof.inumfactura as lineprofinumfactura, lineprof.yearfact as lineprofyearfact, lineprof.tipoprof as lineproftipoprof, lineprof.codsubusu as lineprofcodsubusu from lineprof
left join cuencli c on c.icodcli=lineprof.inumexpexho and c.dfecha =lineprof.fechaconcep and c.linea  = lineprof.lineacuentas
where (lineprof.tipo= 'HONORARIO' or lineprof.tipo= 'ANTICIPO')
group by lineprof.inumfactura, lineprof.yearfact, lineprof.tipoprof, lineprof.codsubusu)
as tbliva on tbliva.lineprofinumfactura=proforma.inumfactura and tbliva.lineprofyearfact=proforma.yearfact and tbliva.lineprofcodsubusu=proforma.codsubusu and tbliva.lineproftipoprof=proforma.tipoprof
where inumfactura = @inumfactura and yearfact = @yearfact and proforma.codsubusu = @codsubusu and tipoprof = @tipoprof ",sourcedatosfact
324,86,qrylineprof,"select (lineprof.descripcion + ' ' + isnull(cast(lineprof.notas as varchar(MAX)), ' ')) as descripnotas,(isnull(entradaeuro,0)+isnull(salidaeuro,0)) as importe,(isnull(salidaeuro,0)-isnull(totaldctoeuro,0)) as salidamenosdcto, lineprof.unidades,lineprof.descripcion, s.nombre as usuario,
(round((isnull(lineprof.salidaeuro,0) - round(isnull(lineprof.salidaeuro,0)*(isnull(lineprof.dctolinea,0)/100),2)),0)) -
round((round((isnull(lineprof.salidaeuro,0) - round(isnull(lineprof.salidaeuro,0)*(isnull(lineprof.dctolinea,0)/100),2)),0))*(isnull(lineprof.dctolinea2,0)/100),2) as honocondcto1dcto2,
art.referencia as referenciaart,lineprof.origen,c.idartstock,
(case lineprof.tipoproformarel
when 0 then 'Oficial'
when 1 then 'Pro forma'
when 2 then 'Presupuesto'
when 3 then 'Albarán'
when 4 then 'Pedido'
when 5 then 'Orden'
else ''
end) as TipoDoc,
((((isnull(lineprof.salidaeuro,0))-(isnull(lineprof.totaldctoeuro,0)))*lineprof.porrecargo)/100) as cuotarec,
((((isnull(lineprof.salidaeuro,0))-(isnull(lineprof.totaldctoeuro,0)))*lineprof.poriva)/100) as cuotaivasinrec,
art.campo1,art.campo2,art.campo3,art.campo4,art.campo5,art.campo6,art.campo7,art.campo8,
art.campofecha1,art.campofecha2,art.campofecha3,art.campofecha4,art.notas as notasArt,
case when lineprof.unidades=0 then lineprof.fpreciounitario
else cast(round(isnull(lineprof.fpreciounitario,0)-(isnull(lineprof.totaldctoeuro,0)/isnull(lineprof.unidades,1)),2) as money) end as preciounimenosdcto, c.referencia as referenciacuencli   ,case (isnull(cliseg.snombrecli, '')) when '' then clisegclider.snombrecli else cliseg.snombrecli end as pacientenombre from lineprof
left join cuencli c on lineprof.inumexpexho=c.icodcli and lineprof.fechaconcep=c.dfecha and lineprof.lineacuentas=c.linea
left join subusu s on c.subusu=s.icodsubusu
left join articulos art on c.idartstock=art.id left join segcli_cuencli segcuen on lineprof.Origen = 'cli' and segcuen.icodcli_cuencli=lineprof.inumexpexho and segcuen.linea_cuencli=lineprof.lineacuentas and segcuen.dfecha_cuencli=lineprof.fechaconcep
left join clientes cliseg on cliseg.icodcli=segcuen.icodcli_segcli
left join cuenclisegclider on lineprof.origen = 'cli' and cuenclisegclider.icodclicuencli=lineprof.inumexpexho and cuenclisegclider.dfechacuencli=lineprof.fechaconcep and cuenclisegclider.lineacuencli=lineprof.lineacuentas
left join segclider on segclider.id=cuenclisegclider.idsegclider and segclider.icodcli<>lineprof.inumexpexho
left join clientes clisegclider on clisegclider.icodcli=segclider.icodcli  where lineprof.inumfactura = @inumfactura and lineprof.yearfact = @yearfact and lineprof.codsubusu = @codsubusu and lineprof.tipoprof = @tipoprof order by lineprof.numero",sourcedatosfact
